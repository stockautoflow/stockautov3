はい、承知いたしました。
合意した基本仕様書(v5)に基づき、実装のための詳細設計書をMarkdown形式で作成します。

-----

# リアルタイム通知機能 詳細設計書

| ドキュメントバージョン | v1.0 |
| :--- | :--- |
| 作成日 | 2025-10-18 |
| 作成者 | Gemini |
| 承認者 | (ユーザー) |
| 関連仕様書 | リアルタイム通知機能 改修仕様書 (v5) |

## 1\. 変更履歴

| バージョン | 日付 | 変更内容 |
| :--- | :--- | :--- |
| v1.0 | 2025-10-18 | ・基本仕様書(v5)に基づく初期ドラフト作成。 |

## 2\. 概要

`BarBuilder`（5分足バー生成） の導入に伴い、`RealTradeStrategyNotifier` に実装されていた旧来の時間差判定ロジック（5分ルール） が、正常なリアルタイム通知を誤って抑制する問題が発生した。

本設計書は、この問題を解決するため、`RealTradeStrategyNotifier` の改修内容を詳細に定義する。

## 3\. 改修目的

1.  **履歴再生中の抑制:** システム起動時の履歴データ再生中は、`realtime_phase_started` フラグ に基づき、通知を**正確に抑制**する。
2.  **リアルタイム通知の許可:** 5分足バーの仕様 によって発生する**正常な5分遅延**では、通知を**許可**する。
3.  **異常遅延の警告:** リアルタイムフェーズ中（`realtime_phase_started = True`）に発生した**異常な遅延**（例: PCスリープ、15分以上の遅延）を検知した場合、通知を**抑制せず**、遅延の事実を明記した**警告**を件名・本文に追記して通知する。

## 4\. 影響範囲（修正対象コンポーネント）

| 種別 | パス / 名称 |
| :--- | :--- |
| **ファイル** | `src/realtrade/implementations/strategy_notifier.py` |
| **クラス** | `RealTradeStrategyNotifier` |
| **メソッド** | `send(self, subject, body, immediate=False)` |
| **追加 import** | `from datetime import datetime, timedelta` |

-----

## 5\. 詳細設計：`RealTradeStrategyNotifier.send` メソッド

### 5.1. 必要な `import` の追加

`src/realtrade/implementations/strategy_notifier.py` のファイル先頭に、`datetime` ライブラリを追加する。

```python
# src/realtrade/implementations/strategy_notifier.py

import logging
from datetime import datetime, timedelta  # <-- [追加]
from src.core.util import notifier
from src.core.strategy.strategy_notifier import BaseStrategyNotifier
```

### 5.2. `send` メソッドのロジック詳細

`send` メソッドの既存のロジックを、以下の処理フローで完全に置き換える。

```python
# src/realtrade/implementations/strategy_notifier.py

    def send(self, subject, body, immediate=False):
        
        # 5.1. 履歴データ再生中の判定 (第一チェック)
        # RealTradeStrategy が持つフラグを参照
        if not getattr(self.strategy, 'realtime_phase_started', False):
            self.logger.debug(f"履歴データ供給中のため通知を抑制: {subject}")
            return
        
        # 5.2. 時間差判定（第二チェック）の準備
        try:
            bar_datetime = self.strategy.data0.datetime.datetime(0)
        except IndexError:
            # バーがまだ存在しない（start()時など）場合は、比較せずそのまま送信試行
            self.logger.warning(f"バーデータが存在しないため、時間差チェックをスキップ: {subject}")
            notifier.send_email(subject, body, immediate=immediate)
            return

        if bar_datetime.tzinfo is not None:
            bar_datetime = bar_datetime.replace(tzinfo=None)

        current_time = datetime.now()
        allowed_delay = timedelta(minutes=15) # 異常遅延とみなす閾値
        time_diff = current_time - bar_datetime
        is_delayed = time_diff > allowed_delay

        # 5.3. 警告の追記処理
        if is_delayed:
            delay_minutes = int(time_diff.total_seconds() / 60)
            
            # 決済通知 (件名に "決済" や "Stop Loss" を含む) かどうかで警告レベルを変更
            if "決済" in subject or "Stop Loss" in subject:
                subject = f"【!!!決済遅延警告: {delay_minutes}分前!!!】{subject}"
            else:
                subject = f"【エントリー遅延警告: {delay_minutes}分前】{subject}"
            
            warning_msg = (
                f"警告: このシグナルは {delay_minutes}分前 ({bar_datetime.isoformat()}) のデータに基づいています。\n"
                f"現在の価格と乖離している可能性があります。\n"
                f"------------------------------------\n\n"
            )
            body = warning_msg + body
        
        # 5.4. 通知の実行
        self.logger.debug(f"通知リクエストを発行: {subject}")
        notifier.send_email(subject, body, immediate=immediate)

```

-----

## 6\. テストケース（確認項目）

| No. | シナリオ | テスト条件 | 期待される結果 |
| :--- | :--- | :--- | :--- |
| 1 | **履歴再生中** | `realtime_phase_started = False` | `notifier.send_email` が呼び出されず、メソッドが `return` すること。 |
| 2 | **正常なリアルタイム<br>(エントリー)** | `realtime_phase_started = True`<br>`time_diff = 6分` (\<= 15分)<br>`subject = "【RT】新規注文発注..."` | `notifier.send_email` が呼び出されること。<br>件名・本文が**変更されていない**こと。 |
| 3 | **異常遅延<br>(エントリー)** | `realtime_phase_started = True`<br>`time_diff = 20分` (\> 15分)<br>`subject = "【RT】新規注文発注..."` | `notifier.send_email` が呼び出されること。<br>件名が `【エントリー遅延警告: 20分前】...` となっていること。<br>本文の先頭に警告文が挿入されていること。 |
| 4 | **異常遅延<br>(決済)** | `realtime_phase_started = True`<br>`time_diff = 20分` (\> 15分)<br>`subject = "【RT】決済完了 - Stop Loss..."` | `notifier.send_email` が呼び出されること。<br>件名が `【!!!決済遅延警告: 20分前!!!】...` となっていること。<br>本文の先頭に警告文が挿入されていること。 |