はい、承知いたしました。
詳細設計書(v1.0)に基づき、実装計画書をMD形式で作成します。

-----

# リアルタイム通知機能 改修実装計画書

| ドキュメントバージョン | v1.0 |
| :--- | :--- |
| 作成日 | 2025-10-18 |
| 作成者 | Gemini |
| 関連仕様書 | リアルタイム通知機能 詳細設計書 (v1.0) |

## 1\. プロジェクト概要

### 1.1. 目的

`BarBuilder`（5分足バー生成） の導入に伴う、リアルタイム通知の意図しない抑制問題を解決する。
具体的には、履歴データ再生中は通知を抑制し、リアルタイム処理中の異常遅延は「警告を明記」して通知するよう、`RealTradeStrategyNotifier` を改修する。

### 1.2. スコープ（作業範囲）

本計画のスコープは、以下のファイルの修正に限定される。

  * **修正対象:** `src/realtrade/implementations/strategy_notifier.py`
      * `import` 文の追加（`datetime`, `timedelta`）
      * `RealTradeStrategyNotifier` クラスの `send` メソッドのロジック全面差し替え。

## 2\. 実装マイルストーンとスケジュール

本改修はクリティカルな不具合修正であるため、迅速に実施する。

| 日程 (想定) | 担当 | タスク | 成果物 / 確認方法 |
| :--- | :--- | :--- | :--- |
| **Day 1 (10/20 月)** | 実装担当者 | **1. 実装 (コーディング)** | `strategy_notifier.py` の `send` メソッドが詳細設計書(v1.0)通りに修正されていること。 |
| | 実装担当者 | **2. 単体テスト** | ユニットテストコード（またはテスト用スクリプト）によるロジック分岐（5.1, 5.2, 5.3）の確認。 |
| **Day 2 (10/21 火)** | 実装担当者 | **3. 結合テスト (環境準備)** | 修正版コードをリアルタイムトレード環境（またはステージング環境）にデプロイする。 |
| | 実装担当者 | **4. 結合テスト (実機検証)** | 「6.2. 結合テスト計画」に基づき、実際の動作（履歴再生・リアルタイム・スリープ復帰）を確認する。 |
| **Day 3 (10/22 水)** | 実装担当者 | **5. リリース / ロールバック待機** | 結合テストで問題がなければ本番コードとしてリリース。<br>問題発生に備え、即時ロールバック（Git revert）可能な状態を維持する。 |

## 3\. 担当者

| 役割 | 担当者 |
| :--- | :--- |
| プロジェクトオーナー | (ユーザー) |
| 実装・テスト担当者 | (実装担当者 / Gemini支援) |

## 4\. リスクと対策

| 想定されるリスク | 影響度 | 対策 |
| :--- | :--- | :--- |
| `realtime_phase_started` フラグ の参照に失敗する（`AttributeError`） | 高 | `getattr(self.strategy, 'realtime_phase_started', False)` を使用し、万が一属性が存在しなくても `False` を返すことで安全にフォールバックする。 |
| 決済通知の件名キーワード ("決済", "Stop Loss") が変更された場合、遅延警告が正しく機能しない | 低 | `event_handler.py` の件名定義と一致していることをコードレビューで確認する。 |
| 異常遅延の閾値（15分）が短すぎる/長すぎる | 低 | 15分（5分足 + 10分ラグ）は安全マージンとして妥当と判断。リリース後の運用で監視し、必要に応じて再調整する。 |

## 5\. テスト計画

### 5.1. 単体テスト

**目的:** `send` メソッドが、詳細設計書(v1.0)の「5. 詳細設計」に記載されたロジック通りに分岐することを、モック（模擬データ）を用いて確認する。

| テストケース (No.) | 条件 (モック) | 期待される結果 (ログまたは戻り値) |
| :--- | :--- | :--- |
| 1 (履歴再生中) | `strategy.realtime_phase_started = False` | `logger.debug("履歴データ供給中のため通知を抑制...")` がログ出力され、`notifier.send_email` が呼び出されないこと。 |
| 2 (正常リアルタイム) | `strategy.realtime_phase_started = True`<br>`time_diff = 6分` (\<= 15分) | `notifier.send_email` が呼び出される。<br>件名・本文が**変更されていない**こと。 |
| 3 (異常遅延: エントリー) | `strategy.realtime_started = True`<br>`time_diff = 20分` (\> 15分)<br>`subject = "【RT】新規注文発注..."` | `notifier.send_email` が呼び出される。<br>件名が `【エントリー遅延警告: 20分前】...` となっていること。 |
| 4 (異常遅延: 決済) | `strategy.realtime_started = True`<br>`time_diff = 20分` (\> 15分)<br>`subject = "【RT】決済完了 - Stop Loss..."` | `notifier.send_email` が呼び出される。<br>件名が `【!!!決済遅延警告: 20分前!!!】...` となっていること。 |

### 5.2. 結合テスト

**目的:** 修正版コードをデプロイした環境で、実際のデータフロー（起動〜リアルタイム〜異常事態）において、通知が期待通りに動作することを確認する。

| テストシナリオ | 実施手順 | 期待される結果 |
| :--- | :--- | :--- |
| **履歴再生中の抑制** | 1. `src/realtrade/run_realtrade.py` を起動する。<br>2. 履歴データ再生中（起動後約1〜2分）のログを監視する。 | ログに `履歴データ供給中のため通知を抑制...` が出力される。<br>`notification_history.db` が `PENDING` のまま（メール送信が実行されない）。 |
| **正常なリアルタイム通知** | 1. ストラテジーがリアルタイムフェーズに移行するのを待つ（ログで `リアルタイムフェーズに移行しました` を確認）。<br>2. シグナルが発生し、通知が送信されるのを待つ。 | 5分足の正常な遅延（5〜6分）では警告が**付与されず**、通常の件名でメールが送信される（`notification_history.db` が `SUCCESS` になる）。 |
| **異常遅延の警告** | 1. リアルタイムフェーズ移行後、PCを**20分間スリープ**させる。<br>2. スリープから復帰させ、`BarBuilder` が遅延したバーを処理するのを待つ。<br>3. この遅延したバーでシグナルが発生した場合の通知を確認する。 | 件名に `【...遅延警告: ...分前】` が**付与された**メールが送信される（`notification_history.db` の `subject` カラムを確認）。 |

## 6\. ロールバック（切り戻し）計画

  * 実装（Day 1）の前に、現在の動作する `src/realtrade/implementations/strategy_notifier.py` をGitでコミット、またはバックアップ（`strategy_notifier.py.bak`）する。
  * 結合テスト（Day 2）で重大な問題（例: 通知が一切送信されない、遅延計算が無限ループする等）が発見され、即時解決が困難な場合、バックアップしたファイルに差し戻すことで、元の（通知はされないが動作はする）状態に切り戻す。