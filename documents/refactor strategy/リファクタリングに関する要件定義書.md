リファクタリングに関する要件定義書ご提示いただいたファイル群とご要望に基づき、株の自動取引システムのリファクタリングに関する要件定義書を作成します。

---

### 1. プロジェクト概要

本プロジェクトは、株の自動取引システムの中核部分である戦略ロジックをリファクタリングし、**バックテスト**、**リアルタイムトレード**、そして**共通コア**の3つの独立したコンポーネントに分割することを目的とします。これにより、コードの再利用性を高め、保守性・拡張性の向上を図ります。

---

### 2. リファクタリングの目的と範囲

* **目的**:
    * `strategy.py`に集中している責務を分離し、コードの重複を排除する。
    * バックテストとリアルタイムトレードの環境に依存しない共通ロジックを確立する。
    * Backtraderと外部API・DBとの連携部分をモジュール化し、システムの拡張性を高める。
* **範囲**:
    * `src/core/` パッケージの新規作成と、戦略・インジケーター・ユーティリティ機能の集約。
    * `src/backtest/` パッケージの新規作成と、バックテスト専用機能の実装。
    * `src/realtrade/` パッケージの新規作成と、リアルタイムトレード専用機能の実装。
    * 各コンポーネントの連携を定義し、システム全体の機能を維持・向上させる。

---

### 3. 各コンポーネントの機能要件

#### 3.1. 共通コア (`src/core/`)

システムの心臓部であり、すべての環境から利用される共通機能を担います。

* **戦略モジュール (`strategy.py`)**
    * 動的な戦略設定ファイル (`strategy_base.yml`) と戦略カタログ (`strategy_catalog.yml`) をロードする機能。
    * 複数の時間足データ（`long`, `medium`, `short`）を扱えること。
    * 定義されたエントリー/エグジット条件を評価するロジックを実装すること。
    * `live_trading`フラグに応じて、バックテストとリアルタイムの挙動（ログ出力、通知など）を切り替えること。
    * 新規エントリー、決済、注文失敗のシグナル発生時に、メール通知機能を呼び出すこと。

* **インジケーターモジュール (`indicators.py`)**
    * Backtraderに標準で存在しないインジケーター (`VWAP`, `SafeADX`, `SafeStochastic`) を定義すること。
    * 既存の標準インジケーター（RSIなど）を安全に利用するためのラッパークラスを必要に応じて提供すること。

* **データ準備モジュール (`data_preparer.py`)**
    * バックテスト時にはローカルCSVファイルから、リアルタイムトレード時には専用アダプターからデータをロードする機能を持つこと。
    * 戦略設定に基づいて、複数の時間足データフィードを`resample`または`direct`で`cerebro`インスタンスに追加する機能を提供すること。

* **ユーティリティモジュール (`util/`)**
    * **ロギング (`logger.py`)**: タイムスタンプとログレベルを含む、プロジェクト全体のロギング機能を提供すること。
    * **通知 (`notifier.py`)**:
        * Gmailのレート制限を回避するため、メール送信をキューイング方式で行うこと。
        * 緊急度の高い通知（例: 約定）は即時（`immediate=True`）に、その他の通知はバックグラウンドスレッドで送信されること。
        * 通知履歴をSQLiteデータベースに記録し、成功・失敗ステータスを追跡できること。

---

#### 3.2. バックテストコンポーネント (`src/backtest/`)

戦略のパフォーマンス評価に特化した機能を提供します。

* **実行モジュール (`run_backtest.py`)**
    * 指定されたディレクトリ内の全銘柄データに対して、戦略を自動実行する機能を持つこと。
    * バックテスト結果（純利益、総利益、総損失、勝率など）をCSV形式で保存すること。
    * 取引履歴の詳細を`trade_history_*.csv`として出力すること。
    * `notifier.start_notifier()`と`notifier.stop_notifier()`を呼び出すことで、メール通知キューを管理すること。

* **レポートモジュール (`report.py`)**
    * バックテスト結果を集計し、戦略のパフォーマンスをまとめたサマリーレポートを生成すること。
    * 戦略のエントリー/エグジット条件をレポートに含め、人間が読みやすい形式に整形すること。

---

#### 3.3. リアルタイムトレードコンポーネント (`src/realtrade/`)

ライブ取引の実行と状態管理を担います。

* **実行モジュール (`run_realtrade.py`)**
    * 各銘柄を独立した`cerebro`インスタンスとスレッドで実行し、複数の銘柄を同時に取引できること。
    * **既存ポジションの復元**: 起動時にSQLite DBから永続化されたポジションをロードし、取引を再開できること。
    * **ブローカー連携**: 楽天証券との連携のために、カスタムの`RakutenBroker`と`RakutenData`クラスを統合すること。
    * **手数料・スリッページ**: `NoCreditInterest`カスタムクラスを適用し、不必要な金利計算を無効にすること。

* **状態管理モジュール (`state_manager.py`)**
    * SQLiteデータベースにポジション情報を保存・ロード・削除する機能を提供すること。
    * 複数スレッドからのアクセスを考慮し、スレッドセーフな実装とすること。

* **アナライザーモジュール (`analyzer.py`)**
    * Backtraderの`TradePersistenceAnalyzer`クラスを実装し、ポジションの変更や決済時に`state_manager`を呼び出してDBを更新すること。

* **データ連携モジュール (`live/`, `rakuten/`)**
    * **楽天証券 (`rakuten/`)**:
        * ExcelファイルとPythonプロセスを接続する`ExcelBridge`クラスを実装すること。
        * Excelからリアルタイムデータをポーリングする機能を持つこと。
        * `RakutenData`クラスは、過去データとExcelからのリアルタイムデータをシームレスに供給できること。
    * **Yahoo Finance (`live/`)**:
        * Yahoo Finance APIからリアルタイムデータを取得する`YahooData`クラスを実装すること。

---

### 4. 開発プロセスと成果物

* **開発**: 上記の要件定義に基づき、各モジュールを実装します。
* **テスト**:
    * 各機能が意図通りに動作することを確認するため、単体テストを実施します。
    * バックテスト機能については、既存の`run_backtest.py`と`report.py`の統合テストを実施します。
* **成果物**:
    * リファクタリング後の完全なソースコード（上記ディレクトリ構造に準拠）.
    * 本要件定義書。
    * リファクタリング作業中に発生した課題とその解決策をまとめたドキュメント（任意）。

以上で、リファクタリングの要件定義は完了です。