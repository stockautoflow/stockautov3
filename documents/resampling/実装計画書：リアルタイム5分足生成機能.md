はい、承知いたしました。
これまでの仕様と設計に基づき、リアルタイム5分足生成機能の「実装計画書」をMarkdown形式で作成します。

---

# 実装計画書：リアルタイム5分足生成機能

| ドキュメントバージョン | 1.0 |
| :--- | :--- |
| **作成日** | 2025/10/08 |
| **作成者** | Gemini |
| **概要** | 詳細設計書に基づき、リアルタイム5分足生成機能の実装タスク、テスト計画、およびスケジュールを定義する。 |

---

## 1. 目的

本計画の目的は、リアルタイムTickデータから正確な5分足（OHLCV）を生成する機能をシステムに実装することである。これにより、リアルタイム分析の精度を向上させ、バックテストとの一貫性を確保する。

---

## 2. スコープ

本計画は、以下のファイルの新規作成および修正を対象とする。

* **新規作成**:
    * `src/realtrade/bar_builder.py`
* **修正対象**:
    * `src/realtrade/rakuten/rakuten_data.py`
    * `src/realtrade/run_realtime.py`

---

## 3. 🗓️ 実装タスク一覧

実装は以下のタスクに分割し、順次進める。

### タスク1: `BarBuilder` クラスの実装

* **担当ファイル**: `src/realtrade/bar_builder.py` (新規作成)
* **作業内容**:
    * [ ] `__init__` メソッドを実装し、時間間隔 (`_interval`)、現在のバー (`_current_bar`)、最終累計出来高 (`_last_cumulative_volume`) を初期化する。
    * [ ] `add_tick` メソッドを実装する。
        * [ ] Tickのタイムスタンプから、属するべき5分間の開始時刻を計算するロジックを実装する。
        * [ ] `_current_bar` が存在しない場合に、新しいバーを生成するロジックを実装する。
        * [ ] 既存のバーを更新するロジック（高値・安値・終値の更新）を実装する。
        * [ ] 累計出来高の差分を計算し、期間内出来高として加算するロジックを実装する。
        * [ ] 時間枠が切り替わった際に、完成したバーを返し、内部状態をリセットするロジックを実装する。
    * [ ] `flush` メソッドを実装し、形成途中のバーを強制的に返す機能を追加する。

### タスク2: `RakutenData` クラスの改修

* **担当ファイル**: `src/realtrade/rakuten/rakuten_data.py` (修正)
* **作業内容**:
    * [ ] `BarBuilder` クラスをインポートする。
    * [ ] `__init__` メソッドで `BarBuilder` をインスタンス化し、`self.builder` として保持する。
    * [ ] `_load` メソッドのロジックを全面的に書き換える。
        * [ ] **取引時間フィルタ**を実装し、9:00-11:30および12:30-15:30以外のTickデータを無視するようにする。
        * [ ] 取得したTickデータを `self.builder.add_tick()` に渡す。
        * [ ] `add_tick` から完成したバーが返された場合のみ、`_populate_lines` を呼び出してBacktraderに供給する。
    * [ ] `stop` メソッドを修正し、`super().stop()` の前に `self.flush()` を呼び出す処理を追加する。
    * [ ] `flush` メソッドを新規に実装し、`self.builder.flush()` の結果をBacktraderに供給するロジックを記述する。

### タスク3: `RealtimeTrader` クラスの改修

* **担当ファイル**: `src/realtrade/run_realtime.py` (修正)
* **作業内容**:
    * [ ] `stop` メソッドを修正し、データフィードを停止する前に `cerebro.datas[0].flush()` を呼び出す処理を追加する。

### タスク4: テストと動作確認

* **作業内容**:
    * [ ] `BarBuilder` クラスの単体テストを実装する。（推奨）
    * [ ] 実際にシステムを稼働させ、シミュレートされたTickデータに対して5分足が意図通りに生成・ログ出力されるかを確認する（結合テスト）。
    * [ ] 取引終了時に最終バーが正しくフラッシュされるかを確認する。

---

## 4. ✅ テスト計画

### 4.1. 単体テスト (`BarBuilder` クラス)

以下のシナリオをテストし、クラスのロジックが正しいことを確認する。

* **シナリオ1**: 最初のTickを受け取った際、正しく新しいバーが開始されること。
* **シナリオ2**: 同じ時間枠内で複数のTickを受け取った際、`open`は変わらず、`high`, `low`, `close`, `volume` が正しく更新されること。
* **シナリオ3**: 新しい時間枠のTickを受け取った際、直前のバーが完成して返され、新しいバーの形成が開始されること。
* **シナリオ4**: 出来高が、累計値ではなく差分で正しく計算されていること。
* **シナリオ5**: `flush` メソッドが、形成途中のバーを正しく返すこと。

### 4.2. 結合テスト

システム全体を連携させて、以下の項目を検証する。

* `ExcelConnector` -> `RakutenData` -> `BarBuilder` のデータフローが正常に動作すること。
* Backtraderのログや`cerebro.run()`の結果から、5分間隔でバーが生成されていることを確認する。
* 取引時間外のTickがフィルタリングされ、不要なバーが生成されないことを確認する。
* プログラム終了時に、ログ等で最後のバーがフラッシュ処理されていることを確認する。

---

## 5. 開発スケジュール（目安）

| フェーズ | タスク | 想定工数（人日） |
| :--- | :--- | :--- |
| **フェーズ1** | タスク1: `BarBuilder` クラスの実装と単体テスト | 1.0 |
| **フェーズ2** | タスク2: `RakutenData` クラスの改修 | 0.75 |
| **フェーズ3** | タスク3: `RealtimeTrader` クラスの改修 | 0.25 |
| **フェーズ4** | タスク4: 結合テストとデバッグ | 0.5 |
| **合計** | | **2.5** |

---

## 6. 成果物

* `src/realtrade/bar_builder.py`
* `src/realtrade/rakuten/rakuten_data.py` (更新版)
* `src/realtrade/run_realtime.py` (更新版)