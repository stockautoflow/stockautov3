# **株自動トレードシステム 基本仕様書 (v20)**

## **1\. 概要**

### **1.1. システムの目的**

本システムは、高機能なバックテストフレームワーク **Backtrader** を利用し、取引戦略の有効性を効率的かつ詳細に検証することを目的とする。マルチタイムフレーム分析に基づいた戦略を、手数料などの現実的なコストを考慮して評価し、信頼性の高い結果を得ることを目指す。

### **1.2. 主な目標**

* **柔軟な戦略検証**: Backtraderの強力なエンジンを活用し、**ロング（買い）およびショート（売り）戦略**のバックテストを自動で実行する。戦略の有効/無効は設定ファイルから容易に切り替え可能とする。  
* **現実的なシミュレーション**: 取引手数料やスリッページを考慮に入れることで、より実践に近い損益を算出する。  
* **高度なリスク管理**: \*\*ATR（Average True Range）\*\*に基づき、1トレードあたりのリスクが資金の一定割合になるようポジションサイズを自動で調整する。  
* **詳細な結果分析**:  
  * **レポート出力**: パフォーマンス指標をまとめたサマリーレポートと、全取引の詳細を記録した履歴レポートを生成する。  
  * **マルチタイムフレームチャート出力**: バックテスト完了後、別のスクリプトを実行することで、分析対象の全銘柄について**長期・中期・短期の3種類のチャート**を個別に生成する。これにより、各時間足での相場環境とエントリー判断の妥当性を視覚的に詳細にレビューできる。  
* **設定の外部化**: 戦略パラメータ（ロング/ショートの有効化、インジケーター設定等）やメール設定を外部ファイルで管理し、保守性とセキュリティを向上させる。

## **2\. システム要件**

### **2.1. 機能要件**

| 機能分類 | 機能概要 |
| :---- | :---- |
| **データ処理** | dataディレクトリに配置されたCSV形式の株価ファイル（5分足）を自動で読み込む。 読み込んだ5分足データから、戦略に必要な他の時間足（1時間足、日足）を自動で生成（リサンプリング）する。 |
| **戦略実行** | strategy.yml で定義されたパラメータに基づき、マルチタイムフレーム分析による\*\*ロング（買い）およびショート（売り）\*\*の売買シグナル判定を行う。trading\_mode設定により、ロングのみ、ショートのみ、または両方の戦略を有効にできる。 |
| **ポジションサイジング** | ATRベースのリスク管理モデルを採用。 1\. 1トレードあたりの許容損失額を計算（総資金 × リスク割合）。 2\. 1株あたりのリスク額を計算（ATR × ストップロス倍率）。 3\. 「許容損失額 ÷ 1株あたりリスク」で、適切なロット数を動的に算出する。 |
| **バックテスト** | dataディレクトリ内の全銘柄に対し、初期資金、手数料、スリッページを設定した上でバックテストを逐次実行する。 |
| **結果出力** | run\_backtrader.py実行時、backtest\_results/report ディレクトリに3種類のタイムスタンプ付きCSVレポート（サマリー、銘柄別詳細、統合取引履歴）を生成する。取引履歴には、損切り・利確価格やエントリー根拠などの詳細情報が含まれる。 |
| **チャート生成** | chart\_generator.py実行時、最新の取引履歴レポートを読み込み、backtest\_results/chartディレクトリに各銘柄のチャート画像を保存する。生成されるチャートは以下の3種類。 ・短期チャート: ローソク足、短期EMA、売買ポイント、損切り・利確ライン ・中期チャート: ローソク足、RSI ・長期チャート: ローソク足、長期EMA |
| **通知・ログ機能** | システムの動作状況やエラーを時系列でログファイルに出力する。 ログは log ディレクトリに、実行ごとにユニークなタイムスタンプ付きのファイルとして保存される。 |

### **2.2. 非機能要件**

| 要件項目 | 内容 |
| :---- | :---- |
| **操作性** | 利用者はPythonスクリプトを実行するだけで、バックテストやチャート生成を開始できる。 |
| **拡張性** | 取引戦略のパラメータ（移動平均線の期間、ロング/ショートの有効化など）は、strategy.ymlファイルを編集するだけで容易に変更可能とする。 |
| **保守性** | システム設定、戦略パラメータ、戦略ロジック、ロギング設定をそれぞれ別のファイルに分離し、可読性とメンテナンス性を高める。 |
| **信頼性** | 業界で広く利用されているBacktraderを基盤とすることで、バックテスト計算の信頼性を確保する。 |

## **3\. システム構成**

### **3.1. アーキテクチャ図（概念）**

\[CSVデータファイル群\]  
       |  
       \+-----\> \[run\_backtrader.py\] \-----\> \[レポート群.csv\]  
       |             |  
       |             \+------------------\> \[log/backtest\_日付.log\]  
       |  
       \+-----\> \[chart\_generator.py\] \----\> \[短期チャート.png\]  
                     |                  , \[中期チャート.png\]  
                     |                  \` \[長期チャート.png\]  
                     |  
                     \+---\<--- \[レポート(取引履歴).csv\]

### **3.2. 技術スタック**

| 領域 | 主要技術 | 役割 |
| :---- | :---- | :---- |
| **プログラミング言語** | Python | システム全体の開発言語。 |
| **バックテストエンジン** | Backtrader | バックテストの実行、データ管理、指標計算、結果分析のコア機能。 |
| **データ操作** | Pandas | CSVデータの読み込みと加工、レポート生成。 |
| **チャート描画** | Matplotlib, mplfinance | chart\_generator.pyで使用し、バックグラウンドで高品質なPNGチャート画像を生成する。 |
| **設定ファイル** | YAML | strategy.yml と email\_config.yml で各種設定を管理する。 |
| **ロギング** | logging | Python標準のロギングライブラリ。 |

## **4\. 運用フロー**

1. **データ準備**: dataディレクトリに分析したい銘柄の5分足CSVデータを配置する。  
2. **戦略調整**: strategy.ymlファイルを開き、必要に応じてインジケーターの期間や、trading\_modeでロング/ショート戦略の有効/無効を調整する。  
3. **バックテスト実行**: コマンドプロンプトで python run\_backtrader.py を実行する。  
4. **チャート生成**: コマンドプロンプトで python chart\_generator.py を実行する。  
5. **結果確認**: backtest\_results/report内のCSVレポートと、backtest\_results/chart内の3種類のチャート画像でパフォーマンスを詳細に確認する。  
6. **問題発生時の調査**: logディレクトリに生成されたログファイルを確認し、エラーの原因やシステムの動作を追跡する。  
7. **分析と改善**: 結果を基に、再度 strategy.yml を調整し、最適なパラメータを探る。（上記2～6を繰り返す）

## **5\. リスクと対策**

| リスク | 対策 |
| :---- | :---- |
| **戦略ロジックのバグ** | trade\_historyレポートで、意図した通りの「エントリー根拠」「決済根拠」で取引が行われているかを確認する。ログファイルで取引前後の資金変動やインジケーターの値を追う。 |
| **過学習（カーブフィッティング）** | 同じデータセットでパラメータ調整を繰り返すと、そのデータにのみ過度に最適化されてしまう。定期的に新しい期間のデータでテストを行い、戦略の堅牢性を確認する。 |
| **CSVデータのフォーマットエラー** | システムが想定するカラム名（datetime, open, high, low, close, volume）と日付形式 (YYYY-MM-DD HH:MM:SS) にデータが従っていることを確認する。 |

## **6\. 免責事項**

本システムは、特定の投資成果を保証するものではない。本システムを利用した結果生じたいかなる金融上の損失についても、開発者は一切の責任を負わないものとする。投資に関する最終的な決定は、利用者自身の判断と責任において行うこと。