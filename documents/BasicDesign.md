# **株自動トレードシステム 基本仕様書 (v73.7)**

## **1\. 概要**

### **1.1. システムの目的**

本システムは、高機能なバックテストフレームワーク **Backtrader** と、インタラクティブなグラフ描画ライブラリ **Plotly** を利用し、取引戦略の有効性を効率的かつ詳細に検証することを目的とする。マルチタイムフレーム分析に基づいた戦略を、コストやリスクを考慮して評価し、その結果を**Webブラウザ上で対話的に分析**することで、戦略改善のサイクルを高速化する。

### **1.2. 主な目標**

* **完全な戦略定義の外部化**: Pythonコードを編集することなく、設定ファイル（strategy.yml）の記述を変更するだけで、**エントリー、イグジット（損切り/利確）、ポジションサイズ計算**の全てを組み合わせ、柔軟に定義・検証できる。  
* **現実的なシミュレーション**: 取引手数料やスリッページを考慮し、より実践に近い損益を算出する。バックテスト期間終了時に未決済のポジションも、最終終値で評価・計上される。  
* **高度な決済注文**: BacktraderのネイティブOCO（One-Cancels-Other）注文とトレーリングストップ（StopTrail）機能を活用し、信頼性の高い決済ロジックを実現する。  
* **高度な分析UI**:  
  * **Webアプリケーション**: FlaskをWebサーバーとし、ブラウザから http://127.0.0.1:5001 にアクセスすることで分析ツールを起動する。  
  * **動的チャート**: Webページ上で銘柄や時間足を選択すると、チャートが動的に切り替わる。  
  * **パラメータ調整**: 以下のテクニカル指標のパラメータをWebフォームからリアルタイムに変更し、チャートに即時反映させることができる。  
    * 単純移動平均線 (SMA)  
    * 指数平滑移動平均線 (EMA)  
    * ボリンジャーバンド  
    * MACD  
    * RSI  
    * ストキャスティクス  
    * ADX / DMI  
    * ATR  
    * 一目均衡表  
    * VWAP (出来高加重平均価格)  
  * **チャートと取引履歴の連動**: 取引履歴テーブルの行をクリックすると、チャート上の該当期間がハイライトされ、視覚的な分析を支援する。  
* **設定の外部化**: 戦略ロジック、UIのデフォルトパラメータ、メール設定をYAMLファイルで管理し、保守性を確保する。

## **2\. システム要件**

### **2.1. 機能要件**

|

| 機能分類 | 機能概要 |  
| データ処理 | dataディレクトリに配置されたCSV形式の株価ファイル（5分足）を起動時に読み込む。 |  
| バックテスト実行 | run\_backtrader.pyを実行し、strategy.ymlに定義された戦略ロジックに基づき全銘柄のバックテストを行い、結果をCSVレポートとして出力する。 |  
| Webアプリケーション | app.pyを実行することでFlaskサーバーを起動し、Webブラウザ上でチャート分析機能を提供する。 |  
| インタラクティブチャート | ・銘柄、時間足、インジケーターのパラメータをWebUIから動的に変更可能。 ・チャートはマウス操作で拡大・縮小・移動が可能。 ・マウスホバーで日時、四本値、各インジケーターの値をツールチップで表示。 ・取引履歴テーブルとチャートが連動し、クリックでハイライト表示。 |  
| 結果出力 | バックテスト実行時に、backtest\_results/reportディレクトリにサマリー、銘柄別詳細、統合取引履歴のCSVレポートを生成する。 |  
| 通知・ログ機能 | システムの動作状況やエラーをログファイルに出力する。 |

### **2.2. 非機能要件**

| 要件項目 | 内容 |  
| 操作性 | 利用者はrun\_backtrader.pyでバックテストを行い、app.pyで分析用Webサーバーを起動する。実際の分析はWebブラウザのGUIで行う。 |  
| 拡張性 | 取引戦略の全ロジック（エントリー、イグジット、サイジング）をstrategy.ymlで管理。インジケーターのリアルタイムな調整はWeb UIから可能。 |  
| 保守性 | システム設定、戦略ロジック定義、Webサーバー、チャート生成機能などをファイル分割し、可読性とメンテナンス性を高める。 |  
| 信頼性 | BacktraderとPlotlyという、実績のあるライブラリを基盤とすることで、計算と描画の信頼性を確保する。 |

## **3\. システム構成**

### **3.1. アーキテクチャ図（概念）**

\[strategy.yml\] \<---+  
|  
\[CSVデータ\] \<---+ |  
| |  
\[run\_backtrader.py\] \---+--\> \[btrader\_strategy.py\] \---\> \[CSVレポート\] \<---+  
| |  
\+------------------------------------------------\> \[ログファイル\] |  
|  
\[app.py (Flask Webサーバー)\] \<----+-------------------------------------\> \[Webブラウザ (クライアント)\]  
| ^  
\+-------------\> \[chart\_generator.py (ライブラリ)\] \-----------------------+

### **3.2. 技術スタック**

| 領域 | 主要技術 | 役割 |  
| プログラミング言語 | Python | システム全体の開発言語。 |  
| Webフレームワーク | Flask | チャート分析機能を提供するWebサーバー。 |  
| バックテストエンジン | Backtrader | バックテストの実行、指標計算、結果分析のコア機能。 |  
| データ操作 | Pandas | CSVデータの読み込みと加工、レポート生成。 |  
| チャート描画 | Plotly | インタラクティブなHTMLチャートのデータ生成。 |  
| 設定ファイル | YAML | strategy.yml で戦略ロジックと各種設定を管理。 |

## **4\. 運用フロー**

1. **データ準備**: dataディレクトリに分析したい銘柄の5分足CSVデータを配置する。  
2. **戦略の定義**: strategy.ymlファイルを編集し、エントリー、イグジット、サイジングのルールを記述する。  
3. **バックテスト実行**: コマンドプロンプトで python run\_backtrader.py を実行する。  
4. **分析サーバー起動**: コマンドプロンプトで python app.py を実行する。  
5. **ブラウザで分析**: Webブラウザで http://127.0.0.1:5001 を開き、以下の操作を行う。  
   * ドロップダウンで銘柄と時間足を切り替え。  
   * 入力フォームでインジケーターのパラメータをリアルタイムに変更。  
   * 取引履歴テーブルをクリックして、チャート上の取引をハイライト。  
6. **結果確認**: backtest\_results/report内のCSVレポートで、数値的なパフォーマンスを確認する。  
7. **分析と改善**: 分析結果を基に、strategy.ymlの戦略定義を改善し、再度バックテストを実行する。

## **5\. リスクと対策**

| リスク | 対策 |  
| 戦略ロジックのバグ | trade\_historyレポートで、意図した通りの「エントリー根拠」で取引が行われているかを確認する。ログファイルで取引前後の資金変動やインジケーターの値を追う。 |  
| 過学習（カーブフィッティング） | 同じデータセットでパラメータ調整を繰り返すと、そのデータにのみ過度に最適化されてしまう。定期的に新しい期間のデータでテストを行い、戦略の堅牢性を確認する。 |  
| CSVデータのフォーマットエラー | システムが想定するカラム名（datetime, open, high, low, close, volume）と日付形式 (YYYY-MM-DD HH:MM:SS) にデータが従っていることを確認する。 |

## **6\. 免責事項**

本システムは、特定の投資成果を保証するものではない。本システムを利用した結果生じたいかなる金融上の損失についても、開発者は一切の責任を負わないものとする。投資に関する最終的な決定は、利用者自身の判断と責任において行うこと。