承知いたしました。バグ修正（Cerebroクラッシュ問題）に向けた「案3：再起動方式」の採用、および改修プロセスの順守、了解いたしました。

まずはステップ1として、**基本仕様書（Basic Specification）** を作成します。

---

# 基本仕様書: リアルタイムトレードシステム ライフサイクル管理改修

**プロジェクト:** StockAutoV3  
**作成日:** 2025/11/24  
**バージョン:** 1.0  
**対象コンポーネント:** `realtrade` パッケージ (`run_realtrade.py`)

## 1. 改修の目的

本改修は、リアルタイムトレード実行時（`run_realtrade.py`）において、市場クローズ後（15:30以降）から翌朝までの間に発生する以下の重大なエラーを解消することを目的とする。

* **エラー内容:** `ValueError: min() iterable argument is empty`
* **発生原因:** 取引時間外にデータフィードがデータ（Tick）を返さなくなり、BacktraderのCerebroが時間進行に必要な「次の時刻」を見失うため。
* **解決方針:** 「再起動方式」を採用する。取引時間外はCerebroを含むシステム全体を計画的に停止し、翌営業日の市場開始前に再起動することで、エラーの発生要因を根本から排除する。

## 2. 基本方針（再起動方式）

システム（`RealtimeTrader`）の稼働を「24時間連続稼働」から「市場時間連動型稼働」へ変更する。

### 2.1. 稼働サイクル
システムは以下のサイクルを繰り返す。

1.  **起動待機:** 市場開始時刻（09:00）までスリープ状態で待機する。
2.  **起動 (Start):** 市場開始時刻に `RealtimeTrader`（および内部のCerebro）を新規インスタンスとして起動する。
3.  **稼働 (Running):** 取引時間中は通常通りトレードロジックを実行する。
4.  **停止 (Stop):** 市場終了時刻（15:30目安）に `RealtimeTrader` を安全に停止・破棄する。
5.  **夜間/週末待機:** 次の営業日まで待機モードに戻る。

### 2.2. データ整合性の保証
システムの再起動に伴うデータの消失を防ぐため、以下の既存機能を活用する。

* **ポジションの永続化:** 停止前に `StateManager` (SQLite) および `PositionSynchronizer` (Excel連携) が最新のポジション状態を保持していることを前提とする。
* **ポジションの復元:** 再起動時、ストラテジーは `StateManager` からポジション情報を読み込み、内部状態を復元する。これにより、前日から持ち越したポジションの管理を継続する。

## 3. 機能要件

### 3.1. 取引時間の定義と判定
システムは現在時刻に基づき、以下のステータスを判定できなければならない。

* **市場オープン (Market Open):**
    * 平日 の **09:00 ～ 11:30** (前場)
    * 平日 の **12:30 ～ 15:30** (後場 + 大引け処理時間)
    * ※ 15:00ではなく15:30とするのは、クロージングオークションやデータ遅延を考慮し、処理を確実に完了させるためである。
* **市場クローズ (Market Closed):**
    * 上記以外の時間帯
    * 土曜日・日曜日

### 3.2. 自動起動・停止機能 (`run_realtrade.py`)
`main` 関数のループ処理において、以下の制御を行う。

* **起動ロジック:**
    * 現在が「市場オープン」かつ「トレーダーが未起動」の場合、`RealtimeTrader` インスタンスを作成し `.start()` する。
* **停止ロジック:**
    * 現在が「市場クローズ」かつ「トレーダーが起動中」の場合、`RealtimeTrader.stop()` を呼び出し、インスタンスを破棄（`None`化）する。
* **待機ロジック:**
    * 市場クローズ中は、無駄なループを避けるため、次の市場開始時刻（翌営業日 09:00）まで、または一定間隔でスリープする。

### 3.3. 週末・祝日の考慮
* **週末対応:** 土日の場合は起動せず、月曜日の09:00まで待機する。
* **祝日対応:** 現段階ではPythonの標準ライブラリ (`datetime`) のみで判定可能な「土日」を休場扱いとする。（※祝日判定カレンダーの導入は今回のスコープ外とし、必要であれば手動停止または別途改修とする）

## 4. 非機能要件

### 4.1. リソース管理
* 待機中（夜間・週末）は、`RealtimeTrader` インスタンスおよび `Cerebro` スレッド、Excel連携スレッドをすべて開放し、メモリ・CPU消費を最小限（実質ゼロ）にする。

### 4.2. ログ出力
* 状態遷移（起動、停止、待機開始）のタイミングで、明確なINFOログを出力する。
* 待機中は「次の起動予定時刻」をログに出力する。

### 4.3. 安全性
* `KeyboardInterrupt` (Ctrl+C) を検知した際は、稼働状態に関わらず即座に安全な停止処理（`stop()`）を実行し、プログラムを終了する。

## 5. 影響範囲

* **修正対象ファイル:** `src/realtrade/run_realtrade.py`
    * `main()` 関数のループ構造を全面的に書き換える。
* **依存関係:**
    * `RealtimeTrader` クラスの `start()` / `stop()` メソッドが正常に機能すること（既存実装の確認）。
    * `StateManager` によるDB保存が正常に機能すること（既存実装の利用）。

---

以上が基本仕様書となります。
内容に問題がなければ、次は **２，詳細設計書の作成（MD形式）** に進みます。
ご確認をお願いいたします。