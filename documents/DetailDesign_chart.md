# **チャート機能 詳細設計書 (v7.2)**

## **1\. 概要**

### **1.1. 機能の目的**

本機能は、バックテスト結果を視覚化し、戦略の挙動を直感的に分析するためのインタラクティブなチャートをWebブラウザ上に提供することを目的とする。利用者は、銘柄、時間足、テクニカル指標のパラメータをWeb UIからリアルタイムに変更し、その結果を即座にチャートで確認できる。

### **1.2. アーキテクチャ**

* **フロントエンド**: HTML, CSS, JavaScriptで構成される単一のWebページ (templates/index.html)。  
* **バックエンド**:  
  * **Flask (app.py)**: Webサーバーとして機能し、ブラウザからのリクエストを処理する。  
  * **Plotly (chart\_generator.py)**: Flaskからの要求に応じて、チャートデータをJSON形式で生成する。  
* **データフロー**:  
  1. ブラウザがページを読み込むか、UIのフォームを変更する。  
  2. JavaScriptが現在の全設定値を取得し、/get\_chart\_data APIに非同期リクエストを送信する。  
  3. app.pyがリクエストを受け取り、パラメータをchart\_generator.pyに渡す。  
  4. chart\_generator.pyがチャートデータと取引履歴を生成し、JSONでapp.pyに返す。  
  5. app.pyが受け取ったJSONをブラウザに返す。  
  6. JavaScriptがJSONを受け取り、Plotly.jsライブラリを使ってチャートを描画・更新する。

## **2\. インターフェース仕様**

### **2.1. 入力 (バックエンド)**

* **strategy.yml**: 各種インジケーターの**表示上のデフォルトパラメータ**を定義。  
* **data/\*.csv**: 価格データ。  
* **backtest\_results/report/trade\_history\_\*.csv**: バックテストによる取引履歴。

### **2.2. 出力 (フロントエンド)**

* ブラウザ上に動的にレンダリングされるインタラクティブなチャート。物理的なファイル出力は行わない。

## **3\. 機能仕様詳細**

### **3.1. 基本チャート機能**

| 機能 | 仕様 |
| :---- | :---- |
| **ローソク足** | 陽線は赤、陰線は緑で表示。 |
| **出来高** | ローソク足の色に連動した棒グラフとして、価格チャートの第2Y軸に半透明（opacity: 0.3）で描画。 |
| **ズーム** | マウスホイールのスクロールで拡大・縮小が可能 (scrollZoom: true)。 |
| **パン（移動）** | チャートをドラッグして表示範囲を移動可能。 |
| **ツールチップ** | **Plotly標準の統一ツールチップ** (hovermode: 'x unified') を使用。マウスカーソル位置の全データをまとめて表示する。 |
| **時間軸の最適化** | 短期・中期チャートでは、週末・夜間・昼休みを時間軸から除外（rangebreaks）し、取引時間のみを連続して表示。長期（日足）チャートでは週末のみを除外する。 |

### **3.2. インジケーター・取引表示**

| 機能 | 仕様 |
| :---- | :---- |
| **単純移動平均線 (SMA)** | **全時間足**に対応。短期・長期のSMAを価格チャートに重ねて描画。期間はWebフォームから変更可能。 |
| **指数平滑移動平均線 (EMA)** | **全時間足**に対応。長期EMAおよび短期EMA（速・遅）を価格チャートに重ねて描画。期間はWebフォームから変更可能。 |
| **ボリンジャーバンド** | **全時間足**に対応。価格チャートに重ねて描画。期間と標準偏差はWebフォームから変更可能。バンド間は半透明のグレーで塗りつぶされる。 |
| **VWAP** | \*\*日中足（短期・中期）\*\*に対応。価格チャートに点線で描画。Webフォームのチェックボックスで表示/非表示を切り替え可能。 |
| **一目均衡表** | **短期チャート**のみ対応。転換線、基準線、遅行スパン、先行スパンA、先行スパンBをそれぞれ線で描画。パラメータはWebフォームから変更可能。 |
| **MACD** | 短期チャートの下部パネルに描画。ヒストグラム、MACD線、シグナル線を表示。パラメータはWebフォームから変更可能。 |
| **Slow Stochastic** | 短期チャートの下部パネルに描画。%K線と%D線、および80/20の閾値ラインを表示。パラメータはWebフォームから変更可能。 |
| **RSI** | 中期チャートの下部パネルに描画。RSI線と70/30の閾値ラインを表示。パラメータはWebフォームから変更可能。 |
| **ADX/DMI** | **全時間足**に対応。下部パネルにADX、+DI、-DIを線で描画。期間はWebフォームから変更可能。 |
| **ATR** | **全時間足**に対応。下部パネルにATRを線で描画。期間はWebフォームから変更可能。 |
| **売買ポイント** | 取引があった箇所にマーカーを表示（BUY: 赤▲, SELL: 緑▼）。 |
| **損切り・利確ライン** | 各トレードに対応するSL/TPラインを点線で表示。 |

### **3.3. 画面レイアウト**

* **コントロールパネル**: 画面上部に配置。銘柄・時間足の選択ドロップダウンと、全インジケーターのパラメータ入力フォームを機能ごとにグループ化して配置。  
* **チャートパネル**: 画面中央の大部分を占める。価格チャートと、選択された時間足に応じたインジケーターのサブプロット（最大5段）で構成される。  
* **取引履歴テーブル**: 画面下部に配置。選択中の銘柄の全取引履歴を一覧表示し、クリックでチャート上の取引をハイライトする。テーブルが画面幅を超える場合は水平スクロールが可能。