# **チャート出力機能 詳細設計書**

## **1\. 概要**

### **1.1. 機能の目的**

本機能は、run\_backtrader.pyによって実行されたバックテストの結果を視覚化することを目的とする。具体的には、取引履歴と価格データを基に、戦略で利用される主要なテクニカル指標や売買ポイントを含むチャート画像を銘柄ごと、および時間足ごとに生成する。これにより、利用者は戦略の挙動を直感的に理解し、分析と改善のサイクルを高速化できる。

### **1.2. 機能の分離**

チャート生成機能は、バックテスト実行プロセス（run\_backtrader.py）から完全に分離されている。この設計により、以下の利点がもたらされる。

* **安定性**: チャート描画処理のエラーがバックテスト本体の実行に影響を与えない。  
* **柔軟性**: バックテストを再実行することなく、チャートの見た目や内容を自由に変更し、再生成できる。

## **2\. インターフェース仕様**

### **2.1. 入力**

chart\_generator.pyは、以下のファイルを入力として利用する。

| ファイル種別 | パス | 説明 |
| :---- | :---- | :---- |
| **取引履歴レポート** | backtest\_results/report/trade\_history\_\*.csv | run\_backtrader.pyが出力したCSVファイル。全銘柄の全取引履歴が含まれる。スクリプトは、この中で最もタイムスタンプが新しいファイルを自動的に選択する。 |
| **価格データ** | data/\*.csv | バックテストに使用された元の価格データ（5分足）。銘柄ごとにファイルが分かれている。 |
| **戦略設定ファイル** | strategy.yml | インジケーターの期間など、チャート描画に必要なパラメータ設定を読み込む。 |

### **2.2. 出力**

本スクリプトは、分析対象の全銘柄について、以下の3種類のチャート画像をPNG形式で出力する。

| ファイル名 | 保存先 | 説明 |
| :---- | :---- | :---- |
| chart\_short\_\[銘柄コード\].png | backtest\_results/chart/ | 短期足の分析チャート。 |
| chart\_medium\_\[銘柄コード\].png | backtest\_results/chart/ | 中期足の分析チャート。 |
| chart\_long\_\[銘柄コード\].png | backtest\_results/chart/ | 長期足の分析チャート。 |

## **3\. 内部処理仕様**

### **3.1. 処理フロー**

スクリプトの実行フローは以下の通り。

1. **初期化**:  
   * ロギングを設定する。  
   * backtest\_results/report ディレクトリ内をスキャンし、最も新しいtrade\_history\_\*.csvファイルのパスを取得する。取引履歴ファイルが存在しない場合は、警告ログを出力し、空のデータフレームで処理を続行する。  
   * strategy.ymlから戦略パラメータを読み込む。  
2. **銘柄ループ**:  
   * dataディレクトリ内の価格データCSVファイルから、分析対象となる全銘柄のリストを取得する。  
   * 取得した銘柄リストに基づき、1銘柄ずつループ処理を開始する。  
3. **データ準備（各銘柄ごと）**:  
   * 該当銘柄の価格データ（5分足）をCSVから読み込む。  
   * 読み込んだデータの日時インデックスからタイムゾーン情報を削除し、naiveな状態に統一する。  
   * 取引履歴データフレームから、現在処理中の銘柄の取引のみを抽出する。  
4. **チャート生成（各時間足ごと）**:  
   * **短期チャート**:  
     * 5分足データを基に短期EMAを計算する。  
     * 取引履歴から売買マーカー、損切り(SL)・利確(TP)ラインの位置情報を生成する。  
     * mplfinanceを使い、ローソク足、出来高、短期EMA、売買マーカー、SL/TPラインを重ね合わせて描画し、凡例を追加してファイルに保存する。  
   * **中期チャート**:  
     * 5分足データをresampleし、60分足データを生成する。  
     * 60分足データからRSIを計算する。  
     * mplfinanceを使い、ローソク足、出来高、および別パネルにRSIと閾値ラインを描画してファイルに保存する。  
   * **長期チャート**:  
     * 5分足データをresampleし、日足データを生成する。  
     * 日足データから長期EMAを計算する。  
     * mplfinanceを使い、ローソク足、出来高、長期EMAを重ね合わせて描画し、凡例を追加してファイルに保存する。  
5. **終了**:  
   * 全ての銘柄の処理が完了したら、終了ログを出力する。

### **3.2. 主要関数**

| 関数名 | 役割 |
| :---- | :---- |
| plot\_multi\_timeframe\_charts() | 全ての処理を統括するメイン関数。 |
| find\_latest\_report() | 指定されたディレクトリとプレフィックスから最新のレポートファイルを見つける。 |
| get\_all\_symbols() | dataディレクトリから分析対象の全銘柄リストを取得する。 |
| resample\_ohlc(df, rule) | 渡されたDataFrameを指定されたルール（例: '60min', 'D'）でリサンプリングし、OHLCVデータを生成する。 |

## **4\. 各チャートの詳細仕様**

### **4.1. 短期チャート (chart\_short\_\*.png)**

| 項目 | 仕様 |
| :---- | :---- |
| **時間足** | 5分足 |
| **タイトル** | \[銘柄コード\] Short-Term (5min) |
| **メインパネル** | ・ローソク足 ・短期EMA (fast) ・短期EMA (slow) ・買いエントリーマーカー（緑の上向き三角） ・売りエントリーマーカー（赤の下向き三角） ・損切りライン（赤の点線） ・利確ライン（緑の点線） |
| **出来高パネル** | 出来高を棒グラフで表示。 |
| **凡例** | チャート左上に、各EMA、マーカー、ラインの凡例を表示する。 |

### **4.2. 中期チャート (chart\_medium\_\*.png)**

| 項目 | 仕様 |
| :---- | :---- |
| **時間足** | 60分足 |
| **タイトル** | \[銘柄コード\] Medium-Term (60min) |
| **メインパネル** | ・ローソク足 |
| **出来高パネル** | 出来高を棒グラフで表示。 |
| **RSIパネル** | ・RSI（青線） ・RSI買われすぎ閾値（赤の破線） ・RSI売られすぎ閾値（緑の破線） |

### **4.3. 長期チャート (chart\_long\_\*.png)**

| 項目 | 仕様 |
| :---- | :---- |
| **時間足** | 日足 |
| **タイトル** | \[銘柄コード\] Long-Term (Daily) |
| **メインパネル** | ・ローソク足 ・長期EMA |
| **出来高パネル** | 出来高を棒グラフで表示。 |
| **凡例** | チャート左上に、長期EMAの凡例を表示する。 |

