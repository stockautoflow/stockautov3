はい、承知いたしました。
基本仕様書に基づき、実装担当者向けの具体的な変更内容を記した詳細設計書を作成します。

-----

## インジケーター修正 詳細設計書

### 1\. はじめに 📄

本ドキュメントは、「インジケーター修正 基本仕様書 (改訂版)」に基づき、`ZeroDivisionError`を解消するための具体的な実装詳細を定義します。対象となるファイルは`src/core/indicators.py`および`src/core/strategy/strategy_initializer.py`の2点です。

-----

### 2\. 改修ファイル詳細 🛠️

#### 2.1. `src/core/indicators.py`の修正

**目的**: `SafeStochastic`のゼロ除算回避ロジックをより堅牢なものに置き換え、新たに`SafeRSI`を実装する。

##### **変更点 1: `SafeStochastic`クラスの全面的な置換**

現在の`next`メソッドをオーバーライドする実装から、Backtraderの組み込みインジケーターを活用した、より宣言的で安全な実装に置き換えます。

**変更前:**

```python
# src/core/indicators.py
class SafeStochastic(bt.indicators.Stochastic):
    def next(self):
        if self.data.high[0] - self.data.low[0] == 0:
            self.lines.percK[0] = 50.0
            self.lines.percD[0] = 50.0
        else:
            super().next()
```

**変更後:**

```python
# src/core/indicators.py
# ▼▼▼【変更箇所: SafeStochasticを完全に新しい堅牢な実装に置換】▼▼▼
class SafeStochastic(bt.Indicator):
    """
    ゼロ除算を完全に回避する堅牢なStochasticインジケーター。
    BacktraderのFull Stochasticのロジックを再現しつつ、
    計算期間内の価格レンジがゼロの場合でも安全に動作する。
    """
    lines = ('percK', 'percD',)
    params = (
        ('period', 14),
        ('period_dfast', 3),
        ('period_dslow', 3),
        ('movav', bt.ind.SMA),
    )

    def __init__(self):
        # 期間内の最高値と最安値
        highest_high = bt.ind.Max(self.data.high, period=self.p.period)
        lowest_low = bt.ind.Min(self.data.low, period=self.p.period)

        # ゼロ除算を避けるための価格レンジ計算
        price_range = highest_high - lowest_low

        # bt.Ifを使用して条件分岐で安全に%Kを計算
        # price_rangeが0より大きい場合のみ通常の計算を行い、それ以外は50.0（中間値）を返す
        percK_raw = bt.If(
            price_range > 0,
            100.0 * (self.data.close - lowest_low) / price_range,
            50.0
        )

        # Full Stochasticのロジックに基づき、%Kと%Dを計算
        self.lines.percK = self.p.movav(percK_raw, period=self.p.period_dfast)
        self.lines.percD = self.p.movav(self.lines.percK, period=self.p.period_dslow)
# ▲▲▲【変更箇所ここまで】▲▲▲
```

##### **変更点 2: `SafeRSI`クラスの新規追加**

ファイルの末尾に、`bt.indicators.RSI`を継承した`SafeRSI`クラスを新たに追加します。

**追加するコード:**

```python
# src/core/indicators.py
# (SafeADXクラスの定義の下に追記)
# ▼▼▼【変更箇所: SafeRSIを新規追加】▼▼▼
class SafeRSI(bt.indicators.RSI):
    """
    ゼロ除算エラーを回避する安全なRSIインジケーター。
    一定期間の値下がりがない場合（＝分母が0になる）でもエラーにならず、
    RSIの理論値である100.0を返すように修正。
    """
    def _get_rsi(self, gain, loss):
        if loss == 0.0:
            return 100.0
        # 親クラスの計算ロジックを呼び出す
        return super(SafeRSI, self)._get_rsi(gain, loss)
# ▲▲▲【変更箇所ここまで】▲▲▲
```

-----

#### 2.2. `src/core/strategy/strategy_initializer.py`の修正

**目的**: システムが`SafeRSI`を自動的に利用するように、インジケーターのマッピング設定を更新する。

##### **変更点 1: `SafeRSI`のインポート**

`indicators`モジュールから`SafeRSI`をインポートするリストに追加します。

**変更前:**

```python
# src/core/strategy/strategy_initializer.py
from ..indicators import SafeStochastic, VWAP, SafeADX
```

**変更後:**

```python
# src/core/strategy/strategy_initializer.py
# ▼▼▼【変更箇所: SafeRSIをインポートリストに追加】▼▼▼
from ..indicators import SafeStochastic, VWAP, SafeADX, SafeRSI
# ▲▲▲【変更箇所ここまで】▲▲▲
```

##### **変更点 2: `custom_indicators`辞書への`SafeRSI`の登録**

`_find_indicator_class`メソッド内で定義されている辞書に、`'rsi'`キーと`SafeRSI`クラスのペアを追加します。

**変更前:**

```python
# src/core/strategy/strategy_initializer.py
    def _find_indicator_class(self, name):
        # ...
        custom_indicators = {'stochastic': SafeStochastic, 'vwap': VWAP, 'adx': SafeADX}
        # ...
```

**変更後:**

```python
# src/core/strategy/strategy_initializer.py
    def _find_indicator_class(self, name):
        # ...
        # ▼▼▼【変更箇所: SafeRSIをカスタムインジケーターとして登録】▼▼▼
        custom_indicators = {'stochastic': SafeStochastic, 'vwap': VWAP, 'adx': SafeADX, 'rsi': SafeRSI}
        # ▲▲▲【変更箇所ここまで】▲▲▲
        if name.lower() in custom_indicators:
            return custom_indicators[name.lower()]
        # ...
```

-----

### 3\. 検証・確認項目 ✅

  - 上記の修正を適用後、`evaluation`を実行し、以前`ZeroDivisionError`で失敗していた全ての戦略（`2, 13, 14, 15, 28, 29, 30`）が最後まで正常に完了することを確認する。
  - 念のため、値動きがない期間を含むデータでバックテストを実行しても、`Stochastic`および`RSI`の値がエラーにならず、それぞれ`50.0`および`100.0`に近い値として計算されていることを（デバッグログ等で）確認する。