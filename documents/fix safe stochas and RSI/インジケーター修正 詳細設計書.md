ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚
åŸºæœ¬ä»•æ§˜æ›¸ã«åŸºã¥ãã€å®Ÿè£…æ‹…å½“è€…å‘ã‘ã®å…·ä½“çš„ãªå¤‰æ›´å†…å®¹ã‚’è¨˜ã—ãŸè©³ç´°è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã¾ã™ã€‚

-----

## ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä¿®æ­£ è©³ç´°è¨­è¨ˆæ›¸

### 1\. ã¯ã˜ã‚ã« ğŸ“„

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã€Œã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä¿®æ­£ åŸºæœ¬ä»•æ§˜æ›¸ (æ”¹è¨‚ç‰ˆ)ã€ã«åŸºã¥ãã€`ZeroDivisionError`ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªå®Ÿè£…è©³ç´°ã‚’å®šç¾©ã—ã¾ã™ã€‚å¯¾è±¡ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯`src/core/indicators.py`ãŠã‚ˆã³`src/core/strategy/strategy_initializer.py`ã®2ç‚¹ã§ã™ã€‚

-----

### 2\. æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´° ğŸ› ï¸

#### 2.1. `src/core/indicators.py`ã®ä¿®æ­£

**ç›®çš„**: `SafeStochastic`ã®ã‚¼ãƒ­é™¤ç®—å›é¿ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚ˆã‚Šå …ç‰¢ãªã‚‚ã®ã«ç½®ãæ›ãˆã€æ–°ãŸã«`SafeRSI`ã‚’å®Ÿè£…ã™ã‚‹ã€‚

##### **å¤‰æ›´ç‚¹ 1: `SafeStochastic`ã‚¯ãƒ©ã‚¹ã®å…¨é¢çš„ãªç½®æ›**

ç¾åœ¨ã®`next`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å®Ÿè£…ã‹ã‚‰ã€Backtraderã®çµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ´»ç”¨ã—ãŸã€ã‚ˆã‚Šå®£è¨€çš„ã§å®‰å…¨ãªå®Ÿè£…ã«ç½®ãæ›ãˆã¾ã™ã€‚

**å¤‰æ›´å‰:**

```python
# src/core/indicators.py
class SafeStochastic(bt.indicators.Stochastic):
    def next(self):
        if self.data.high[0] - self.data.low[0] == 0:
            self.lines.percK[0] = 50.0
            self.lines.percD[0] = 50.0
        else:
            super().next()
```

**å¤‰æ›´å¾Œ:**

```python
# src/core/indicators.py
# â–¼â–¼â–¼ã€å¤‰æ›´ç®‡æ‰€: SafeStochasticã‚’å®Œå…¨ã«æ–°ã—ã„å …ç‰¢ãªå®Ÿè£…ã«ç½®æ›ã€‘â–¼â–¼â–¼
class SafeStochastic(bt.Indicator):
    """
    ã‚¼ãƒ­é™¤ç®—ã‚’å®Œå…¨ã«å›é¿ã™ã‚‹å …ç‰¢ãªStochasticã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚
    Backtraderã®Full Stochasticã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾ã—ã¤ã¤ã€
    è¨ˆç®—æœŸé–“å†…ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ãŒã‚¼ãƒ­ã®å ´åˆã§ã‚‚å®‰å…¨ã«å‹•ä½œã™ã‚‹ã€‚
    """
    lines = ('percK', 'percD',)
    params = (
        ('period', 14),
        ('period_dfast', 3),
        ('period_dslow', 3),
        ('movav', bt.ind.SMA),
    )

    def __init__(self):
        # æœŸé–“å†…ã®æœ€é«˜å€¤ã¨æœ€å®‰å€¤
        highest_high = bt.ind.Max(self.data.high, period=self.p.period)
        lowest_low = bt.ind.Min(self.data.low, period=self.p.period)

        # ã‚¼ãƒ­é™¤ç®—ã‚’é¿ã‘ã‚‹ãŸã‚ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸è¨ˆç®—
        price_range = highest_high - lowest_low

        # bt.Ifã‚’ä½¿ç”¨ã—ã¦æ¡ä»¶åˆ†å²ã§å®‰å…¨ã«%Kã‚’è¨ˆç®—
        # price_rangeãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿é€šå¸¸ã®è¨ˆç®—ã‚’è¡Œã„ã€ãã‚Œä»¥å¤–ã¯50.0ï¼ˆä¸­é–“å€¤ï¼‰ã‚’è¿”ã™
        percK_raw = bt.If(
            price_range > 0,
            100.0 * (self.data.close - lowest_low) / price_range,
            50.0
        )

        # Full Stochasticã®ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãã€%Kã¨%Dã‚’è¨ˆç®—
        self.lines.percK = self.p.movav(percK_raw, period=self.p.period_dfast)
        self.lines.percD = self.p.movav(self.lines.percK, period=self.p.period_dslow)
# â–²â–²â–²ã€å¤‰æ›´ç®‡æ‰€ã“ã“ã¾ã§ã€‘â–²â–²â–²
```

##### **å¤‰æ›´ç‚¹ 2: `SafeRSI`ã‚¯ãƒ©ã‚¹ã®æ–°è¦è¿½åŠ **

ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã«ã€`bt.indicators.RSI`ã‚’ç¶™æ‰¿ã—ãŸ`SafeRSI`ã‚¯ãƒ©ã‚¹ã‚’æ–°ãŸã«è¿½åŠ ã—ã¾ã™ã€‚

**è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰:**

```python
# src/core/indicators.py
# (SafeADXã‚¯ãƒ©ã‚¹ã®å®šç¾©ã®ä¸‹ã«è¿½è¨˜)
# â–¼â–¼â–¼ã€å¤‰æ›´ç®‡æ‰€: SafeRSIã‚’æ–°è¦è¿½åŠ ã€‘â–¼â–¼â–¼
class SafeRSI(bt.indicators.RSI):
    """
    ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹å®‰å…¨ãªRSIã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚
    ä¸€å®šæœŸé–“ã®å€¤ä¸‹ãŒã‚ŠãŒãªã„å ´åˆï¼ˆï¼åˆ†æ¯ãŒ0ã«ãªã‚‹ï¼‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšã€
    RSIã®ç†è«–å€¤ã§ã‚ã‚‹100.0ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã€‚
    """
    def _get_rsi(self, gain, loss):
        if loss == 0.0:
            return 100.0
        # è¦ªã‚¯ãƒ©ã‚¹ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        return super(SafeRSI, self)._get_rsi(gain, loss)
# â–²â–²â–²ã€å¤‰æ›´ç®‡æ‰€ã“ã“ã¾ã§ã€‘â–²â–²â–²
```

-----

#### 2.2. `src/core/strategy/strategy_initializer.py`ã®ä¿®æ­£

**ç›®çš„**: ã‚·ã‚¹ãƒ†ãƒ ãŒ`SafeRSI`ã‚’è‡ªå‹•çš„ã«åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ã€ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚’æ›´æ–°ã™ã‚‹ã€‚

##### **å¤‰æ›´ç‚¹ 1: `SafeRSI`ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**

`indicators`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰`SafeRSI`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚

**å¤‰æ›´å‰:**

```python
# src/core/strategy/strategy_initializer.py
from ..indicators import SafeStochastic, VWAP, SafeADX
```

**å¤‰æ›´å¾Œ:**

```python
# src/core/strategy/strategy_initializer.py
# â–¼â–¼â–¼ã€å¤‰æ›´ç®‡æ‰€: SafeRSIã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ ã€‘â–¼â–¼â–¼
from ..indicators import SafeStochastic, VWAP, SafeADX, SafeRSI
# â–²â–²â–²ã€å¤‰æ›´ç®‡æ‰€ã“ã“ã¾ã§ã€‘â–²â–²â–²
```

##### **å¤‰æ›´ç‚¹ 2: `custom_indicators`è¾æ›¸ã¸ã®`SafeRSI`ã®ç™»éŒ²**

`_find_indicator_class`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸ã«ã€`'rsi'`ã‚­ãƒ¼ã¨`SafeRSI`ã‚¯ãƒ©ã‚¹ã®ãƒšã‚¢ã‚’è¿½åŠ ã—ã¾ã™ã€‚

**å¤‰æ›´å‰:**

```python
# src/core/strategy/strategy_initializer.py
    def _find_indicator_class(self, name):
        # ...
        custom_indicators = {'stochastic': SafeStochastic, 'vwap': VWAP, 'adx': SafeADX}
        # ...
```

**å¤‰æ›´å¾Œ:**

```python
# src/core/strategy/strategy_initializer.py
    def _find_indicator_class(self, name):
        # ...
        # â–¼â–¼â–¼ã€å¤‰æ›´ç®‡æ‰€: SafeRSIã‚’ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦ç™»éŒ²ã€‘â–¼â–¼â–¼
        custom_indicators = {'stochastic': SafeStochastic, 'vwap': VWAP, 'adx': SafeADX, 'rsi': SafeRSI}
        # â–²â–²â–²ã€å¤‰æ›´ç®‡æ‰€ã“ã“ã¾ã§ã€‘â–²â–²â–²
        if name.lower() in custom_indicators:
            return custom_indicators[name.lower()]
        # ...
```

-----

### 3\. æ¤œè¨¼ãƒ»ç¢ºèªé …ç›® âœ…

  - ä¸Šè¨˜ã®ä¿®æ­£ã‚’é©ç”¨å¾Œã€`evaluation`ã‚’å®Ÿè¡Œã—ã€ä»¥å‰`ZeroDivisionError`ã§å¤±æ•—ã—ã¦ã„ãŸå…¨ã¦ã®æˆ¦ç•¥ï¼ˆ`2, 13, 14, 15, 28, 29, 30`ï¼‰ãŒæœ€å¾Œã¾ã§æ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
  - å¿µã®ãŸã‚ã€å€¤å‹•ããŒãªã„æœŸé–“ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã§ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚‚ã€`Stochastic`ãŠã‚ˆã³`RSI`ã®å€¤ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšã€ãã‚Œãã‚Œ`50.0`ãŠã‚ˆã³`100.0`ã«è¿‘ã„å€¤ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ç­‰ã§ï¼‰ç¢ºèªã™ã‚‹ã€‚