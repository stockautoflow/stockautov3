はい、承知いたしました。
ご指摘いただいた点を踏まえ、`strategy_initializer.py`の役割と修正内容をより正確に記述した基本仕様書を再作成します。

---

## インジケーター修正 基本仕様書

### 1. 概要 📝
本仕様書は、バックテスト実行中に発生する`ZeroDivisionError`（ゼロ除算エラー）を根本的に解決するため、カスタムインジケーター`SafeStochastic`のロジックを修正し、新たに`SafeRSI`を導入する改修の基本仕様を定義するものです。本改修により、システムの安定性を向上させ、全戦略のバックテストを正常に完了させることを目的とします。

---

### 2. 背景と課題 🔍
`evaluation`の詳細ログ分析により、特定の戦略が、一定期間値動きがないデータ（高値=安値=終値）を処理する際にクラッシュしていることが判明しました。これは、`Stochastic`や`RSI`といったインジケーターの計算過程でゼロ除算が発生するためです。

* **`SafeStochastic`の課題**:
    現行の`SafeStochastic`は、ゼロ除算を回避する意図で導入されていますが、そのチェックロジックは**単一のローソク足**しか評価していません。Stochasticの計算では**複数期間**（例: 14本）の価格レンジを分母とするため、期間全体で値動きがないケースに対応できず、`ZeroDivisionError`を防ぎきれないという設計上の欠陥があります。

* **標準`RSI`の課題**:
    現在システムはBacktrader標準の`RSI`を使用しています。この標準`RSI`は、計算期間中に価格の下落が一度もない場合、計算式の分母（下落幅の平均）がゼロとなり、`ZeroDivisionError`を引き起こします。

---

### 3. 設計方針 🛠️
エラーを根本的に解決するため、各インジケーターの計算ロジック自体を、ゼロ除算を確実に回避する堅牢なものに置き換えます。

* **ロジックの堅牢化**: Backtraderの標準機能を活用し、計算前にゼロ除算の可能性を検知し、安全な値（中間値や理論上の最大値など）を返す条件分岐を計算式に組み込みます。
* **透過的な置換**: 戦略定義ファイル（`.yml`）を一切変更することなく、システムが自動的に安全なバージョンのインジケーターを使用するように`strategy_initializer.py`を修正します。

---

### 4. 機能仕様詳細 ⚙️

#### 4.1. `SafeStochastic`のロジック置換
`src/core/indicators.py`内の`SafeStochastic`クラスを、以下の仕様を満たすロジックに**全面的に置き換えます**。

* **計算ロジック**:
    1.  Backtraderの`bt.ind.Max`と`bt.ind.Min`を使用し、パラメータで指定された**計算期間全体**における最高値と最安値を計算します。
    2.  最高値と最安値の差（価格レンジ）を求めます。
    3.  Backtraderの`bt.If`を使い、以下の条件分岐を実装します。
        * **もし価格レンジが `0` より大きい場合**: 通常のStochasticの計算式 `100 * (終値 - 最安値) / 価格レンジ` を実行します。
        * **もし価格レンジが `0` の場合**: エラーを発生させる代わりに、中間値である `50.0` を計算結果として返します。

#### 4.2. `SafeRSI`の新規作成
`src/core/indicators.py`に、`bt.indicators.RSI`を継承した`SafeRSI`クラスを**新たに作成します**。

* **計算ロジック**:
    1.  Backtraderの標準RSIの計算ロジックを継承します。
    2.  内部の計算メソッド（`_get_rsi`）をオーバーライドし、以下の条件分岐を追加します。
        * **もし計算期間中の下落幅の平均（`loss`）が `0.0` の場合**: ゼロ除算を試みる代わりに、RSIの理論上の最大値である `100.0` を計算結果として返します。
        * **それ以外の場合**: 親クラスの通常のRSI計算を続行します。

#### 4.3. システムへの統合 (`strategy_initializer.py`の修正)
`src/core/strategy/strategy_initializer.py`を修正し、システムがこれらの堅牢なインジケーターを自動的に利用するようにします。

* **修正箇所**: `_find_indicator_class`メソッド内の`custom_indicators`辞書定義を更新します。
* **仕様**:
    1.  **`'stochastic'`キー**: このキーに対するマッピングは**既に存在します**。本改修では、マッピング先の`SafeStochastic`クラスの**内部実装が更新**されることになります。
    2.  **`'rsi'`キー**: このキーに対するマッピングは**存在しません**。本改修で、`'rsi'`キーと新設する`SafeRSI`クラスを紐付ける**マッピングを新たに追加します**。

これにより、戦略定義ファイルで`stochastic`や`rsi`が指定された際に、それぞれに対応する安全なバージョンが透過的に呼び出されるようになります。