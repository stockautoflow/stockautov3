はい、承知いたしました。  
両方の価格を「実価格」で出力し、「差分価格」を分析用に追加する改善案について、詳細設計書を作成します。

---

## **バックテスト結果出力改善 詳細設計書**

### **1\. 概要**

バックテスト結果のCSVファイル (trade\_history.csv) の出力を改善する。  
主な変更点は以下の通り。

1. **「ストップロス価格」列を、差分価格（リスク許容幅）から実際の損切り価格（実価格）の出力に変更する。**  
2. **「許容損失幅」列を新設し、エントリー時に設定したリスクの値幅を出力する。**  
3. **「目標利益幅」列を新設し、エントリー時に設定した利益目標の値幅を出力する。**

これにより、レポートの直感的な分かりやすさと、戦略分析の容易性を両立させる。

---

### **2\. 変更対象ファイル**

* src/backtest/run\_backtest.py

---

### **3\. 詳細設計**

#### **3.1. TradeList アナライザーの修正**

##### **3.1.1. notify\_trade メソッド (isopen時)**

トレード開始時に、sl\_price（損切り実価格）も open\_trades 辞書に保存するよう変更する。

**【変更前】**

Python

\# (isopen時の処理は存在しないか、sl\_priceの保存がない)

**【変更後】**

Python

\# src/backtest/run\_backtest.py \-\> class TradeList \-\> notify\_trade

\# トレードが開始された時点の情報を保存  
if trade.isopen:  
    self.open\_trades\[trade.ref\] \= {  
        'tp\_price': self.strategy.tp\_price,  
        'sl\_price': self.strategy.sl\_price,  \# sl\_price(実価格)の保存を追加  
        'risk\_per\_share': self.strategy.risk\_per\_share,  
        'entry\_reason': self.strategy.entry\_reason  
    }  
    return

##### **3.1.2. notify\_trade メソッド (isclosed時)**

トレード決済時に、保存しておいた sl\_price を「ストップロス価格」として使用する。また、取得した価格情報から「許容損失幅」と「目標利益幅」を計算し、出力に追加する。

**【変更前】**

Python

\# isclosed時の記録処理  
self.trades.append({  
    \# ...  
    'ストップロス価格': self.strategy.risk\_per\_share, \# 差分価格が出力されていた  
    'テイクプロフィット価格': tp\_price  
})

**【変更後】**

Python

\# src/backtest/run\_backtest.py \-\> class TradeList \-\> notify\_trade

\# 保存しておいたエントリー時の情報を取得  
entry\_info \= self.open\_trades.pop(trade.ref, {})  
tp\_price \= entry\_info.get('tp\_price', 0.0)  
sl\_price \= entry\_info.get('sl\_price', 0.0) \# sl\_price(実価格)を取得  
risk\_per\_share \= entry\_info.get('risk\_per\_share', 0.0)  
entry\_reason \= entry\_info.get('entry\_reason', 'N/A')

\# 目標利益幅を計算  
profit\_delta \= abs(tp\_price \- trade.price) if tp\_price \> 0 else 0.0

size \= abs(getattr(trade, 'executed\_size', 0))  
pnl \= trade.pnl  
exit\_price \= (trade.value \+ pnl) / size if size \> 0 else trade.price

self.trades.append({  
    '銘柄': self.symbol, '方向': 'BUY' if trade.long else 'SELL', '数量': size,  
    'エントリー価格': trade.price, 'エントリー日時': bt.num2date(trade.dtopen).replace(tzinfo=None).isoformat(),  
    'エントリー根拠': entry\_reason,  
    '決済価格': exit\_price, '決済日時': bt.num2date(trade.dtclose).replace(tzinfo=None).isoformat(),  
    '決済根拠': "Take Profit" if trade.pnlcomm \>= 0 else "Stop Loss",  
    '損益': trade.pnl, '損益(手数料込)': trade.pnlcomm,  
    'ストップロス価格': sl\_price,  \# 実価格に変更  
    'テイクプロフィット価格': tp\_price,  
    '許容損失幅': risk\_per\_share, \# 新設  
    '目標利益幅': profit\_delta    \# 新設  
})

##### **3.1.3. stop メソッド**

バックテスト終了時に未決済ポジションを記録する処理。こちらも新しい列に合わせて項目を追加する。

**【変更前】**

Python

\# stop時の記録処理  
self.trades.append({  
    \# ...  
    'ストップロス価格': self.strategy.risk\_per\_share,  
    'テイクプロフィット価格': self.strategy.tp\_price  
})

**【変更後】**

Python

\# src/backtest/run\_backtest.py \-\> class TradeList \-\> stop

\# 目標利益幅を計算  
profit\_delta \= abs(self.strategy.tp\_price \- entry\_price) if self.strategy.tp\_price \> 0 else 0.0

self.trades.append({  
    \# ...（損益(手数料込)まで同じ）...  
    'ストップロス価格': self.strategy.sl\_price, \# 実価格に変更  
    'テイクプロフィット価格': self.strategy.tp\_price,  
    '許容損失幅': self.strategy.risk\_per\_share, \# 新設  
    '目標利益幅': profit\_delta                    \# 新設  
})

#### **3.2. main 関数の修正**

CSVのヘッダーを定義している TRADE\_HISTORY\_COLUMNS リストに、新設する2列を追加する。

**【変更前】**

Python

TRADE\_HISTORY\_COLUMNS \= \[  
    '銘柄', '方向', '数量', 'エントリー価格', 'エントリー日時', 'エントリー根拠',  
    '決済価格', '決済日時', '決済根拠', '損益', '損益(手数料込)',  
    'ストップロス価格', 'テイクプロフィット価格'  
\]

**【変更後】**

Python

\# src/backtest/run\_backtest.py \-\> main

TRADE\_HISTORY\_COLUMNS \= \[  
    '銘柄', '方向', '数量', 'エントリー価格', 'エントリー日時', 'エントリー根拠',  
    '決済価格', '決済日時', '決済根拠', '損益', '損益(手数料込)',  
    'ストップロス価格', 'テイクプロフィット価格',  
    '許容損失幅', '目標利益幅'  \# 2列を追加  
\]

---

### **4\. 変更後のCSV出力イメージ**

| ... | ストップロス価格 | テイクプロフィット価格 | 許容損失幅 | 目標利益幅 |
| :---- | :---- | :---- | :---- | :---- |
| ... | 2200.50 | 2280.50 | 30.00 | 50.00 |
| ... | 1585.20 | 1525.20 | 25.00 | 35.00 |

以上が詳細設計となります。この内容で実装を進めてください。