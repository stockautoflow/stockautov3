はい、承知いたしました。  
現在の「決済価格」列を「一株当たり損益」に改名し、新たに「決済価格（実価格）」を追加するための詳細設計書を作成します。

---

## **バックテスト結果出力改善 詳細設計書 (決済価格対応)**

### **1\. 概要**

バックテスト結果のCSVファイル（trade\_history.csv）の決済関連項目の分かりやすさと正確性を向上させる。

1. **「決済価格」列を「一株当たり損益」に改名し、その内容を1株あたりの損益額とする。**  
2. **新たに「決済価格」列を設け、実際の決済が行われた価格（実価格）を出力する。**

これにより、レポートから「いくらでエントリーし、いくらで決済され、結果として1株あたりいくらの損益が出たか」が一目瞭然となる。

---

### **2\. 変更対象ファイル**

* src/backtest/run\_backtest.py

---

### **3\. 詳細設計**

#### **3.1. TradeList アナライザーの修正**

##### **3.1.1. notify\_trade メソッド**

決済済みトレードの情報を記録する処理を修正する。

**【ロジック】**

1. trade.pnl（トレードの総損益）と size（株数）から、「一株当たり損益」を計算する。  
2. trade.price（エントリー価格）と算出した「一株当たり損益」から、「決済価格（実価格）」を計算する。  
3. self.trades.append で、新しい列構成に合わせてデータを追加する。

**【実装】**

Python

\# src/backtest/run\_backtest.py \-\> class TradeList \-\> notify\_trade

\# ... (entry\_infoの取得までは変更なし) ...

size \= abs(getattr(trade, 'executed\_size', 0))  
pnl \= trade.pnl

\# 1\. 「一株当たり損益」と「決済価格(実価格)」を計算  
per\_share\_pnl \= pnl / size if size \> 0 else 0.0  
actual\_exit\_price \= trade.price \+ per\_share\_pnl

self.trades.append({  
    '銘柄': self.symbol, '方向': 'BUY' if trade.long else 'SELL', '数量': size,  
    'エントリー価格': trade.price, 'エントリー日時': bt.num2date(trade.dtopen).replace(tzinfo=None).isoformat(),  
    'エントリー根拠': entry\_reason,  
    '決済価格': actual\_exit\_price,  \# ★ 新設：実価格  
    '決済日時': bt.num2date(trade.dtclose).replace(tzinfo=None).isoformat(),  
    '決済根拠': "Take Profit" if trade.pnlcomm \>= 0 else "Stop Loss",  
    '一株当たり損益': per\_share\_pnl, \# ★ 新設(旧「決済価格」列)  
    '損益': pnl,  
    '損益(手数料込)': trade.pnlcomm,  
    'ストップロス価格': sl\_price,  
    'テイクプロフィット価格': tp\_price,  
    '許容損失幅': risk\_per\_share,  
    '目標利益幅': profit\_delta  
})

##### **3.1.2. stop メソッド**

バックテスト終了時に未決済だったポジションの情報を記録する処理を修正する。

**【ロジック】**

1. 最終価格（exit\_price）とエントリー価格から、「一株当たり損益」を計算する。  
2. self.trades.append で、新しい列構成に合わせてデータを追加する。

**【実装】**

Python

\# src/backtest/run\_backtest.py \-\> class TradeList \-\> stop

\# ... (pnl, commissionの計算までは変更なし) ...

\# 1\. 「一株当たり損益」を計算  
per\_share\_pnl \= (exit\_price \- entry\_price) \* (1 if size \> 0 else \-1)

\# 目標利益幅を計算  
profit\_delta \= abs(self.strategy.tp\_price \- entry\_price) if self.strategy.tp\_price \> 0 else 0.0

self.trades.append({  
    \# ... (エントリー根拠までは変更なし) ...  
    '決済価格': exit\_price, \# ★ 新設：実価格  
    '決済日時': self.strategy.data.datetime.datetime(0).isoformat(),  
    '決済根拠': "End of Backtest",  
    '一株当たり損益': per\_share\_pnl, \# ★ 新設  
    '損益': pnl,  
    '損益(手数料込)': pnl \- commission,  
    \# ... (以降の項目は変更なし) ...  
})

#### **3.2. main 関数の修正**

CSVヘッダーを定義している TRADE\_HISTORY\_COLUMNS リストを、新しい列構成に合わせて変更する。

**【変更前】**

Python

TRADE\_HISTORY\_COLUMNS \= \[  
    '銘柄', '方向', '数量', 'エントリー価格', 'エントリー日時', 'エントリー根拠',  
    '決済価格', '決済日時', '決済根拠', '損益', '損益(手数料込)',  
    'ストップロス価格', 'テイクプロフィット価格',  
    '許容損失幅', '目標利益幅'  
\]

**【変更後】**

Python

\# src/backtest/run\_backtest.py \-\> main

TRADE\_HISTORY\_COLUMNS \= \[  
    '銘柄', '方向', '数量', 'エントリー価格', 'エントリー日時', 'エントリー根拠',  
    '決済価格', '決済日時', '決済根拠',  
    '一株当たり損益', '損益', '損益(手数料込)',  
    'ストップロス価格', 'テイクプロフィット価格',  
    '許容損失幅', '目標利益幅'  
\]

*(順序を分かりやすく整理しました)*

---

### **4\. 変更後のCSV出力イメージ**

| エントリー価格 | ... | 決済価格 | 決済日時 | ... | 一株当たり損益 | 損益 |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- |
| 3015.0 | ... | **3016.9** | .../... | ... | **1.9** | 188.95 |
| 2223.0 | ... | **2217.16** | .../... | ... | **\-5.84** | \-785.41 |

以上で、レポートの正確性と可読性が大幅に向上します。