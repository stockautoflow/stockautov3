はい、承知いたしました。
Eメール通知機能に関する、これまでの内容をすべて反映した最新版の詳細設計書を以下に提示します。

-----

## Eメール通知機能 詳細設計書 (最終版)

### 1\. 概要

本設計書は、リアルタイム取引システムにおいて、注文ライフサイクル上の重要なイベント（新規発注、約定、失敗、決済など）が発生した際に、指定されたアドレスへEメールで通知する機能の実現方法を定義します。

  * **目的**: システムの稼働状況をリモートで監視し、重要な取引イベントを見逃さないようにする。
  * **対象範囲**: `src/core/strategy.py` に定義されている `DynamicStrategy` クラスの改修を主とする。

-----

### 2\. 設計方針

  * **通知処理の集約**: `DynamicStrategy` クラス内に、Eメール通知を専門に扱うプライベートメソッド `_send_notification` を新設し、通知処理をカプセル化します。
  * **非同期処理**: Eメール送信処理が取引のメインスレッドをブロックしないよう、`threading`モジュールを用いて別スレッドでメール送信を実行します。
  * **既存機能の活用**: Eメール送信のコア機能は、既存の `src/core/util/notifier.py` の `send_email` 関数をそのまま利用します。

-----

### 3\. 変更仕様

#### 3.1. 対象モジュール

  * `src/core/strategy.py`

#### 3.2. クラス設計: `DynamicStrategy`

##### 3.2.1. インポートの追加

`strategy.py` の先頭に、`threading` モジュールと自作の `notifier` モジュールをインポートします。

```python
import threading
from .util import notifier
```

##### 3.2.2. 新規メソッドの追加

`DynamicStrategy` クラス内に以下のプライベートメソッドを新設します。

  * **`_send_notification(self, subject, body)`**
      * **機能**: Eメールの件名と本文を引数として受け取り、`notifier.send_email` 関数をバックグラウンドで実行します。これにより、メール送信の遅延が取引処理に影響を与えるのを防ぎます。
      * **実装**:
        ```python
        def _send_notification(self, subject, body):
            try:
                self.log(f"メール通知送信: {subject}")
                thread = threading.Thread(
                    target=notifier.send_email,
                    args=(subject, body)
                )
                thread.start()
            except Exception as e:
                self.log(f"メール通知スレッドの開始に失敗: {e}")
        ```

##### 3.2.3. 既存メソッドの修正

  * **`_evaluate_condition`**

      * **変更点**: 戻り値を `(bool, str)` のタプルに変更します。
      * **目的**: 条件判定時に使用したインジケーターの実際の値を、理由を示す文字列に含めて返却します。
      * **戻り値**:
          * `bool`: 条件判定の結果 (True/False)
          * `str`: 条件式と、その時点での実際の値を含む詳細な理由文字列。（例: `"M: rsi(14) [48.51] < [50]"`)

  * **`_check_all_conditions`**

      * **変更点**: `_evaluate_condition` から返された詳細な理由文字列を収集し、結合します。
      * **目的**: エントリー条件がすべて満たされた場合に、全条件の詳細な理由文字列を改行で連結して返します。
      * **戻り値**: `(bool, str)` のタプル。`str`はエントリー根拠の全文です。

  * **`_check_entry_conditions`** (内部の `place_order` ロジック)

      * **変更点**: 新規注文（エントリー）が発注された際に `_send_notification` を呼び出します。
      * **目的**: 新規注文の内容と、その根拠となった各指標の実際の値を通知します。

  * **`notify_order`**

      * **変更点**: 注文ステータスを判定するロジックを拡張し、エントリー注文と決済注文の両方の約定・失敗をハンドリングします。
      * **目的**: すべての注文の最終ステータス（約定、決済完了、失敗）を通知します。決済完了時には損益情報も付与します。

-----

### 4\. 通知メールのサンプル

#### 4.1. 新規注文（エントリー）

**タイミング**: 新規の買いまたは売り注文がシステムから発注された時。

```
件名: 【リアルタイム取引】新規注文発注 (7203)

日時: 2025-07-28T10:30:00
銘柄: 7203
戦略: 1. SMA + RSI + EMAクロス (基本形)
方向: BUY
数量: 100.00

--- エントリー根拠詳細 ---
L: sma(period=75) [3450.12] < close [3501.50]
M: rsi(period=14) [48.51] < [50]
S: crossover(ema(10),ema(25)) [True]
```

#### 4.2. 注文約定（エントリー）

**タイミング**: 4.1で発注したエントリー注文が取引所で約定した時。

```
件名: 【リアルタイム取引】エントリー注文約定 (7203)

日時: 2025-07-28T10:30:05
銘柄: 7203
ステータス: Completed
方向: BUY
約定数量: 100.00
約定価格: 3502.00
```

#### 4.3. 決済完了（Take Profit）

**タイミング**: 保有ポジションが利益となり、利確注文が約定した時。

```
件名: 【リアルタイム取引】決済完了 - Take Profit (7203)

日時: 2025-07-29T11:05:00
銘柄: 7203
ステータス: Completed (Take Profit)
方向: 決済SELL
決済数量: 100.00
決済価格: 3650.00
実現損益: +14,800.00
```

#### 4.4. 決済完了（Stop Loss）

**タイミング**: 保有ポジションが損失となり、損切注文が約定した時。

```
件名: 【リアルタイム取引】決済完了 - Stop Loss (7203)

日時: 2025-07-30T14:15:00
銘柄: 7203
ステータス: Completed (Stop Loss)
方向: 決済SELL
決済数量: 100.00
決済価格: 3480.00
実現損益: -2,200.00
```

#### 4.5. 注文失敗

**タイミング**: 発注した注文が取引所に拒否された、またはキャンセルされた時。

```
件名: 【リアルタイム取引】注文失敗/キャンセル (7203)

日時: 2025-07-28T10:40:00
銘柄: 7203
ステータス: Rejected
```

-----

### 5\. 有効化の方法

1.  `config/email_config.yml` ファイルを開き、ご自身のメールアカウント情報（SMTPサーバー、ユーザー名、アプリパスワード等）を正しく設定します。
2.  同ファイル内の `ENABLED` フラグを `True` に変更します。

以上が、ご要望をすべて反映したEメール通知機能の詳細設計書です。