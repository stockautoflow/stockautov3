はい、承知いたしました。  
緊急通知の信頼性に関するご懸念は、システムの安定運用において非常に重要です。その点を踏まえ、仕様を更新し、基本仕様書を再作成いたします。

### **緊急通知の信頼性に関する回答**

#### **Q1. 緊急通知でもメール流量制限に掛かり、送信されないことはありますか？**

**はい、その可能性はあります。**

ご指摘の通り、複数のエントリー条件がほぼ同時に成立した場合など、短時間に緊急通知が連続して発生すると、たとえ待機時間を短くしてもメールサーバーの流量制限（レート制限）に抵触し、メールがブロックされたり、送信が失敗したりするリスクは残ります。

ネットワークの一時的な不具合やメールサーバー側の問題など、流量制限以外にもメール送信が失敗する要因は存在します。そのため、「メールが確実に相手に届くこと」を100%保証することはできません。

#### **Q2. メールが送信されなかった場合に、通知内容を確認する方法は？**

このリスクに対応するため、**「メール送信の試み」そのものを記録する専用の通知ログ**を導入します。

万が一メールが届かなかった場合でも、このログファイルを確認することで、「いつ、どのような内容の通知が、どのような理由で失敗したか」を正確に把握できます。これにより、重要な取引機会に関する情報を失うことがなくなります。

---

### **メール通知機能仕様書 (Ver. 3.0)**

#### **1\. 概要**

本システムにおけるメール通知機能の仕様を定義する。この機能は、システムの重要イベントを運用者に通知することを目的とする。

本仕様では、通知の**信頼性**と**監査性**を確保するため、メール送信処理そのものに加えて、**すべての通知試行を記録する専用のログ機能**を導入する。

#### **2\. 機能要件**

##### **2.1. 通知の有効化・無効化**

* **リアルタイム取引:** メール通知機能と通知ログ機能を**有効**にする。  
* **バックテスト:** メール通知機能と通知ログ機能を**無効**にする。

##### **2.2. 通知ログ (Notification Log)**

* **目的:**  
  * システムが送信を試みたすべての通知内容とその成否を記録する。  
  * メール送信が失敗した場合の、内容確認および原因調査を可能にする。  
* **ファイル形式:**  
  * notification\_history.csv (CSV形式)  
* **保存場所:**  
  * log/ ディレクトリ配下  
* 記録項目 (カラム):  
  | カラム名 | 説明 | 例 |  
  |:---|:---|:---|  
  | timestamp | 通知イベントが発生した日時 | 2025-08-15 10:30:01 |  
  | priority | 通知の優先度 | URGENT または NORMAL |  
  | recipient | 送信先メールアドレス | user@example.com |  
  | subject | メールの件名 | 【緊急】エントリー注文約定 (7203) |  
  | body | メールの本文 | 日時: 2025-08-15... |  
  | status | 送信結果 | SUCCESS または FAILED |  
  | error\_message | 送信失敗時のエラー内容 | (550, b'5.4.5 Daily user sending quota exceeded...)\` |

##### **2.3. リアルタイム取引時の通知仕様**

リアルタイム取引実行時は、イベントの緊急性に応じて2種類の送信方式を使い分ける。

* **緊急通知 (URGENT)**  
  * **対象イベント:**  
    * 新規エントリー注文の発注時  
    * 注文の約定時 (エントリー/イグジット)  
    * 注文の失敗、キャンセル、または拒否時  
  * **処理フロー:**  
    1. 通知内容を**通知ログ**に記録 (statusはPENDING)。  
    2. 優先キューに通知リクエストを登録する。  
    3. メール送信ワーカースレッドが即座にリクエストを取得し、送信を試みる。  
    4. 送信成否に応じて、**通知ログ**のstatusとerror\_messageを更新する。  
* **通常通知 (NORMAL)**  
  * **対象イベント:**  
    * システムのクリティカルエラー発生時など、即時性が求められないアラート。  
  * **処理フロー:**  
    1. 通知内容を**通知ログ**に記録 (statusはPENDING)。  
    2. 通常キューに通知リクエストを登録する。  
    3. ワーカースレッドが順次リクエストを取得し、一定の待機時間（例: 2秒）を設けて送信を試みる。  
    4. 送信成否に応じて、**通知ログ**のstatusを更新する。

##### **2.4. バックテスト時の通知仕様**

* バックテスト実行時は、メール通知および通知ログへの記録処理を**すべて行わない。**

---

#### **3\. 実装方針**

##### **3.1. 通知管理モジュール (src/core/util/notifier.py)**

* **通知ログ書き込み機能の追加:**  
  * pandas または csv ライブラリを使用し、指定されたフォーマットでlog/notification\_history.csvに追記する機能を実装する。  
* **\_email\_workerの改修:**  
  * メール送信前に、必ず通知ログへの書き込みを行う。  
  * メール送信の try-except ブロックを強化し、成功時・失敗時に必ずログのステータスを更新するように変更する。

##### **3.2. 戦略モジュール (src/core/strategy.py)**

* \_send\_notification メソッドを改修。  
  * self.live\_trading フラグが False の場合は、メール送信もログ記録も行わずに処理を終了するロジックを維持する。

---

#### **4\. 改訂履歴**

| バージョン | 改訂日 | 改訂内容 |
| :---- | :---- | :---- |
| 1.0 | 2025/08/14 | 初版作成。 |
| 2.0 | 2025/08/15 | バックテスト時のメール通知無効化仕様を追加。 |
| 3.0 | 2025/08/15 | 通知の信頼性確保のため、専用の**通知ログ機能**を追加。緊急通知の失敗リスクと、その確認方法を仕様に明記。 |

