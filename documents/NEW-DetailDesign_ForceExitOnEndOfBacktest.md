# **実装仕様書：ネイティブOCO注文と最終日強制決済**

## **1\. 目的**

本改修の目的は、以下の2点を達成することです。

1. **「幽霊トレード」の撲滅**: 現在の手動OCO注文方式をやめ、Backtraderに標準搭載されている**ネイティブOCO注文**に切り替える。これにより、決済注文の競合（レースコンディション）を防ぎ、意図しないドテン売買（幽霊トレード）の発生を根本的に解決する。  
2. **最終トレードの正確な記録**: バックテスト期間の終了時点で未決済のまま残ったポジションを、最終足の終値で**強制決済**し、その結果を「決済根拠: End of Backtest」として取引履歴レポートに正確に記録する。

## **2\. 改修方針**

上記目的を達成するため、以下の2つの主要な改修を行います。

* **btrader\_strategy.pyの改修**: 注文管理の心臓部を、信頼性の高いBacktraderネイティブのOCO注文方式に全面的に移行します。ATRトレーリングストップのロジックも、この新しい注文方式に合わせて調整します。  
* **run\_backtrader.pyの改修**: TradeListアナライザーに、バックテスト終了時の未決済ポジションを捕捉し、レポートに記録するためのロジック（stop()メソッド）を追加します。

## **3\. 実装仕様詳細**

### **3.1. btrader\_strategy.py の改修**

#### **3.1.1. 決済注文の発注方式の変更 (notify\_orderメソッド)**

エントリー注文が約定した際のロジックを、ネイティブOCO注文方式に変更します。

* **変更前**: self.sellやself.buyを2回呼び出し、limit\_orderとstop\_orderを個別に発注していた。  
* **変更後**:  
  1. self.buy()またはself.sell()を\*\*ocoパラメータ付きで\*\*呼び出します。  
  2. 利確注文と損切り注文をリストとして生成し、エントリー注文（buy or sell）に渡します。これにより、2つの決済注文は1つのグループとして扱われ、Backtraderエンジンが自動的に「一方が約定すれば、もう一方はキャンセル」という動作を保証します。  
  3. この変更により、notify\_order内での複雑な決済注文のキャンセル処理が不要になり、コードがシンプルかつ堅牢になります。

**実装イメージ:**

\# notify\_order内での変更イメージ

\# ロングポジションの場合  
elif self.position.size \> 0:  
    \# 決済注文をリストで作成  
    sl\_order \= self.sell(exectype=bt.Order.Stop, price=self.initial\_sl\_price, transmit=False)  
    tp\_order \= self.sell(exectype=bt.Order.Limit, price=self.tp\_price, transmit=False)  
    \# ocoパラメータでグループ化して送信  
    self.sell(oco=sl\_order, size=self.position.size, exectype=bt.Order.Limit, price=self.tp\_price)  
      
    \# 変数には参照を保持しておく  
    self.stop\_order \= sl\_order  
    self.limit\_order \= tp\_order

#### **3.1.2. ATRトレーリングストップのロジック変更 (nextメソッド)**

ストップ価格を更新する際のロジックを、新しいOCOの仕組みに合わせて変更します。

1. 新しい損切り価格（new\_stop\_price）を計算するロジックは既存のまま流用します。  
2. new\_stop\_priceが現在のストップ価格より有利な場合、以下の処理を行います。  
   a. 既存のOCO注文グループをキャンセル: self.broker.cancel(self.limit\_order) または self.broker.cancel(self.stop\_order)を実行します（どちらか一方のキャンセルでグループ全体がキャンセルされます）。  
   b. 新しいOCO注文グループを発注: 新しい損切り価格と、元の利確価格を使い、3.1.1と同様のネイティブOCO注文を再度発注します。

### **3.2. run\_backtrader.py の改修**

#### **3.2.1. TradeListアナライザーへのstopメソッド追加**

TradeListクラスにstop()メソッドを実装します。このメソッドは、バックテストの全処理が完了した直後に一度だけ呼び出されます。

#### **3.2.2. 最終ポジションの記録ロジック (stopメソッド内)**

stop()メソッド内に以下のロジックを実装します。

1. if self.strategy.position.size \!= 0: で、未決済ポジションが存在するかを確認します。  
2. 存在する場合、以下の情報を取得・計算します。  
   * **エントリー情報**: self.strategy.positionオブジェクトからエントリー価格や日時を取得。  
   * **決済価格**: 最終足の終値 (self.strategy.data.close\[0\]) を使用。  
   * **損益（pnl, pnlcomm）**: 最終決済価格を基に手動で計算します。  
3. 計算した情報を基に取引記録を生成し、self.tradesリストに追加します。その際、決済根拠カラムには\*\*"End of Backtest"\*\*という固定文字列を設定します。

## **4\. 期待される効果**

* **信頼性の向上**: 注文管理がBacktraderの堅牢な仕組みに委譲され、幽霊トレードが発生しなくなります。  
* **正確性の向上**: バックテスト終了時の未決済ポジションが、正しいエントリー情報と損益と共にレポートに記録されるようになります。  
* **整合性の確保**: 手数料・スリッページが0の場合、「損益」と「損益(手数料込)」が完全に一致するようになります。

以上が、ご提示いただいた最新のコードを基に「アプローチB」を実装するための仕様です。  
この仕様にご同意いただけましたら、具体的なコード修正に着手いたします。