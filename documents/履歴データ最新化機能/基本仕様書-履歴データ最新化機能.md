承知いたしました。
「再起動方式」の要となる、**当日データのCSV保存（履歴データ最新化）** に関する基本仕様書を作成します。

この機能により、毎朝の再起動時に「昨日の15:30までの完全なデータ」が読み込まれ、インジケーターが正しく計算（ウォームアップ）されるようになります。

---

# 基本仕様書: 履歴データ最新化機能 (Historical Data Updater)

**プロジェクト:** StockAutoV3  
**作成日:** 2025/11/25  
**バージョン:** 1.0  
**対象コンポーネント:** `realtrade` パッケージ (`RakutenData`, `RealtimeTrader`)

## 1. 改修の目的

本改修は、システム再起動時（毎朝09:00）における**インジケーター計算の連続性を保証する**ことを目的とする。

* **現状の課題:** リアルタイムトレードで生成された足データ（5分足など）がメモリ上にしか存在せず、システム停止（15:30）とともに消失する。そのため、翌日の再起動時に「前日のデータ」が欠落し、テクニカル指標が正しく計算できない。
* **解決策:** 1日の取引終了時（システム停止直前）に、メモリ上に蓄積された当日の確定足を、既存の履歴CSVファイルに追記保存する機能を実装する。

## 2. 機能要件

### 2.1. データの蓄積 (In-Memory Accumulation)
* **対象データ:** リアルタイム稼働中に生成された「確定した足（Completed Bars）」。
    * ※ 形成中の足（Tick更新ごとの変動データ）は対象外とする。
* **蓄積場所:** `RakutenData` クラス内部にリスト形式で保持する。
* **データ項目:** 日時, 始値, 高値, 安値, 終値, 出来高, 建玉（0固定）。

### 2.2. データの保存 (Persisting to Disk)
* **実行タイミング:** `RealtimeTrader.stop()` が呼ばれた際（市場クローズ時、または強制終了時）。
* **保存先:** `data/` ディレクトリ内の、各銘柄に対応する既存CSVファイル。
    * ファイル名規則: `{symbol}_{compression}m_{year}.csv` (例: `1357_5m_2023.csv`)
    * ※ ファイルが存在しない場合は新規作成する（今回は既存ファイルへの追記を主とする）。

### 2.3. 重複排除と整合性 (Idempotency)
* **重複防止:** 既にCSVに記録されている日時と同じデータがメモリにある場合、重複して書き込まないように制御する。
    * ロジック: 既存CSVを読み込み -> メモリ上のデータを結合 -> `datetime` をキーに重複排除 -> 再保存。
* **ソート:** 保存時は必ず日時順（昇順）にソートされていること。

## 3. 処理フロー

1.  **起動時 (`RakutenData` 初期化):**
    * 既存のCSVから過去データをロードする（既存機能）。
    * 当日の生成データを保持するための空リスト `_new_bars` を初期化する。

2.  **稼働中 (`RakutenData._load`):**
    * `BarBuilder` から新しい確定足（`completed_bar`）が返されるたびに、`_new_bars` リストに追加する。
    * ログに「バー完成: {時刻}」を出力する。

3.  **停止時 (`RealtimeTrader.stop` -> `RakutenData.save_history`):**
    * 全ての `RakutenData` インスタンスに対して保存メソッドを呼び出す。
    * 各インスタンスは `_new_bars` が空でなければ、対象のCSVファイルに対して追記・保存処理を行う。
    * 保存完了後、ログに「{銘柄}: {件数}件のデータを保存しました」と出力する。

## 4. データフォーマット仕様

Backtrader標準のCSV形式に準拠する。

| カラム名 | 型 | 例 | 備考 |
| :--- | :--- | :--- | :--- |
| `datetime` | String | `2025-11-25 09:05:00` | YYYY-MM-DD HH:MM:SS |
| `open` | Float | `1500.0` | |
| `high` | Float | `1510.0` | |
| `low` | Float | `1490.0` | |
| `close` | Float | `1505.0` | |
| `volume` | Float | `12000` | 整数または浮動小数点 |
| `openinterest` | Float | `0` | 基本的に0 |

## 5. 影響範囲

* **修正:** `src/realtrade/rakuten/rakuten_data.py`
    * `__init__`: バッファリストの初期化。
    * `_load`: 確定足の蓄積ロジック追加。
    * `save_history` (新規メソッド): CSV書き込みロジックの実装。
* **修正:** `src/realtrade/run_realtrade.py` (または `RealtimeTrader` クラス)
    * `stop()` メソッド内で、データフィードの `save_history()` を呼び出す処理を追加。
* **構成:** `CerebroFactory`
    * データフィード作成時に、保存先のファイルパス（または命名規則）を `RakutenData` に伝達する必要があるか検討する。
    * 現状の `glob` 検索ロジックを利用し、`RakutenData` 自身が保存すべきファイルを特定できるようにする。

---

以上が履歴データ最新化機能の基本仕様書となります。
ご確認いただき、問題がなければ **２，詳細設計書の作成（MD形式）** へ進みます。