# **株価自動トレードシステム 仕様書**

## **1\. 概要**

本システムは、バックテスト、戦略評価、リアルタイム取引の機能を統合した、多戦略・多時間軸対応の株価自動トレードシステムである。バックテストによる網羅的な戦略評価の結果に基づき、各銘柄に最適な取引戦略を動的に割り当て、リアルタイムでの自動売買を実行することを目的とする。

## **2\. システム構成**

本システムは、責務に応じて分割された以下の主要パッケージから構成される。

| パッケージ名 | 役割 | 主要技術/ライブラリ |
| :---- | :---- | :---- |
| **src/core** | 取引戦略、インジケーター、データ供給など、システムの核となる共通ロジックを提供。 | Backtrader |
| **src/backtest** | 史実データ(CSV)を用いた単一戦略のバックテスト機能を提供。 | Backtrader, Pandas |
| **src/evaluation** | strategy\_catalog.ymlに定義された全戦略のバックテストを自動実行し、結果を集計・評価する。 | Pandas, YAML |
| **src/realtrade** | 評価結果に基づき、リアルタイムデータでの自動取引を実行する。 | Backtrader, yfinance, SQLite |
| **src/dashboard** | バックテスト結果を可視化するためのWebベースのダッシュボード機能を提供。 | Flask, Plotly |

## **3\. 主要コンポーネント詳細**

### **3.1. コア (src/core)**

#### **3.1.1. 取引戦略 (strategy.py)**

* **DynamicStrategy クラス**:  
  * YAMLファイルから取引ロジックを動的に読み込み、柔軟な戦略変更を可能にする。  
  * 長期・中期・短期の3つの時間軸のデータをハンドリングし、複合的な条件での判断を行う。  
  * **リスク管理**: ATR(アベレージ・トゥルー・レンジ)に基づき、損切り(Stop-Loss)と利確(Take-Profit)の価格を動的に計算する。  
  * **堅牢化ロジック**:  
    1. **取引開始制御**: 履歴データの読み込み完了後にのみ取引を開始するフラグ(live\_trading\_started)制御を導入。これにより、起動直後の履歴データに対する意図しない大量発注を防止する。  
    2. **出来高ゼロの無視**: 出来高がゼロのデータ（取引時間外のダミーデータ等）では取引判断を行わない。これにより、ATR値の汚染を防ぎ、不適切なサイズの注文生成を抑制する。

#### **3.1.2. カスタムインジケーター (indicators.py)**

* 標準のBacktraderインジケーターに加え、システムの安定性を高めるためのカスタムインジケーターを実装。  
  * **SafeADX**: 外部インジケーターに依存しない自己完結型のADX。計算の正確性と堅牢性を両立。  
  * **SafeStochastic**: 高値と安値が同値の場合に発生するゼロ除算エラーを回避するストキャスティクス。  
  * **VWAP**: 日中取引で重要となる出来高加重平均価格。日足が変わるとリセットされる。

#### **3.1.3. データ準備 (data\_preparer.py)**

* バックテスト（CSV）とリアルタイム取引（ライブデータ）の両方に対応したデータフィード設定機能。  
* 短期データから中期・長期データを生成するリサンプリング機能を持つ。

### **3.2. リアルタイムトレード (src/realtrade)**

#### **3.2.1. 実行エンジン (run\_realtrade.py)**

* **マルチスレッドアーキテクチャ**: 取引対象の銘柄ごとに独立したスレッドを生成し、並列で取引を実行する。  
* **動的戦略割り当て**: evaluationパッケージが出力した推奨戦略ファイル(all\_recommend\_\*.csv)を起動時に読み込み、各銘柄に最適な戦略を自動で割り当てる。

#### **3.2.2. データ供給 (live/yahoo\_data.py, live/yahoo\_store.py)**

* **データソース**: yfinanceライブラリを介してYahoo Financeからリアルタイム株価データを取得する。  
* **データ汚染対策**:  
  * yfinanceが複数スレッドからの同時リクエスト時に他銘柄のデータを混在させて返す問題を特定し、これに対処するロジックを実装。  
  * データ取得後、必ず自スレッドが担当する銘柄のデータのみを抽出し、他の不要なデータを破棄することで、戦略が誤った価格情報に基づいて判断することを完全に防止する。  
* **ハートビート機能**: 取引時間外など、新しい価格データが供給されない場合でもシステムが停止しないよう、出来高ゼロのダミーデータを定期的に供給する。

#### **3.2.3. 状態管理 (state\_manager.py)**

* **永続化**: 現在保有中のポジション情報をSQLiteデータベースに記録する。  
* **スレッドセーフ**: threading.Lockを用いてデータベースへのアクセスを排他制御し、複数スレッドからの同時書き込みによるデータ破損を防止する。  
* **目的**: システムの再起動時にポジション情報を復元する機能（フェーズ3.4）の基盤となる。

## **4\. 設定ファイル仕様**

システムの挙動は、コードの変更なしに以下のYAMLファイルで制御される。

* **config/strategy\_base.yml**:  
  * 全ての戦略の基礎となるテンプレート。  
  * 利確・損切りロジック、資金管理（1トレードあたりのリスク率）、データ読み込み設定など、共通のパラメータを定義する。  
* **config/strategy\_catalog.yml**:  
  * 様々なエントリー条件の組み合わせを「戦略」としてカタログ化したもの。  
  * evaluationモジュールは、ここに定義された全戦略の優位性を評価する。  
* **config/config\_realtrade.py, config\_backtest.py**:  
  * 初期資金、APIキー、ログレベルなど、各動作モードのシステム全体に関わる設定を定義する。

## **5\. データフロー**

1. **評価フェーズ**:  
   * run\_evaluation.pyがstrategy\_catalog.ymlの全戦略をbacktestモジュールで実行。  
   * 結果はresults/evaluation/に集約され、最終的に銘柄ごとの最適戦略を記したall\_recommend\_\*.csvが出力される。  
2. **リアルタイム取引フェーズ**:  
   * run\_realtrade.pyがall\_recommend\_\*.csvを読み込み、取引対象銘柄と戦略を決定。  
   * yahoo\_store.pyが起動時の履歴データを取得。  
   * yahoo\_data.pyがリアルタイムデータを取得し、戦略に供給。  
   * 戦略(strategy.py)が売買を判断し、注文を実行。  
   * 約定したポジションはstate\_manager.pyによってデータベースに記録される。

## **6\. 実行方法**

システムの操作は、ルートディレクトリのmain.pyを介して行う。

| コマンド | エイリアス | 説明 |
| :---- | :---- | :---- |
| python main.py generate all | ga | 全てのコンポーネントを生成・更新する。 |
| python main.py run backtest | rb | 単一戦略でのバックテストを実行する。 |
| python main.py run evaluation | re | 全戦略の評価を実行する。 |
| python main.py run realtrade | rr | リアルタイム自動取引を開始する。 |
| python main.py run dashboard | rd | 結果可視化ダッシュボードを起動する。 |

