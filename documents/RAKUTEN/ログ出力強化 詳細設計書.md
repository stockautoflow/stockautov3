はい、承知いたしました。
リアルタイム取引におけるバグ調査のため、価格データとインジケーターの値をログに出力する機能の強化について、以下の通り詳細設計書を作成します。

-----

## ログ出力強化 詳細設計書

### 1\. 目的

リアルタイム取引（楽天証券モード）において売買シグナルが生成されない問題の根本原因を調査するため、`backtrader`の戦略クラスが各タイムステップ（`next`メソッド実行時）で認識している価格データとインジケーターの値を詳細にログ出力する機能を実装する。

これにより、以下の点を明確に把握できるようになる。

  * 各時間足のデータが正しく`DynamicStrategy`に供給されているか。
  * 各インジケーターが期待通りに計算されているか。
  * エントリー条件の評価に使用される値が正しいか。

-----

### 2\. 対象ファイルとクラス

  * **対象ファイル**: `src/core/strategy.py`
  * **対象クラス**: `DynamicStrategy`

-----

### 3\. 修正箇所

  * **対象メソッド**: `next(self)`

`next`メソッドの冒頭に、ログ出力専用の処理ブロックを追加する。

-----

### 4\. 実装方針

  * ログの出力は、デバッグ時のみに限定できるよう、`logging.DEBUG`レベルで行う。これにより、`src/realtrade/config_realtrade.py` の `LOG_LEVEL` 設定を `logging.INFO` にすることで、本番運用時に詳細ログを抑制できる。
  * 出力するログは、現在のバーのタイムスタンプ、全時間足の価格情報、全インジケーターの値を含む。
  * 可読性を高めるため、ログメッセージをセクション（価格データ、インジケーター値）に分けて整形する。

-----

### 5\. ログ出力内容と実装詳細

`DynamicStrategy`クラスの`next`メソッドの先頭（`if len(self.data) == 0...` の直後）に、以下のロジックを追加する。

#### 5.1. ログ出力処理の追加

```python
# src/core/strategy.py の DynamicStrategy.next() メソッドに追加

def next(self):
    # --- ▼▼▼ ログ出力強化 ▼▼▼ ---
    # ログレベルがDEBUGの場合のみ、詳細情報を出力する
    if self.logger.isEnabledFor(logging.DEBUG):
        # 1. 現在のバーの日時をログのヘッダーとして出力
        log_msg = f"\\n===== Bar Check on {self.data.datetime.datetime(0).isoformat()} =====\\n"
        
        # 2. 価格データ（OHLCV）のログ出力
        log_msg += "--- Price Data ---\\n"
        for tf_name, data_feed in self.data_feeds.items():
            # データフィードにバーが存在するか確認
            if len(data_feed) > 0 and data_feed.close[0] is not None:
                dt = data_feed.datetime.datetime(0)
                log_msg += (f"  [{tf_name.upper():<6}] {dt.isoformat()} | "
                            f"O:{data_feed.open[0]:.2f} H:{data_feed.high[0]:.2f} "
                            f"L:{data_feed.low[0]:.2f} C:{data_feed.close[0]:.2f} "
                            f"V:{data_feed.volume[0]:.0f}\\n")
            else:
                log_msg += f"  [{tf_name.upper():<6}] No data available for this bar\\n"

        # 3. インジケーターの値のログ出力
        log_msg += "--- Indicator Values ---\\n"
        # ログの順序を固定するため、キーでソート
        sorted_indicator_keys = sorted(self.indicators.keys())
        for key in sorted_indicator_keys:
            indicator = self.indicators[key]
            # インジケーターが計算済みか確認
            if len(indicator) > 0 and indicator[0] is not None:
                # インジケーターの各ライン（出力値）の名前と値を動的に取得
                values = []
                for line_name in indicator.lines._getlinealias():
                    line = getattr(indicator.lines, line_name)
                    if len(line) > 0 and line[0] is not None:
                        values.append(f"{line_name}: {line[0]:.4f}")
                
                if values:
                    log_msg += f"  [{key}]: {', '.join(values)}\\n"
                else:
                    log_msg += f"  [{key}]: Value not ready\\n"
            else:
                log_msg += f"  [{key}]: Not calculated yet\\n"
        
        self.logger.debug(log_msg)
    # --- ▲▲▲ ログ出力強化ここまで ▲▲▲ ---
    
    if len(self.data) == 0 or not self.live_trading_started or self.data.volume[0] == 0:
        return
    
    # ... (以降の既存ロジック)
```

#### 5.2. ログレベルの設定

このログ出力を有効化するには、リアルタイム取引用の設定ファイルでログレベルを`DEBUG`に設定する必要がある。

  * **対象ファイル**: `src/realtrade/config_realtrade.py`
  * **変更内容**:
    ```python
    # 変更前
    # LOG_LEVEL = logging.INFO

    # 変更後
    LOG_LEVEL = logging.DEBUG 
    ```

-----

以上の実装により、`realtime_*.log` ファイルに各タイムステップでの詳細な内部状態が出力され、シグナル不発生の原因特定に役立つ情報が得られます。