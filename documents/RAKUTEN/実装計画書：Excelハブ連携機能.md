はい、承知いたしました。  
Excelハブ連携方式の詳細設計書に基づき、実装計画書を作成します。

---

## **実装計画書：Excelハブ連携機能**

### **1\. 概要**

本計画書は、詳細設計書で定義された「Excelハブ連携方式」を実装するための具体的な開発ステップとマイルストーンを定義するものです。開発は大きく4つのフェーズに分け、Excelとの連携基盤構築から始め、段階的にデータ取得、注文執行、そして全体の統合へと進めます。

### **2\. フェーズ1：基盤構築と手動テスト (目標期間: 1週間)**

**目標:** PythonとExcel間の基本的な通信を確立し、手動でのデータ読み書きが可能であることを確認する。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **1.1** | **Excelワークブック作成** | ・詳細設計書に基づき、trading\_hub.xlsmを作成する。 \<br\> ・リアルタイムデータシートと注文シートのレイアウトを定義する。 | ・RSS関数と注文インターフェースセルが設定されたExcelファイル。 |
| **1.2** | **Python環境設定** | ・xlwingsライブラリをインストールする。 | ・pip install xlwingsが完了している。 |
| **1.3** | **接続スクリプト作成** | ・Pythonからtrading\_hub.xlsmに接続し、特定のセル（例: リアルタイムデータシートのB2）を読み取るテストスクリプトを作成する。 | ・Pythonスクリプト実行時に、MS2で更新された株価がコンソールに出力される。 |
| **1.4** | **VBAマクロ実装** | ・OrderModuleに、注文シートのトリガーセルを監視してMS2の注文関数を呼び出すVBAマクロを実装する。 | ・Excelの注文シートに手動でパラメータを入力し、トリガーセルを変更すると、MS2で実際に注文が発注される。 |

### **3\. フェーズ2：データ取得機能の実装 (目標期間: 1週間)**

**目標:** バックグラウンドでリアルタイムデータを継続的に取得し、backtraderのデータフィードとしてシステムに供給できるようにする。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **2.1** | **ExcelBridgeデータ取得部の実装** | ・excel\_bridge.pyに、データ監視用のバックグラウンドスレッド (\_data\_loop) を実装する。 \<br\> ・最新データをキャッシュし、外部から取得するメソッド (get\_latest\_price, get\_cash) を実装する。 | ・ExcelBridgeインスタンスを起動すると、内部でデータが継続的に更新される。 |
| **2.2** | **RakutenDataの実装** | ・rakuten\_data.pyを作成する。 \<br\> ・\_loadメソッド内でExcelBridgeからデータを取得し、backtraderのラインオブジェクト (self.lines) を更新するロジックを実装する。 | ・backtraderのCerebroにRakutenDataを追加して実行すると、Excel経由のデータで動作する。 |
| **2.3** | **データフロー統合** | ・run\_realtrade.pyを修正し、ExcelBridgeを起動してRakutenDataに渡す処理を追加する。 | ・python main.py rrを実行すると、DynamicStrategyがExcel経由のデータでnextメソッドを実行し、ログを出力する。 |

### **4\. フェーズ3：注文執行機能の実装 (目標期間: 1～2週間)**

**目標:** backtraderからの売買指示をExcel経由でMS2に伝え、注文が正常に執行されることを確認する。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **3.1** | **ExcelBridge注文執行部の実装** | ・excel\_bridge.pyにplace\_orderメソッドを実装する。 ・Excelへのパラメータ書き込み、VBAのトリガー、結果のポーリングとタイムアウト処理を実装する。 | ・Pythonからplace\_orderを直接呼び出すと、ExcelとVBAを経由して注文が執行され、結果がPythonに返ってくる。 |
| **3.2** | **RakutenBrokerの実装** | ・rakuten\_broker.pyを作成する。 \<br\> ・buy, sell, getcash等のメソッドを実装し、内部でExcelBridgeの対応するメソッドを呼び出す。 | ・backtrader環境下で、RakutenBrokerがExcelBridgeと連携して機能する。 |
| **3.3** | **注文フロー統合** | ・run\_realtrade.pyでRakutenBrokerをCerebroにセットする。 \<br\> ・DynamicStrategyのエントリー条件を満たした際に、buy/sellが呼ばれ、注文が執行されることを確認する。 | ・システム全体を通して、戦略シグナルから実際の注文までが自動で行われる。 |

### **5\. フェーズ4：全体統合と堅牢化 (目標期間: 1週間)**

**目標:** データ取得と注文執行を統合したシステム全体を安定稼働させ、エラーハンドリングを強化する。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **4.1** | **エンドツーエンドテスト** | ・少額・単一銘柄で、エントリーから決済までの一連の自動売買フローを複数回テストする。 | ・ポジションの構築、状態の永続化、決済までがすべて自動で正しく実行される。 |
| **4.2** | **エラーハンドリング強化** | ・ExcelやMS2がフリーズした場合のタイムアウト処理を実装する。 ・VBAマクロがエラーを返した場合のログ記録と通知機能を実装する。 | ・予期せぬ外部要因が発生しても、システムがパニックに陥らず、安全に停止または待機状態になる。 |
| **4.3** | **ドキュメント整備** | ・trading\_hub.xlsmのセットアップ手順、VBAマクロの概要、Python側の実行手順をまとめたREADMEファイルを作成する。 | ・第三者でもシステムのセットアップと実行が可能な手順書。 |

