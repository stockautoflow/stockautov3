はい、承知いたしました。
`main.py`のリファクタリングに関する基本仕様書を作成します。

-----

## **`main.py` リファクタリング基本仕様書**

### **1. 目的**

本リファクタリングは、プロジェクトの統合管理スクリプト `main.py` のソースコードを改善し、**保守性**、**可読性**、**拡張性**を向上させることを目的とします。既存の全機能（コマンド実行、エイリアス）は維持します。

### **2. 対象ファイル**

  * `main.py`

### **3. 基本方針**

  * **責務の分割**: 役割ごとに処理を関数へ分割し、単一責任の原則を適用します。
  * **設定とロジックの分離**: スクリプトの動作を定義する設定情報（パス、モジュール名、エイリアス等）をコードから外部ファイルへ分離します。
  * **処理の共通化**: 重複しているコマンド実行ロジックを統合し、コードの冗長性を排除します。

### **4. 仕様詳細**

#### **4.1. コマンド実行ロジックの統合**

  * **現状**: `execute_script`, `execute_module`, `execute_tool` という3つの類似した関数でコマンドを実行している。
  * **変更後**:
      * 上記の3関数を廃止し、新たに `execute_command(command_args: list)` 関数を定義する。
      * この関数は、実行するコマンド全体（例: `['python', '-m', 'src.backtest.run_backtest']`）をリスト形式で受け取り、`subprocess.run()` を実行する。
      * エラーハンドリングとログ出力もこの共通関数に集約する。
  * **効果**: 実行ロジックを一元化し、コードの重複を削減。今後の実行方法の変更が容易になる。

#### **4.2. `argparse`によるエイリアス管理の一元化**

  * **現状**: スクリプト冒頭の `if/elif` ブロックでエイリアスを独自に解釈し、その後 `argparse` で通常のコマンドを処理する二段構えのロジックとなっている。
  * **変更後**:
      * 冒頭のエイリアス判定ロジックを完全に削除する。
      * `argparse`の`subparsers.add_parser()`が持つ `aliases` オプションを活用し、エイリアス定義を`argparse`に一任する。
        ```python
        # 例
        parser_run = subparsers.add_parser("run", aliases=["r"], help="バックテストなどを実行")
        parser_gen = subparsers.add_parser("generate", aliases=["g"], help="ファイルを生成")
        ```
  * **効果**: コマンド解釈のフローが`argparse`に統一され、コードの見通しが向上する。

#### **4.3. 設定情報の外部ファイル化**

  * **現状**: `GENERATION_SCRIPTS`, `RUNNABLE_MODULES`, `ALIASES` といった設定情報が、`main.py` スクリプト内に辞書としてハードコーディングされている。
  * **変更後**:
      * 新たに `config/cli_config.yml` ファイルを作成し、上記の設定情報を集約して管理する。
      * `main.py` は起動時にこのYAMLファイルを読み込み、設定をロードする。
    <!-- end list -->
    ```yaml
    # config/cli_config.yml の例
    generation_scripts:
      core: "scripts/create_core.py"
      backtest: "scripts/create_backtest.py"
      # ...

    runnable_modules:
      backtest: "src.backtest.run_backtest"
      realtrade: "src.realtrade.run_realtrade"
      # ...

    aliases:
      rb: ["run", "backtest"]
      gall: ["generate", "all"]
      # ...
    ```
  * **効果**: スクリプトのロジックと設定を完全に分離。コンポーネントの追加やエイリアスの変更時に、Pythonコードを編集する必要がなくなる。

#### **4.4. `main`関数の責務分割**

  * **現状**: `main`関数が、エイリアス解決、`argparse`のセットアップ、コマンドの振り分けなど、多くの責務を担っている。
  * **変更後**:
      * `main`関数内の処理を、以下の責務を持つヘルパー関数に分割する。
          * `load_config(path)`: `cli_config.yml` を読み込む。
          * `setup_parser(config)`: `argparse`のパーサーを構築して返す。
          * `handle_command(args, config)`: パースされた引数に基づき、適切な処理を実行する。
      * `main`関数は、これらのヘルパー関数を順に呼び出すだけのシンプルな構成にする。
  * **効果**: `main`関数の可読性が大幅に向上し、各処理の単体テストが容易になる。

### **5. 実施後の期待効果**

本リファクタリングを実施することで、`main.py`は以下の点で改善される。

  * **保守性**: 機能追加や仕様変更が、コードの他の部分への影響を最小限に抑えつつ、容易に行えるようになる。
  * **可読性**: 各関数の責務が明確になり、コードの意図が理解しやすくなる。
  * **拡張性**: 新しいコンポーネントやコマンドを、設定ファイルへの追記だけで簡単に追加できるようになる。