はい、承知いたしました。  
詳細設計書の内容を基に、リファクタリングを安全かつ計画的に進めるための実装計画書をMD形式で作成します。

---

# **取引システムコア リファクタリング実装計画書**

* **バージョン**: 1.0  
* **作成日**: 2025/09/01  
* **目的**: 詳細設計書に基づき、リファクタリング作業を安全かつ効率的に実行するための手順、検証方法、およびスケジュールを定義する。

## **1\. 準備作業**

### **1.1. 前提条件**

* 現在の全コードがバージョン管理システム（Gitなど）のメインブランチにコミット済みであること。  
* リファクタリング作業専用の新しいブランチ（例: feature/core-refactor）を作成し、以降の作業はそのブランチ上で行う。  
* リファクタリング前の状態で、バックテストおよびリアルタイムモジュールが正常に動作することを確認しておく。

### **1.2. 参照ドキュメント**

* リファクタリング最終仕様書  
* リファクタリング詳細設計書

---

## **2\. 実装フェーズ**

作業を以下の4つのフェーズに分割し、段階的に進める。各フェーズの完了時には検証を行い、デグレード（機能低下）が発生していないことを確認する。

### **フェーズ 1: 基底クラスの作成と分離 (約0.5日)**

**目的**: coreパッケージを、モードに依存しない純粋なテンプレート（抽象基底クラス群）に変換する。

1. **ファイルリネーム**:  
   * src/core/strategy/strategy\_orchestrator.py を src/core/strategy/base.py にリネームする。  
2. **基底クラス化**:  
   * base.py内のDynamicStrategyをBaseStrategyに改名する。  
   * coreパッケージ内の各コンポーネント（EventHandlerなど）から、モード依存のロジック（if is\_live:など）を**全て削除**し、詳細設計書通りに抽象メソッド（raise NotImplementedError）を定義する。  
3. **検証**:  
   * この段階ではプログラムは正常に動作しない。coreパッケージ内のファイル構成とクラス定義が、詳細設計書通りになっていることを目視で確認する。

---

### **フェーズ 2: バックテスト側の再実装 (約1.5日)**

**目的**: 新しいcore基底クラスを継承し、バックテスト側の機能を完全に再構築する。

1. **ファイル作成**:  
   * 詳細設計書に基づき、src/backtest/strategy.py および src/backtest/implementations/ 配下の全ファイルを作成する。  
2. **ロジック移行**:  
   * **（リファクタリング前の）**coreパッケージにあったバックテスト専用ロジックを、新しく作成したbacktestパッケージの各ファイルに正確に移植する。  
3. **実行スクリプト修正**:  
   * src/backtest/run\_backtest.pyを修正し、DynamicStrategyの代わりに新しいBacktestStrategyをインポートして使用するように変更する。  
4. **検証**:  
   * run\_backtest.pyを実行する。  
   * **重要**: 生成されたレポート（summary, detail, trade\_history）の結果が、**リファクタリング前の結果と完全に一致する**ことを確認する。これがデグレードなきことの証明となる。

---

### **フェーズ 3: リアルタイムトレード側の再実装 (約1.5日)**

**目的**: 新しいcore基底クラスを継承し、リアルタイムトレード側の機能を完全に再構築する。

1. **ファイル作成**:  
   * 詳細設計書に基づき、src/realtrade/strategy.py および src/realtrade/implementations/ 配下の全ファイルを作成する。  
2. **ロジック移行**:  
   * **（リファクタリング前の）**coreパッケージにあったリアルタイム取引専用ロジック（状態永続化、ライブ決済監視など）を、新しく作成したrealtradeパッケージの各ファイルに正確に移植する。  
3. **実行スクリプト修正**:  
   * src/realtrade/run\_realtrade.pyを修正し、DynamicStrategyの代わりに新しいRealTradeStrategyを使用するように変更する。  
   * ライブデータフィードの初期化ロジックを、詳細設計書通りにrun\_realtrade.py内へ実装する。  
4. **検証**:  
   * run\_realtrade.pyを起動し、エラーなく動作することを確認する。  
   * ポジションの取得、決済、通知、DBへの状態保存など、リファクタリング前と同等の機能が維持されていることをログや動作確認によって検証する。

---

### **フェーズ 4: 最終確認とクリーンアップ (約0.5日)**

**目的**: リファクタリングを完了させ、コードベースを整理する。

1. **コードレビュー**:  
   * feature/core-refactorブランチで行った全ての変更内容をレビューし、設計通りに実装されているか、不要なコードが残っていないかを確認する。  
2. **最終テスト**:  
   * 再度、バックテストとリアルタイムモジュールの両方を実行し、最終的な動作確認を行う。  
3. **マージ**:  
   * 問題がなければ、feature/core-refactorブランチをメインブランチにマージする。  
4. **ブランチ削除**:  
   * 作業用ブランチを削除する。

---

## **3\. リスクと対策**

* **リスク**: リファクタリングに起因するデグレード（意図しない機能低下やバグ）の発生。  
  * **対策**: フェーズ2の検証ステップで「バックテスト結果が完全に一致すること」を必須条件とすることで、ロジックのデグレードを確実に検出する。  
* **リスク**: 作業の見積もり超過。  
  * **対策**: 作業がフェーズ分けされているため、進捗管理が容易。問題が発生した場合は、フェーズ単位で見直しを行う。