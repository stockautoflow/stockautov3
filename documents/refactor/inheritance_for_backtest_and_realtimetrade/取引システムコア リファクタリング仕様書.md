はい、承知いたしました。  
これまでの議論で決定した内容を全て反映した、最終版のリファクタリング仕様書を以下に作成します。

---

# **取引システムコア リファクタリング最終仕様書**

* **バージョン**: 1.0  
* **作成日**: 2025/09/01

## **1\. 目的**

本仕様書は、取引システムのcoreパッケージをリファクタリングし、**バックテスト**と**リアルタイムトレード**のロジックを完全に分離するための最終的な設計を定義する。これにより、コードの保守性、安定性、および将来的な拡張性を大幅に向上させることを目的とする。

## **2\. 基本方針**

* coreパッケージは、モードに依存しない\*\*抽象基底クラス（設計図・テンプレート）\*\*を提供する責務を持つ。  
* backtestおよびrealtradeパッケージは、coreの基底クラスを継承し、各モードに特化した\*\*具象クラス（具体的な実装）\*\*を提供する責務を持つ。

## **3\. 最終的なファイル構成**

リファクタリング後の主要なファイル構成は以下の通りとなる。

src/  
├── core/  
│   └── strategy/  
│       ├── base.py                 \# \<- BaseStrategy (旧 strategy\_orchestrator.py)  
│       ├── event\_handler.py        \# \<- BaseEventHandler  
│       ├── exit\_signal\_generator.py  
│       ├── order\_manager.py  
│       └── strategy\_notifier.py  
│  
├── backtest/  
│   ├── \_\_init\_\_.py  
│   ├── strategy.py                 \# \<- BacktestStrategy (公開窓口)  
│   └── implementations/            \# \<- バックテスト用の具体的な実装群  
│       ├── \_\_init\_\_.py  
│       ├── event\_handler.py  
│       ├── exit\_signal\_generator.py  
│       ├── order\_manager.py  
│       └── strategy\_notifier.py  
│  
└── realtrade/  
    ├── \_\_init\_\_.py  
    ├── strategy.py                 \# \<- RealTradeStrategy (公開窓口)  
    └── implementations/            \# \<- リアルタイム取引用の具体的な実装群  
        ├── \_\_init\_\_.py  
        ├── event\_handler.py  
        ├── exit\_signal\_generator.py  
        ├── order\_manager.py  
        └── strategy\_notifier.py

## **4\. ファイル別変更詳細**

### **4.1. 名称が変更されるファイル**

| 旧ファイル名 | → | 新ファイル名 | 理由 |
| :---- | :---- | :---- | :---- |
| src/core/strategy/strategy\_orchestrator.py | → | src/core/strategy/base.py | ストラテジーの基盤(Base)を定義するファイルであることを明確化するため。 |

### **4.2. 新規作成されるファイル**

* **backtestパッケージ内**:  
  * strategy.py: BacktestStrategyを定義。バックテストの「司令塔」。  
  * implementations/event\_handler.py: バックテスト専用のイベント処理を実装。  
  * implementations/exit\_signal\_generator.py: バックテスト専用の決済ロジックを実装。  
  * implementations/order\_manager.py: バックテスト専用の注文管理を実装。  
  * implementations/strategy\_notifier.py: バックテスト時に何もしない通知機能を実装。  
* **realtradeパッケージ内**:  
  * strategy.py: RealTradeStrategyを定義。リアルタイム取引の「司令塔」。  
  * implementations/event\_handler.py: 状態永続化など、リアルタイム専用のイベント処理を実装。  
  * implementations/exit\_signal\_generator.py: ライブ価格監視など、リアルタイム専用の決済ロジックを実装。  
  * implementations/order\_manager.py: リアルタイム専用の注文管理を実装。  
  * implementations/strategy\_notifier.py: メール送信などを行う通知機能を実装。

### **4.3. 主要な責務の変更**

| コンポーネント | coreパッケージでの責務 (基底クラス) | backtest / realtrade での責務 (具象クラス) |
| :---- | :---- | :---- |
| **Strategy**\<br\>(base.py, strategy.py) | ストラテジーの共通骨格を定義。コンポーネントの組み合わせは派生クラスに委ねる。 | **Backtest**: バックテスト用の全コンポーネントを組み立てる。\<br\>**RealTrade**: リアルタイム用の全コンポーネントを組み立てる。 |
| **EventHandler**\<br\>(event\_handler.py) | イベント処理の共通フローを定義。約定時の具体的な処理は抽象化。 | **Backtest**: エントリー約定後、決済OCO注文を発注する。\<br\>**RealTrade**: ポジション情報をDBに永続化する。 |
| **ExitSignalGenerator**\<br\>(exit\_signal\_generator.py) | 決済価格(TP/SL)の計算など共通処理を定義。決済条件の監視方法は抽象化。 | **Backtest**: 何もしない（Brokerのネイティブ注文に委任）。\<br\>**RealTrade**: 毎barでライブ価格を監視し、決済条件を判定する。 |
| **StrategyNotifier**\<br\>(strategy\_notifier.py) | 通知機能のインターフェースを定義。sendメソッドは抽象化。 | **Backtest**: 何もしない。\<br\>**RealTrade**: メール送信などの実処理を呼び出す。 |
| **Data Preparer**\<br\>(data\_preparer.py) | **履歴データ(CSV)の読み込みとリサンプリング機能に特化**する。ライブ関連のロジックは削除。 | (該当なし) |

## **5\. 実行スクリプトの変更点**

* src/backtest/run\_backtest.py:  
  * DynamicStrategyの代わりにbacktest.strategyからBacktestStrategyをインポートして使用する。  
* src/realtrade/run\_realtrade.py:  
  * DynamicStrategyの代わりにrealtrade.strategyからRealTradeStrategyをインポートして使用する。  
  * ライブデータフィードの初期化処理を、core.data\_preparerに依存せず、このファイル内で行うように変更する。

## **6\. 期待される効果**

* **保守性**: 各モードの責務がファイルとディレクトリ構造レベルで明確に分離され、コードの理解が容易になる。  
* **安定性**: 機能が確定したバックテストのコードに影響を与えることなく、リアルタイム取引のコードを安全に修正・拡張できる。  
* **拡張性**: 新しいブローカーAPIの導入など、リアルタイム取引特有の機能を、他への影響を気にすることなく追加できる。