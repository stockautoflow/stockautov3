はい、承知いたしました。  
最終仕様書に基づき、各クラスの責務やメソッドの役割をより具体的に記述したリファクタリング詳細設計書をMD形式で作成します。

---

# **取引システムコア リファクタリング詳細設計書**

* **バージョン**: 1.0  
* **作成日**: 2025/09/01  
* **ドキュメントの目的**: 最終仕様書で定義されたファイル構成に基づき、各クラスの責務、主要なメソッド、およびクラス間の連携フローを詳細に設計する。

## **1\. パッケージ別設計詳細**

### **1.1. src/core パッケージ (基底クラス群)**

coreパッケージは、具体的な処理を持たない**抽象的なテンプレート**として機能する。各モードのクラスは、ここで定義される基底クラスを継承する。

#### **core.strategy.base.BaseStrategy**

* **責務**: 全てのストラテジーに共通する骨格（ライフサイクル、共通コンポーネントの保持）を定義する。  
* **主要メソッド**:  
  * \_\_init\_\_(self): StrategyInitializer, PositionManagerなどモード共通の部品を初期化し、self.\_setup\_components()を呼び出す。  
  * \_setup\_components(self): **\[抽象メソッド\]** 派生クラス（BacktestStrategyなど）が、自身のモード専用コンポーネントを初期化するために実装する。  
  * next(self): エントリーシグナルのチェックや決済シグナルのチェック呼び出しなど、モードに依存しない共通のbar処理フローを定義する。

#### **core.strategy.event\_handler.BaseEventHandler**

* **責務**: notify\_orderから受け取った注文イベントを解釈し、適切なハンドラメソッドに振り分ける共通ロジックを提供する。  
* **主要メソッド**:  
  * on\_order\_update(self, order): 注文ステータスを判別し、\_handle\_entry\_completionなどの専門メソッドを呼び出す。  
  * \_handle\_entry\_completion(self, order): **\[抽象メソッド\]** エントリー約定時の処理。  
  * \_handle\_exit\_completion(self, order): **\[抽象メソッド\]** 決済約定時の処理。

#### **core.strategy.exit\_signal\_generator.BaseExitSignalGenerator**

* **責務**: ATRに基づいたTP/SL価格の計算など、モード共通の決済価格決定ロジックを提供する。  
* **主要メソッド**:  
  * calculate\_and\_set\_exit\_prices(self, entry\_price, is\_long): エントリー価格を基に、TP/SL価格を計算して内部に保持する。  
  * check\_exit\_conditions(self): **\[抽象メソッド\]** 決済条件を監視する方法。

#### **core.strategy.strategy\_notifier.BaseStrategyNotifier**

* **責務**: 通知機能のインターフェースを定義する。  
* **主要メソッド**:  
  * send(self, subject, body, immediate=False): **\[抽象メソッド\]** 通知を送信する方法。

---

### **1.2. src/backtest パッケージ (バックテスト実装)**

coreのテンプレートを基に、**バックテストに特化した具体的な処理**を実装する。

#### **backtest.strategy.BacktestStrategy**

* **責務**: バックテストに必要な全てのimplementationsコンポーネントを組み立て、実行可能なBacktestStrategyを完成させる。  
* **主要メソッド**:  
  * \_setup\_components(self): BacktestEventHandler, BacktestOrderManagerなどをインスタンス化し、self.event\_handlerなどにセットする。

#### **backtest.implementations.event\_handler.BacktestEventHandler**

* **責務**: バックテストの注文フローを制御する。  
* **主要メソッド**:  
  * \_handle\_entry\_completion(self, order): エントリー約定をログに記録後、self.strategy.order\_manager.place\_backtest\_exit\_orders()を呼び出し、**決済用のOCO注文（Limit \+ StopTrail）を発注**する。

#### **backtest.implementations.order\_manager.BacktestOrderManager**

* **責務**: バックテスト専用のネイティブ注文を発行する。  
* **主要メソッド**:  
  * place\_backtest\_exit\_orders(self): bt.Order.Limitとbt.Order.StopTrailを組み合わせたOCO注文を作成するロジックを実装する。

#### **backtest.implementations.exit\_signal\_generator.BacktestExitSignalGenerator**

* **責務**: バックテストでは何もしない。  
* **主要メソッド**:  
  * check\_exit\_conditions(self): **具体的な処理は実装せず pass**。決済はBrokerのネイティブOCO注文に完全に委任するため。

#### **backtest.implementations.strategy\_notifier.BacktestStrategyNotifier**

* **責務**: バックテスト中は通知を行わない。  
* **主要メソッド**:  
  * send(self, ...): **具体的な処理は実装せず pass**。

---

### **1.3. src/realtrade パッケージ (リアルタイム実装)**

coreのテンプレートを基に、**リアルタイム取引に特化した具体的な処理**（状態永続化、ライブ価格監視など）を実装する。

#### **realtrade.strategy.RealTradeStrategy**

* **責務**: リアルタイム取引に必要な全てのimplementationsコンポーネントとStateManagerを組み立て、実行可能なRealTradeStrategyを完成させる。  
* **主要メソッド**:  
  * \_setup\_components(self): RealTradeEventHandlerなどをインスタンス化し、self.event\_handlerなどにセットする。この際、state\_managerをEventHandlerに渡す。

#### **realtrade.implementations.event\_handler.RealTradeEventHandler**

* **責務**: 注文イベントに応じて、ポジションの状態をデータベースに永続化する。  
* **主要メソッド**:  
  * \_handle\_entry\_completion(self, order): ライブ用の決済価格を再計算し、\_update\_trade\_persistenceを呼び出して**DBにポジション情報を保存**する。  
  * \_handle\_exit\_completion(self, order): \_update\_trade\_persistenceを呼び出して**DBからポジション情報を削除**する。  
  * \_update\_trade\_persistence(self, order): state\_managerを直接操作し、DBへの書き込み・削除を行う。

#### **realtrade.implementations.exit\_signal\_generator.RealTradeExitSignalGenerator**

* **責務**: 毎barの価格を監視し、決済条件を判定する。  
* **主要メソッド**:  
  * check\_exit\_conditions(self): 現在価格とself.tp\_price/self.sl\_priceを比較する。**トレーリングストップの場合は、self.sl\_priceを更新する**ロジックもここに実装する。条件が満たされた場合はself.strategy.order\_manager.close\_position()を呼び出す。

#### **realtrade.implementations.strategy\_notifier.RealTradeStrategyNotifier**

* **責務**: 実際に通知（メール送信など）を行う。  
* **主要メソッド**:  
  * send(self, ...): core.util.notifierを呼び出し、**メール送信をキューに追加**する処理を実装する。

## **2\. データフローの変更点**

#### **core.data\_preparer.py**

* prepare\_historical\_data\_feedsに改名し、責務を**履歴データ(CSV)の読み込みとリサンプリングに限定**する。is\_liveフラグは削除する。

#### **run\_realtrade.pyの役割**

* YahooDataやRakutenDataなど、**ライブデータフィードのインスタンス化をrun\_realtrade.pyが直接担当**する。  
* 作成したプライマリデータフィードをcerebro.adddataで追加し、必要に応じてcerebro.resampledataを呼び出す。これにより、coreからrealtradeへの依存関係が解消される。