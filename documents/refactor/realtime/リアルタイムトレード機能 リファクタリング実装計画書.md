はい、承知いたしました。  
これまでの仕様書を元に、実際のリファクタリング作業を段階的に進めるための実装計画書を作成します。

---

## **リアルタイムトレード機能 リファクタリング実装計画書**

日付: 2025年9月26日  
バージョン: 1.0

### **1\. 概要**

本計画書は、「リアルタイムトレード機能 リファクタリング詳細設計書 v1.1」に基づき、リファクタリング作業を遂行するための具体的な作業フェーズ、タスク、スケジュール、およびリスク管理について定める。

### **2\. 実装方針**

* **ボトムアップアプローチ**: 依存関係のない最も基礎的なコンポーネントから実装を開始し、段階的に上位のコンポーネントを構築していく。これにより、各コンポーネントの動作を個別に確認しながら、手戻りのリスクを最小限に抑える。  
* **単体テストの徹底**: 新規作成する各クラスについては、その責務を保証するための単体テストを実装する。  
* **段階的な統合**: 全てのコードを一度に書き換えるのではなく、完成したコンポーネントから順次統合していく。

### **3\. 作業フェーズとタスク一覧 🪜**

作業を以下の4つのフェーズに分割して進める。

---

#### **フェーズ1: 基盤コンポーネントの実装**

Excelとの物理的なデータ交換を担う、最も独立した部分を最初に実装する。

* **タスク1.1: excel\_reader.py の実装**  
  * ExcelReaderクラスを作成し、read\_market\_dataとread\_positionsメソッドを詳細設計書通りに実装する。  
* **タスク1.2: excel\_reader.py の単体テスト**  
  * サンプル用のExcelファイルを用意し、ExcelReaderが正しくデータを読み取り、期待通りの辞書形式に変換できることを検証するテストコードを記述する。

---

#### **フェーズ2: サービスコンポーネントの実装と連携**

フェーズ1で作成したExcelReaderを利用し、サービスとして機能するExcelConnectorを実装する。

* **タスク2.1: excel\_connector.py の実装**  
  * excel\_bridge.pyをexcel\_connector.pyにリネームし、ExcelConnectorクラスを詳細設計書通りに修正する。  
  * \_data\_loop内でExcelReaderを呼び出すようにロジックを変更する。  
* **タスク2.2: excel\_connector.py の単体テスト**  
  * ExcelReaderをモック化（偽のオブジェクトに置き換え）し、ExcelConnectorがスレッドを正しく起動・停止できること、およびデータをスレッドセーフに保持・提供できることを検証する。

---

#### **フェーズ3: ビジネスロジックコンポーネントの実装**

システムの中核となるビジネスロジックを担うコンポーネントを実装する。

* **タスク3.1: cerebro\_factory.py の実装**  
  * CerebroFactoryクラスを詳細設計書通りに実装する。  
* **タスク3.2: position\_synchronizer.py の実装**  
  * PositionSynchronizerクラスを詳細設計書通りに実装する。  
* **タスク3.3: 上記2クラスの単体テスト**  
  * 各クラスのロジックが正しく動作することを検証するテストコードを記述する。（例: CerebroFactoryが正しくCerebroインスタンスを構築できるか、PositionSynchronizerがポジションの差異を正しく検知できるか）

---

#### **フェーズ4: 統合と最終テスト**

全ての新コンポーネントを司令塔であるrun\_realtrade.pyに組み込み、全体の動作を確認する。

* **タスク4.1: run\_realtrade.py のリファクタリング**  
  * RealtimeTraderクラスが、新しく作成したExcelConnector, CerebroFactory, PositionSynchronizerを呼び出すように、処理フローを全面的に書き換える。  
* **タスク4.2: 結合テスト**  
  * 実際にrun\_realtrade.pyを実行し、システム全体が意図通りに連携して動作することを確認する。  
    * Excelからのデータ取得が正常に行われるか。  
    * ポジションの同期がリアルタイムで正しく行われるか。  
    * システムが安全に起動・停止できるか。  
* **タスク4.3: コードレビューとドキュメント更新**  
  * リファクタリングした全コードのレビューを実施し、品質を担保する。  
  * 必要に応じて関連ドキュメントを更新する。

### **4\. 推定スケジュール 🗓️**

各タスクの標準的な作業日数を以下に見積もる。（1人日 \= 1人が1日で完了できる作業量）

| フェーズ | タスクID | タスク内容 | 推定作業日数 |
| :---- | :---- | :---- | :---- |
| **フェーズ1** | 1.1 | excel\_reader.py の実装 | 1.0 人日 |
|  | 1.2 | excel\_reader.py の単体テスト | 0.5 人日 |
| **フェーズ2** | 2.1 | excel\_connector.py の実装 | 1.5 人日 |
|  | 2.2 | excel\_connector.py の単体テスト | 1.0 人日 |
| **フェーズ3** | 3.1 | cerebro\_factory.py の実装 | 1.0 人日 |
|  | 3.2 | position\_synchronizer.py の実装 | 1.0 人日 |
|  | 3.3 | 上記2クラスの単体テスト | 1.0 人日 |
| **フェーズ4** | 4.1 | run\_realtrade.py のリファクタリング | 1.5 人日 |
|  | 4.2 | 結合テスト | 2.0 人日 |
|  | 4.3 | コードレビューとドキュメント更新 | 0.5 人日 |
| **合計** |  |  | **11.0 人日** |

### **5\. リスク管理 ⚠️**

* **リスク**: ExcelとのCOM連携がスレッド環境で不安定になる可能性。  
  * **対策**: \_data\_loop内での適切なエラーハンドリングを実装する。pythoncomの初期化と後処理を徹底する。  
* **リスク**: ポジション同期ロジックのバグによる意図しない挙動。  
  * **対策**: PositionSynchronizerの単体テストで、新規・決済・変更・変更なし、といった全てのパターンを網羅的に検証する。  
* **リスク**: リファクタリングによるパフォーマンスの低下。  
  * **対策**: \_data\_loop内の処理を軽量に保つ。結合テストフェーズでCPU使用率などを監視し、問題があればボトルネックを特定する。