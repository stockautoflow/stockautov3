承知いたしました。採用されたファイル名に基づき、リファクタリングの**基本仕様書**を作成します。

この仕様書は、これからの改修作業の指針となるものです。

-----

## リアルタイムトレード機能 リファクタリング基本仕様書

**日付**: 2025年9月26日
**バージョン**: 1.0

### 1\. 目的

`run_realtrade.py` および `bridge/excel_bridge.py` に集中している機能を適切に分割する。これにより、各ファイルの責務を単一化し、コードの**可読性、保守性、テスト容易性**を向上させることを目的とする。

-----

### 2\. リファクタリング対象範囲

  * **修正対象ファイル**:
      * `src/realtrade/run_realtrade.py`
      * `src/realtrade/bridge/excel_bridge.py`
  * **新規作成ファイル**:
      * `src/realtrade/position_synchronizer.py`
      * `src/realtrade/cerebro_factory.py`
      * `src/realtrade/bridge/excel_reader.py`
  * **ファイル名変更**:
      * `src/realtrade/bridge/excel_bridge.py` → `src/realtrade/bridge/excel_connector.py`

-----

### 3\. 新しいファイル構成

リファクタリング後のファイル構成は以下の通り。

```
src/realtrade/
├── run_realtrade.py          # 司令塔（オーケストレーター）
├── position_synchronizer.py  # ポジション同期ロジック
├── cerebro_factory.py        # Cerebroインスタンスの生成処理
└── bridge/
    ├── excel_connector.py    # Excelとの接続・スレッド管理
    └── excel_reader.py       # Excelデータの読み取り・解析
```

-----

### 4\. 各ファイルの責務と仕様

#### 4.1. `excel_reader.py`

  * **主な責務**: Excelシートの構造を熟知し、指定されたセルのデータを読み取ってPythonで扱える形式に変換する**データ解析役**。
  * **具体的な機能**:
      * `__init__(self, sheets)`: `xlwings`のシートオブジェクト群を引数に取る。
      * `read_market_data(self)`: 市場データを読み取り、整形された辞書を返す。
      * `read_positions(self)`: 建玉情報を読み取り、整形された辞書を返す。
  * **依存関係**: なし（`xlwings`ライブラリのみに依存）。

#### 4.2. `excel_connector.py`

  * **主な責務**: バックグラウンドでExcelとの接続を維持し、最新データをスレッドセーフに提供する**サービス/インターフェース役**。
  * **具体的な機能**:
      * `__init__(self, workbook_path)`: Excelファイルのパスを引数に取る。
      * `start(self)`: データ取得を行うバックグラウンドスレッドを起動する。内部で `ExcelReader` を利用する。
      * `stop(self)`: バックグラウンドスレッドを安全に停止する。
      * `get_positions(self)`: 最新のポジション情報を辞書で返す。
      * `get_cash(self)`: 最新の現金残高を数値で返す。
  * **依存関係**: `excel_reader.py`

#### 4.3. `cerebro_factory.py`

  * **主な責務**: `backtrader` の `Cerebro` インスタンスの生成とセットアップに関する複雑な処理をカプセル化する**工場役**。
  * **具体的な機能**:
      * `__init__(self, ...)`: 戦略カタログなどの設定情報を引数に取る。
      * `create_instance(self, symbol, connector)`: 銘柄コードと`ExcelConnector`のインスタンスを引数に取り、データフィードやブローカー、ストラテジーがすべて設定済みの`Cerebro`インスタンスを返す。
  * **依存関係**: `excel_connector.py`

#### 4.4. `position_synchronizer.py`

  * **主な責務**: `ExcelConnector` から取得した実ポジションと、システム内部のポジションを定期的に比較し、同期させる**調整役**。
  * **具体的な機能**:
      * `__init__(self, connector, strategies, ...)`: `ExcelConnector`とストラテジーインスタンス群などを引数に取る。
      * `run(self)`: `threading.Thread` のメソッド。定期的な同期処理を実行するメインループ。
  * **依存関係**: `excel_connector.py`

#### 4.5. `run_realtrade.py`

  * **主な責務**: 上記の全コンポーネントを初期化し、全体の処理フロー（起動、監視、停止）を管理する**司令塔(オーケストレーター)役**。
  * **具体的な機能**:
      * `RealtimeTrader`クラスがメインの処理を担う。
      * 設定ファイル（推奨戦略など）を読み込む。
      * `ExcelConnector` を起動する。
      * `CerebroFactory` を使って全対象銘柄の `Cerebro` インスタンスを生成し、それぞれをスレッドで起動する。
      * `PositionSynchronizer` を起動する。
      * アプリケーション全体の正常なシャットダウン処理を行う。
  * **依存関係**: `excel_connector.py`, `cerebro_factory.py`, `position_synchronizer.py`

-----

以上を基本仕様とし、リファクタリング作業を進めてください。