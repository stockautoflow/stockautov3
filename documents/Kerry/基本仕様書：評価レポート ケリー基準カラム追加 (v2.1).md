承知いたしました。
これまでの議論に基づき、`evaluation`（評価）モジュールが `Kelly_Raw` および `Kelly_Adj` を計算・出力する機能に限定した、基本仕様書を作成します。

---

## 1. 基本仕様書：評価レポート ケリー基準カラム追加 (v2.1)

| ドキュメント名 | 評価レポート（evaluation）へのケリー基準カラム追加 |
| --- | --- |
| 作成日 | 2025年11月6日 |
| バージョン | 2.1 (評価レポート編) |
| 作成者 | Gemini |

### 1.1. 改修目的

* `evaluation`（全戦略評価）の実行結果（レポート）において、各戦略・銘柄ペアの統計的優位性（期待値）を定量化する。
* バックテスト結果の「勝率」「RR比」に基づき、ケリー基準のf値（投資比率）を自動計算し、`Kelly_Raw`（生の値）および `Kelly_Adj`（調整済みの投資比率）としてレポートファイルに記録する。
* この改修は、`realtrade`（リアルタイム取引）モジュールが、この値を参照して売買数量（サイジング）を決定するための準備段階である。

### 1.2. 対象範囲

* **修正対象スクリプト:**
    1.  `create_core.py` (**[修正]**: `kelly_criterion.py` を新規追加)
    2.  `create_evaluation.py` (**[修正]**: `aggregator.py` のロジックを修正)
* **修正対象モジュール (上記スクリプトが生成するファイル):**
    1.  **`src/core/util/kelly_criterion.py`** (**[新規作成]**)
    2.  `src/evaluation/aggregator.py` (**[修正]**)
* **影響を受ける出力ファイル:**
    * `results/evaluation/.../all_detail_*.csv` (カラム追加)
    * `results/evaluation/.../all_recommend_*.csv` (カラム追加)

---

### 1.3. 詳細仕様

#### 1.3.1. ケリー基準計算ヘルパーの定義 (`create_core.py` にて新規追加)

`core` パッケージ（共通ライブラリ）に、ケリー基準の計算ロジックを一元化するファイルを追加する。

* **新規ファイル:** `src/core/util/kelly_criterion.py`
* **関数名:** `calculate_raw_kelly`
* **引数:**
    1.  `win_rate_percent`: 勝率 (例: "55.20%" のような文字列)
    2.  `rr_ratio`: リスクリワード比 (例: "2.15", "inf" のような文字列または数値)
* **処理:**
    1.  引数を数値（`p` = 勝率, `R` = RR比）に変換する (例: `p = 0.5520`, `R = 2.15`, `R = np.inf`)。
    2.  入力値が無効 (NaN, R <= 0, pが0-1の範囲外) の場合は `np.nan` を返す。
    3.  **[エッジケース処理]** `R` が `np.inf`（無限大）の場合、`f_value = p`（勝率）を返す。
    4.  **[通常処理]** `f* = (p*R - (1-p)) / R` を計算する。
* **戻り値:**
    * 計算されたf値（`f_value`）。期待値がマイナスの場合、**マイナスの値をそのまま返す**。

#### 1.3.2. 出力カラムの定義

`all_detail.csv` および `all_recommend.csv` に、以下の2列を追加する。

1.  **`Kelly_Raw`**
    * **定義:** `calculate_raw_kelly` が返した、ケリー基準の**生の値**。
    * **フォーマット:** 小数点以下4桁の文字列 (例: "0.3350", "-0.1050", "N/A")。

2.  **`Kelly_Adj`**
    * **定義:** `Kelly_Raw` の値に基づき、段階的な投資比率（総資産に対する割合）を決定する。
    * **ロジック:**
        * `Kelly_Raw < 0.05` (5%未満) の場合: **`0.0`** (総資産の0%)
        * `0.05 <= Kelly_Raw < 0.15` (15%未満) の場合: **`0.05`** (総資産の5%)
        * `Kelly_Raw >= 0.15` (15%以上) の場合: **`0.10`** (総資産の10%)
    * **フォーマット:** 小数点以下4桁の文字列 (例: "0.0000", "0.0500", "0.1000", "N/A")。

#### 1.3.3. 既存関数の改修 (`create_evaluation.py` が生成する `aggregator.py`)

* **対象関数:** `aggregate_details(results_dir, timestamp)`
* **改修内容:**
    1.  **[インポート]** `aggregator.py` の冒頭で、`from src.core.util.kelly_criterion import calculate_raw_kelly` を追加する。
    2.  **[カラム生成]** `detail.csv` の読み込み直後、インポートした `calculate_raw_kelly` を呼び出し、`Kelly_Raw` カラムを生成する。
    3.  **[カラム生成]** 生成された `Kelly_Raw` カラムに基づき、上記「1.3.2.」のロジックで `Kelly_Adj` カラムを生成する。
    4.  **[欠損値対応]** 集計漏れ（`missing_symbols`）を検出した際に追加するダミー行にも、`Kelly_Raw: np.nan`, `Kelly_Adj: np.nan` を追加する。
    5.  **[フォーマット]** CSV保存直前に、`Kelly_Raw` と `Kelly_Adj` カラムを、指定のフォーマット（小数点以下4桁の文字列、NaNは "N/A"）に変換する。

#### 1.3.4. 自動反映 (`all_recommend.csv` への適用)

* **対象関数:** `create_recommend_report(all_detail_report_path, ...)`
* **改修内容:** **修正不要。**
    * `all_detail.csv` に `Kelly_Raw` と `Kelly_Adj` が追加されていれば、純利益でソートされて抽出される `all_recommend.csv` にも自動的にカラムが引き継がれる。