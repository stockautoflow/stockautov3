承知いたしました。
詳細設計書 に基づき、実際の作業手順を定義する「実装計画書」をMarkdown形式で作成します。

---

# 実装計画書: サイジングアルゴリズム V2.0

* **バージョン:** 2.0
* **日付:** 2025年11月12日
* **作成者:** Gemini
* **関連ドキュメント:** 基本仕様書 (v2.0), 詳細設計書 (v2.0)

---

## 1. 目的

本計画書は、詳細設計書 (v2.0) に基づき、「ケリー基準サイジング」機能の導入と、既存の「リスクベースサイジング」との選択機能の実装手順を定義する。

## 2. 影響範囲

本改修により、以下の4つのコンポーネント（ジェネレータ・スクリプト）が変更対象となる。

* `create_strategy.py` (設定定義)
* `create_core.py` (中核ロジック)
* `create_backtest.py` (バックテスト実装)
* `create_realtrade.py` (リアルタイム取引実装)

## 3. 作業手順

作業は「**A. ジェネレータの修正**」「**B. プロジェクトファイルの再生成**」「**C. テスト**」の3フェーズで実施する。

### A. ジェネレータの修正 (4ファイル)

#### A.1. `create_strategy.py` の修正

* **対象:** `project_files["config/strategy_base.yml"]`
* **作業:** `sizing:` ブロック全体を、詳細設計書 の 2.1. で定義された新しい構造（`backtest_method` と `realtrade_method` を含む）で**置き換える**。

#### A.2. `create_core.py` の修正

* **対象:** `project_files["src/core/strategy/order_manager.py"]` (`BaseOrderManager` クラス)
* **作業1 ( `__init__` ) :** `BaseOrderManager` の `__init__` メソッドのシグネチャを、詳細設計書 の 2.2.1. に従って `(self, strategy, sizing_params, method: str, event_handler, statistics=None)` に**変更**する。
* **作業2 ( `place_entry_order` ) :** `BaseOrderManager` の `place_entry_order` メソッド全体を、詳細設計書 の 2.2.2. で定義された新しいロジック（`self.method` による分岐を含む）で**置き換える**。

#### A.3. `create_backtest.py` の修正

* **対象1:** `project_files["src/backtest/strategy.py"]` (`BacktestStrategy` クラス)
* **作業1:** `_setup_components` メソッドを改修。`sizing_params.get('backtest_method')` を `method` 変数として読み込み、`BacktestOrderManager` のコンストラクタに渡す（詳細設計書 2.4.1. 参照）。

* **対象2:** `project_files["src/backtest/implementations/order_manager.py"]` (`BacktestOrderManager` クラス)
* **作業2:** `__init__` メソッドを**追加**し、`super().__init__(..., method=method, statistics=None)` を呼び出す（詳細設計書 2.4.2. 参照）。

#### A.4. `create_realtrade.py` の修正

* **対象1:** `project_files["src/realtrade/run_realtrade.py"]` (`RealtimeTrader` クラス)
* **作業1:** `__init__` メソッドを改修。`_load_trade_data` を呼び出し、`self.statistics_map` を生成し、`CerebroFactory` に渡す（詳細設計書 2.3.1. 参照）。
* **作業2:** `_load_strategy_assignments` メソッドを、`_load_trade_data` に**改名**し、`DataFrame` を返すよう変更する（詳細設計書 2.3.1. 参照）。

* **対象2:** `project_files["src/realtrade/cerebro_factory.py"]` (`CerebroFactory` クラス)
* **作業3:** `__init__` メソッドを、`statistics_map` を受け取れるよう**変更**する（詳細設計書 2.3.2. 参照）。
* **作業4:** `create_instance` メソッドを改修し、`statistics_map` から該当の `symbol_statistics` を取得し、`strategy_components` 経由で `RealTradeStrategy` に渡す（詳細設計書 2.3.2. 参照）。

* **対象3:** `project_files["src/realtrade/strategy.py"]` (`RealTradeStrategy` クラス)
* **作業5:** `_setup_components` メソッドを改修。`sizing_params.get('realtrade_method')` と `components.get('statistics')` を取得し、`RealTradeOrderManager` のコンストラクタに渡す（詳細設計書 2.3.3. 参照）。

* **対象4:** `project_files["src/realtrade/implementations/order_manager.py"]` (`RealTradeOrderManager` クラス)
* **作業6:** `__init__` メソッドを**追加**し、`super().__init__(..., method=method, statistics=statistics)` を呼び出す（詳細設計書 2.3.4. 参照）。

### B. プロジェクトファイルの再生成

1.  上記 A. の作業がすべて完了したら、プロジェクトルートで以下のコマンドを実行する。
2.  **コマンド:** `python main.py gall`
3.  **確認:** `src` フォルダ配下の `order_manager.py`, `strategy.py`, `run_realtrade.py` などが更新されたことを確認する。

### C. テスト

#### C.1. テストケース 1: バックテスト (リスクベース方式)

1.  **設定:** `config/strategy_base.yml` が `backtest_method: 'risk_based'` であることを確認する。
2.  **実行:** `python main.py rb` (バックテスト実行)
3.  **期待値:** ログ（`log/backtest_*.log`）に `サイジング (リスクベース): ...` というログが出力され、正常にトレードが実行されること。

#### C.2. テストケース 2: バックテスト (ケリー基準・固定)

1.  **設定:** `config/strategy_base.yml` を以下に変更する。
    * `backtest_method: 'kelly_criterion'`
    * `kelly_criterion:` -> `f_value_source: 'fixed'`
    * `kelly_criterion:` -> `fixed_f_value: 0.1` (例: 10%)
2.  **実行:** `python main.py rb`
3.  **期待値:** ログに `ケリー基準 (固定f値): f=0.1000` および `サイジング (ケリー基準): ...` というログが出力され、資金の10%を基準とした数量でトレードが実行されること。

#### C.3. テストケース 3: リアルタイム (ケリー基準・調整済)

1.  **前提:** `python main.py re` (評価実行) が完了しており、`results/evaluation/` 配下に `all_recommend_*.csv` が存在し、`Kelly_Adj` 列が含まれていること。
2.  **設定:** `config/strategy_base.yml` を以下に変更する。
    * `realtrade_method: 'kelly_criterion'`
    * `kelly_criterion:` -> `f_value_source: 'adjusted'`
3.  **実行:** `python main.py rr` (リアルタイム取引実行)
4.  **期待値:** ログ（`log/realtime_*.log`）に `Loading recommended strategies and stats from: ...` が出力され、エントリーシグナル発生時に `ケリー基準 (調整済): 統計 'Kelly_Adj'=...` というログが出力され、`Kelly_Adj` のf値に基づいた数量で注文ログ（`【RT】新規注文発注`）が記録されること。

## 4. ロールバック計画

* テストフェーズ (C) で問題が発見された場合、作業を中断する。
* バージョン管理システム（Gitなど）を使用している場合は、A. で変更した4つの `create_*.py` ファイルを `git restore` 等で元に戻す。
* `python main.py gall` を再実行し、生成された `src` 以下の全ファイルを改修前の状態に戻す。

---