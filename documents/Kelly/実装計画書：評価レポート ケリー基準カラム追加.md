承知いたしました。
基本仕様書 v2.1 および詳細設計書 v1.0 に基づき、`evaluation`（評価）モジュールに `Kelly_Raw` と `Kelly_Adj` カラムを追加するための実装計画書を作成します。

-----

## 1\. 実装計画書：評価レポート ケリー基準カラム追加

| ドキュメント名 | 実装計画書：評価レポート ケリー基準カラム追加 |
| --- | --- |
| 作成日 | 2025年11月6日 |
| バージョン | 1.0 |
| 準拠する設計書 | 詳細設計書：評価レポート ケリー基準カラム追加 (v1.0) |
| 作成者 | Gemini |

### 1.1. 概要

本計画は、`evaluation` モジュールがケリー基準（`Kelly_Raw`）とそれに基づく投資比率（`Kelly_Adj`）を計算し、`all_detail` および `all_recommend` レポートに出力するために必要なコード修正作業を定義する。

作業は以下の2つのスクリプトファイルを対象とする。

1.  **`create_core.py`**
2.  **`create_evaluation.py`**

### 1.2. 作業タスク一覧 (WBS)

| タスクID | 担当 | 修正対象ファイル | タスク概要 | 準拠設計 |
| :--- | :--- | :--- | :--- | :--- |
| **T-1** | 開発者 | `create_core.py` | `project_files` 辞書に `src/core/util/kelly_criterion.py` の定義を追加する。 | 1.2.1 |
| **T-2** | 開発者 | `create_evaluation.py` | `src/evaluation/aggregator.py` のインポート文を修正する。 | 1.2.2 - 1 |
| **T-3** | 開発者 | `create_evaluation.py` | `aggregator.py` の `aggregate_details` 関数にケリー基準（Raw/Adj）の計算ロジックを追加する。 | 1.2.2 - 2 |
| **T-4** | 開発者 | `create_evaluation.py` | `aggregator.py` の `aggregate_details` 関数（集計漏れ処理）にケリー基準の欠損値（`np.nan`）を追加する。 | 1.2.2 - 3 |
| **T-5** | 開発者 | `create_evaluation.py` | `aggregator.py` の `aggregate_details` 関数（CSV保存前）にケリー基準の文字列フォーマット処理を追加する。 | 1.2.2 - 4 |

-----

### 1.3. タスク別詳細手順

#### T-1: `create_core.py` への `kelly_criterion.py` 追加

1.  **ファイルを開く:** `create_core.py` を開く。
2.  **`project_files` 辞書を特定する:** スクリプト内の `project_files = { ... }` の定義を見つける。
3.  **キーと値を追加する:** 辞書の末尾（最後の `}` の直前）に、詳細設計書（1.2.1）に記載されているキー `"src/core/util/kelly_criterion.py"` と、その値（`"""# src/core/util/kelly_criterion.py ..."""` で始まるPythonコードブロック全体）を追加する。

#### T-2: `create_evaluation.py` へのインポート文追加

1.  **ファイルを開く:** `create_evaluation.py` を開く。
2.  **`aggregator.py` の内容を特定する:** `project_files` 辞書内のキー `"src/evaluation/aggregator.py"` を見つける。
3.  **インポート文を追加する:** `aggregator.py` の文字列の先頭（`import os` や `import glob` がある箇所）に、以下の2行を追加する。
    ```python
    import numpy as np
    from src.core.util.kelly_criterion import calculate_raw_kelly
    ```

#### T-3: `aggregate_details` への計算ロジック追加

1.  **`aggregator.py` の内容を編集する:** （T-2 と同じ場所）
2.  **`aggregate_details` 関数を特定する:** `def aggregate_details(results_dir, timestamp):` を見つける。
3.  **挿入箇所を特定する:** `if not detail_df.empty:` ブロック内の `detail_df.insert(0, '戦略名', strategy_name)` の行を見つける。
4.  **コードを挿入する:** その**直後**に、詳細設計書（1.2.2 - 2）の「挿入ブロック START」から「挿入ブロック END」までの `Kelly_Raw` と `Kelly_Adj` を計算するコード（`if '勝率' in detail_df.columns ...` から `detail_df['Kelly_Adj'] = ...` まで）を挿入する。

#### T-4: `aggregate_details` への欠損値処理追加

1.  **`aggregate_details` 関数を編集する:** （T-3 と同じ関数内）
2.  **`missing_row` 辞書を特定する:** `if missing_symbols:` ブロック内の `missing_row = { ... }` の定義を見つける。
3.  **キーと値を追加する:** `missing_row` 辞書内に、以下の2行を追加する。
    ```python
    "Kelly_Raw": np.nan,
    "Kelly_Adj": np.nan
    ```

#### T-5: `aggregate_details` へのフォーマット処理追加

1.  **`aggregate_details` 関数を編集する:** （T-3 と同じ関数内）
2.  **挿入箇所を特定する:** `combined_details_df.to_csv(...)` の呼び出しを特定し、その**直前**の行（`output_filename = f"all_detail_{timestamp}.csv"` の行）を見つける。
3.  **コードを挿入する:** `output_filename` の行の**直前**に、詳細設計書（1.2.2 - 4）の「挿入ブロック START」から「挿入ブロック END」までの、`Kelly_Raw` と `Kelly_Adj` を文字列にフォーマットするコードを挿入する。

### 1.4. 検証計画

1.  **[ビルド]** `create_core.py` と `create_evaluation.py` を実行し、`src/core/util/kelly_criterion.py` が新規作成され、`src/evaluation/aggregator.py` が期待通りに更新されていることを目視で確認する。
2.  **[実行]** `python main.py re` (または `python -m src.evaluation.run_evaluation`) を実行し、全戦略評価プロセスを完了させる。
3.  **[確認]** `results/evaluation/` 配下に新しく生成された `all_detail_*.csv` および `all_recommend_*.csv` を開く。
4.  **[検証]** 以下の点を確認する。
      * **カラムの存在:** `Kelly_Raw` と `Kelly_Adj` カラムが末尾に追加されていること。
      * **`Kelly_Raw` の値:** `勝率` と `RR比` から期待される値（例: "0.3350", "-0.1050", "N/A"）が計算・フォーマットされていること。
      * **`Kelly_Adj` の値:** `Kelly_Raw` の値に基づき、"0.0000", "0.0500", "0.1000", "N/A" のいずれかが正しく設定されていること。