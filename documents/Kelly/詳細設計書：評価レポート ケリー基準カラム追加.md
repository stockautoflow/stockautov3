承知いたしました。
基本仕様書 v2.1 に基づき、`evaluation` モジュールに `Kelly_Raw` と `Kelly_Adj` カラムを追加するための詳細設計書を作成します。

-----

## 1\. 詳細設計書：評価レポート ケリー基準カラム追加

| ドキュメント名 | 詳細設計書：評価レポート ケリー基準カラム追加 |
| --- | --- |
| 作成日 | 2025年11月6日 |
| バージョン | 1.0 |
| 準拠する基本仕様書 | 評価レポート ケリー基準カラム追加 (v2.1) |
| 作成者 | Gemini |

### 1.1. 概要

本改修の目的は、`evaluation`（全戦略評価）プロセスにおいて、ケリー基準（`Kelly_Raw`）と、それに基づく段階的な投資比率（`Kelly_Adj`）を計算し、`results/evaluation` 配下の `all_detail_*.csv` および `all_recommend_*.csv` ファイルに出力することである。

改修は以下の2つのスクリプトに対して行われる。

1.  **`create_core.py`**: ケリー基準の計算ロジックを格納する共通ユーティリティファイル `src/core/util/kelly_criterion.py` を新規追加する。
2.  **`create_evaluation.py`**: `src/evaluation/aggregator.py` が上記ユーティリティをインポートし、集計プロセス中に `Kelly_Raw` および `Kelly_Adj` カラムを生成するよう修正する。

-----

### 1.2. モジュール別詳細設計

#### 1.2.1. `create_core.py` の修正 (ユーティリティの追加)

`project_files` 辞書に、以下のキー（ファイルパス）と値（ファイル内容）を追加する。

**キー (ファイルパス):**
`"src/core/util/kelly_criterion.py"`

**値 (ファイル内容):**

```python
# src/core/util/kelly_criterion.py (新規追加)
import numpy as np
import pandas as pd
import logging

logger = logging.getLogger(__name__)

def calculate_raw_kelly(win_rate_percent, rr_ratio):
    """
    勝率(%)とRR比から生のケリーf値を計算する。
    基本仕様書 v2.1 (1.3.1) に準拠。

    Args:
        win_rate_percent (str or float): "55.20%" や 55.20 など
        rr_ratio (str or float): "2.15", "inf", np.inf など

    Returns:
        float: 計算されたケリーf値 (期待値がマイナスなら負の値を返す)
                無効な入力の場合は np.nan を返す。
    """
    try:
        # 1. 勝率(p)のクリーニング (例: "55.20%" -> 0.5520)
        p_str = str(win_rate_percent).replace('%', '')
        p = pd.to_numeric(p_str, errors='coerce') / 100.0

        # 2. RR比(R)のクリーニング (例: "inf" -> np.inf)
        r_str = str(rr_ratio).lower().replace('inf', 'inf')
        R = pd.to_numeric(r_str, errors='coerce')
        if r_str == 'inf':
            R = np.inf

        # 3. 入力値のバリデーション (仕様 1.3.1 - 処理2)
        if pd.isna(p) or pd.isna(R) or not (0 <= p <= 1) or R <= 0:
            return np.nan

        # 4. エッジケース処理 (Rが無限大) (仕様 1.3.1 - 処理3)
        if R == np.inf:
            return p  # f_value = p

        # 5. 通常処理 (仕様 1.3.1 - 処理4)
        # f* = (p*R - (1-p)) / R
        f_value = (p * R - (1 - p)) / R
        return f_value

    except Exception as e:
        logger.error(f"ケリー基準の計算エラー: p={win_rate_percent}, R={rr_ratio}, Error: {e}")
        return np.nan
```

-----

#### 1.2.2. `create_evaluation.py` の修正 (Aggregatorの改修)

`project_files` 辞書内の `"src/evaluation/aggregator.py"` の内容を、以下に示すポイントに基づき修正する。

**1. インポートの追加 (仕様 1.3.3 - 1)**
`aggregator.py` のファイル先頭（`import ...` が並ぶ箇所）に以下を追加する。

```python
import numpy as np
from src.core.util.kelly_criterion import calculate_raw_kelly
```

**2. `aggregate_details` 関数の修正 (仕様 1.3.3 - 2, 3)**
`detail_df.insert(0, '戦略名', strategy_name)` の直後に、`Kelly_Raw` と `Kelly_Adj` を計算するロジックを挿入する。

```python
# [変更前]
# ...
                    detail_df = pd.read_csv(detail_path)
                    if not detail_df.empty:
                        detail_df.insert(0, '戦略名', strategy_name)
# ...

# [変更後]
# ...
                    detail_df = pd.read_csv(detail_path)
                    if not detail_df.empty:
                        detail_df.insert(0, '戦略名', strategy_name)
                        
                        # --- ▼▼▼ 挿入ブロック START ▼▼▼ ---
                        
                        # 1.3.3 - 2: Kelly_Raw カラムを生成
                        if '勝率' in detail_df.columns and 'RR比' in detail_df.columns:
                            detail_df['Kelly_Raw'] = detail_df.apply(
                                lambda row: calculate_raw_kelly(row['勝率'], row['RR比']),
                                axis=1
                            )
                        else:
                            detail_df['Kelly_Raw'] = np.nan

                        # 1.3.3 - 3: Kelly_Adj カラムを生成 (仕様 1.3.2準拠)
                        def calculate_adjusted_kelly(kelly_raw):
                            if pd.isna(kelly_raw) or kelly_raw < 0.05:
                                return 0.0  # 0%
                            elif kelly_raw < 0.15:
                                return 0.05 # 5%
                            else:
                                return 0.10 # 10%
                        
                        detail_df['Kelly_Adj'] = detail_df['Kelly_Raw'].apply(calculate_adjusted_kelly)
                        
                        # --- ▲▲▲ 挿入ブロック END ▲▲▲ ---
# ...
```

**3. `aggregate_details` 関数の修正 (仕様 1.3.3 - 4)**
`missing_symbols` （集計漏れ）を処理するブロックで、`missing_row` 辞書に `Kelly_Raw` と `Kelly_Adj` を追加する。

```python
# [変更前]
# ...
                                missing_row = {
                                    "戦略名": strategy_name,
                                    "銘柄": symbol,
                                    "純利益": "集計エラー",
                                    "総トレード数": len(history_df[history_df['銘柄'].astype(str) == symbol])
                                }
# ...

# [変更後]
# ...
                                missing_row = {
                                    "戦略名": strategy_name,
                                    "銘柄": symbol,
                                    "純利益": "集計エラー",
                                    "総トレード数": len(history_df[history_df['銘柄'].astype(str) == symbol]),
                                    "Kelly_Raw": np.nan,  # <-- [追加]
                                    "Kelly_Adj": np.nan   # <-- [追加]
                                }
# ...
```

**4. `aggregate_details` 関数の修正 (仕様 1.3.3 - 5)**
`combined_details_df.to_csv(...)` の直前に、`Kelly_Raw` と `Kelly_Adj` を指定フォーマット（小数点以下4桁の文字列 or "N/A"）に変換する処理を挿入する。

```python
# [変更前]
# ...
    combined_details_df = pd.concat(all_details_list, ignore_index=True)
    output_filename = f"all_detail_{timestamp}.csv"
# ...

# [変更後]
# ...
    combined_details_df = pd.concat(all_details_list, ignore_index=True)
    
    # --- ▼▼▼ 挿入ブロック START ▼▼▼ ---
    # 1.3.3 - 5: 出力フォーマットの指定 (仕様 1.3.2準拠)
    if 'Kelly_Raw' in combined_details_df.columns:
        combined_details_df['Kelly_Raw'] = combined_details_df['Kelly_Raw'].apply(
            lambda x: f"{x:.4f}" if pd.notna(x) else "N/A"
        )
    if 'Kelly_Adj' in combined_details_df.columns:
        combined_details_df['Kelly_Adj'] = combined_details_df['Kelly_Adj'].apply(
            lambda x: f"{x:.4f}" if pd.notna(x) else "N/A"
        )
    # --- ▲▲▲ 挿入ブロック END ▲▲▲ ---

    output_filename = f"all_detail_{timestamp}.csv"
# ...
```

**5. `create_recommend_report` 関数の修正 (仕様 1.3.4)**

  * **修正なし。**
  * `all_detail.csv` から純利益で最大値の行を抽出する既存ロジックにより、`Kelly_Raw` と `Kelly_Adj` カラムは自動的に `all_recommend.csv` に引き継がれる。

-----

### 1.3. 出力データフォーマット

本改修により、以下の2ファイルにカラムが追加される。

  * `results/evaluation/.../all_detail_*.csv`
  * `results/evaluation/.../all_recommend_*.csv`

**追加カラム:**

| カラム名 | データ型 | 説明 | 値の例 |
| :--- | :--- | :--- | :--- |
| **`Kelly_Raw`** | `String` | `calculate_raw_kelly` が返した生のf値。 | `"0.3350"`, `"-0.1050"`, `"N/A"` |
| **`Kelly_Adj`** | `String` | `Kelly_Raw` に基づく段階的な投資比率。 | `"0.1000"`, `"0.0500"`, `"0.0000"`, `"N/A"` |

-----