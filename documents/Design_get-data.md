# **株価データ取得スクリプト仕様書 (最終版)**

## **1\. 概要**

本スクリプトは、Yahoo Finance APIを利用して、nikkei\_codes.txtファイルにリストされた日経225構成銘柄の株価データを取得するツールです。コマンドライン引数で指定された、あるいは定義済みのすべての時間間隔（足種）のデータを取得し、銘柄ごと・足種ごとにCSVファイルとして保存します。

## **2\. 主な機能**

* **株価データ取得**: Yahoo Financeから株価（OHLCV：始値, 高値, 安値, 終値, 出来高）を取得します。  
* **柔軟な足種指定**: コマンドライン引数を使って、取得したい足種を自由に指定できます。引数がない場合は、定義された全ての足種を取得します。  
* **堅牢なエラーハンドリング**:  
  * **API制限対策**: APIからのリクエスト制限（HTTP 429）や一時的なネットワークエラーに対し、複数回のリトライ処理を行います。  
  * **API仕様への対応**: 90分足、日足、週足など、特定の足種におけるAPIの取得期間制限に対応しています。無効なリクエストはスキップし、エラー内容をログに記録します。  
  * **ファイルアクセスエラー検知**: ファイル保存時の権限エラーなどを検知し、ログに出力します。  
* **詳細なログ出力**: スクリプトの実行状況、APIリクエストの詳細、成功・失敗、エラー内容などを日付付きのログファイルに記録します。  
* **CSVファイル出力**: 取得・整形後のデータは、実行日ごとのフォルダに、銘柄と足種が明記されたファイル名で保存されます。

## **3\. 前提条件**

* **必須ファイル**: スクリプトと同じディレクトリに nikkei\_codes.txt が存在すること。  
  * **nikkei\_codes.txt**: 日経225構成銘柄の4桁の証券コードが1行に1つずつ記載されたUTF-8形式のテキストファイル。  
* **Pythonライブラリ**:  
  * requests  
  * pandas  
  * numpy  
  * (インストールコマンド: pip install requests pandas numpy)

## **4\. 実行方法**

コマンドプロンプトやターミナルで実行します。

* **引数なし（定義された全足種を取得）**:  
  python DataFetch\_Arg.py

* **引数あり（指定した足種のみ取得）**:  
  \# 5分足と日足のみ取得  
  python DataFetch\_Arg.py 5 D

  \# 1時間足のみ取得  
  python DataFetch\_Arg.py H

### **指定可能な引数**

| 引数 (大文字/小文字区別なし) | 対応する足種 | スクリプトで設定された取得期間 |
| :---- | :---- | :---- |
| 1 | 1分足 | 過去7日間 (7d) |
| 2 | 2分足 | 過去60日間 (60d) |
| 5 | 5分足 | 過去60日間 (60d) |
| 15 | 15分足 | 過去60日間 (60d) |
| 30 | 30分足 | 過去60日間 (60d) |
| 60 | 60分足 | 2年間 (730d) |
| 90 | 90分足 | 過去60日間 (60d) |
| H, 1H | 1時間足 | 2年間 (730d) |
| D, 1D | 日足 | 100年間 (100y) |
| W, 1W, 1WK | 週足 | 100年間 (100y) |
| M, 1MO | 月足 | 全期間 (max) |
| 3M, 3MO | 3ヶ月足 | 100年間 (100y) |

## **5\. 設定項目**

スクリプト上部のグローバル設定セクションで、動作を調整できます。

* **range\_map**: 各足種を取得する際の期間を指定します。Yahoo Finance APIの仕様に合わせて最適化されています。

| 足種 (interval) | 期間 (range) | 備考 |
| :---- | :---- | :---- |
| 1m | 7d | 過去7日間 |
| 2m, 5m, 15m, 30m | 60d | 過去60日間 |
| 60m | 730d | 2年間 |
| 90m | 60d | API仕様により、過去60日分のみ取得可能 |
| 1h | 730d | 2年間 |
| 1d | 100y | max指定時のAPIによるデータ集約を避けるため100年に設定 |
| 1wk | 100y | max指定時のAPIによるデータ集約を避けるため100年に設定 |
| 1mo | max | 月足は全期間を取得 |
| 3mo | 100y | 100年間に設定 |

* SLEEP\_TIME: 1つの銘柄の処理が完了してから次の銘柄に移るまでの待機時間（秒）。APIへの負荷を軽減します。  
* MAX\_RETRIES**,** RETRY\_DELAY: APIエラー発生時のリトライ回数と初期待機時間。

## **6\. 出力ファイル**

* **CSVデータ**:  
  * **保存場所**: ./data\_YYYYMMDD/  
  * **ファイル名**: 銘柄コード\_足種\_YYYYMMDD.csv (例: 1332\_5m\_20250624.csv)  
* **ログファイル**:  
  * **保存場所**: ./DataFetch/  
  * **ファイル名**: DataFetchLog\_YYYYMMDD\_HHMMSS.log

## **7\. エラーハンドリング詳細**

本スクリプトは以下のエラーを想定し、処理を行います。

| エラー種別 | ログ内容例 | 原因とスクリプトの動作 |
| :---- | :---- | :---- |
| **API期間外エラー** | HTTPエラー (..., 90m, Status: 422\) | APIがサポートしない期間（例：90分足で60日より前）を要求した場合。エラーを記録し、そのリクエストはスキップして次の処理へ進みます。 |
| **API制限/NWエラー** | HTTP 429 エラー ... リトライ... | APIの一時的なアクセス制限やネットワーク不調。待機時間を挟んで最大3回までリトライします。 |
| **ファイルアクセス権** | CSV保存中にエラー: \[Errno 13\] Permission denied | 出力先CSVファイルがExcel等で開かれていて書き込めない場合。エラーを記録し、そのファイルの保存は失敗となりますが、全体の処理は継続します。 |
| **入力ファイル不在** | 銘柄コードファイルが見つかりません | nikkei\_codes.txt が存在しない場合。エラーを表示し、スクリプトは終了します。 |

