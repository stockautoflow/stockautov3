はい、承知いたしました。これまでの仕様書と設計書に基づき、開発タスクを具体的にまとめた実装計画書をMarkdown形式で作成します。

---

# **リアルタイムトレード ポジション同期機能 実装計画書**

## **1\. 概要**

### **1.1. 目的**

本計画書は、「リアルタイムトレード ポジション同期機能 詳細設計書」に基づき、開発作業を具体的なタスクに分解し、実装の順序と内容を定義することを目的とする。

### **1.2. 開発スコープ**

* src/realtrade/ パッケージ配下のモジュール修正  
* src/realtrade/ パッケージへの新規モジュール・クラス追加

---

## **2\. 開発タスク一覧と実装ステップ**

開発は以下のステップで進めます。各ステップは独立してテストが可能な単位となっており、段階的な実装と検証を可能にします。

### **ステップ1: ExcelBridge の機能拡張 目的: Excelから実ポジションデータを取得する基盤を構築する。**

* **担当ファイル:** src/realtrade/bridge/excel\_bridge.py  
* **タスク:**  
  1. **get\_positions() メソッドの新規実装:**  
     * xlwingsライブラリを使用してtrading\_hub.xlsmのpositionシートにアクセスするロジックを実装する。  
     * A列を3行目から順にスキャンし、"--------"を終端としてデータ範囲を特定する処理を実装する。  
     * 各行から銘柄コード(A列)、売買区分(G列)、建玉数量(H列)、建値(J列)を読み込む。  
     * 売買区分'買建'を正の数量、'売建'を負の数量に変換し、詳細設計書で定義された辞書形式 ({'symbol': {'size': float, 'price': float}}) にデータを整形して返却するロジックを実装する。  
     * ファイルが存在しない、シート名が違う、データが不正（数値変換不可など）な場合に備え、try-exceptブロックでエラーを捕捉し、ログを出力した上で空の辞書を返すエラーハンドリングを実装する。  
  2. **単体テスト:**  
     * get\_positions()メソッドを直接呼び出し、サンプルExcelファイル（正常系、--------がない系、データが空の系）から正しくデータが読み取れることを確認するテストコードを作成または手動でテストする。

---

### **ステップ2: RealTradeStrategy の改修**

**目的:** 外部からの同期指示を受け付けるインターフェースを整備し、リアルタイムフェーズへの移行ロジックを実装する。

* **担当ファイル:** src/realtrade/strategy.py  
* **タスク:**  
  1. **プロパティ追加:**  
     * \_\_init\_\_メソッドにself.live \= Falseを追加する。  
  2. **start() メソッドのオーバーライド:**  
     * self.live \= Trueをセットし、リアルタイムフェーズへの移行を記録するロジックを追加する。  
     * 過去データ供給フェーズで生成されたシミュレーションポジションをクリア (self.close()) するロジックを追加する。  
  3. **同期用メソッドの新規実装:**  
     * **inject\_position(self, size, price):**  
       * self.position.size, self.position.priceを直接更新する。  
       * 更新後、self.exit\_signal\_generator.calculate\_and\_set\_exit\_prices(...)を呼び出し、決済価格を再計算させる処理を実装する。  
     * **force\_close\_position(self):**  
       * self.close()で内部ポジションを決済する。  
       * 決済シグナル生成器のtp\_price, sl\_priceをリセットする処理を実装する。  
  4. **next() メソッドのロジック修正:**  
     * メソッドの冒頭にif not self.live: returnを追加する。  
     * 既存のエントリーロジックをif not self.position:ブロックで囲み、ポジションがない場合のみ実行されるように修正する。

---

### **ステップ3: PositionSynchronizer の実装と統合**

**目的:** 中核機能である同期スレッドを実装し、システム全体を連携させる。

* **担当ファイル:** src/realtrade/run\_realtrade.py  
* **タスク:**  
  1. **RealtimeTrader クラスの修正:**  
     * StateManager関連のコード（初期化、Analyzerへの追加など）をすべて削除する。  
     * \_\_init\_\_にself.strategy\_instances \= {}を追加する。  
     * \_create\_cerebro\_for\_symbolメソッド内で、生成したStrategyインスタンスをself.strategy\_instances\[symbol\]に格納する処理を追加する。  
  2. **PositionSynchronizer スレッドクラスの新規実装:**  
     * 詳細設計書に基づき、threading.Threadを継承したクラスとして実装する。  
     * run()メソッド内に1秒ごとのループ処理を実装する。  
     * ループ内でExcelBridge.get\_positions()とRealTradeStrategyの内部ポジションを比較し、差異を検出するロジックを実装する。  
     * 差異があった場合に、対応するStrategyインスタンスのinject\_position()またはforce\_close\_position()を呼び出す同期指示ロジックを実装する。  
  3. **ライフサイクル管理:**  
     * RealtimeTrader.start()内でPositionSynchronizerスレッドをインスタンス化し、開始(start())する処理を追加する。  
     * RealtimeTrader.stop()内でスレッドの停止イベントをセットし、join()でスレッドの終了を待つ処理を追加する。

---

### **ステップ4: 結合テストとデバッグ**

**目的:** 全コンポーネントを連携させた状態で、仕様通りの動作を確認する。

* **テスト内容:**  
  1. **初期同期テスト:** 起動時にExcelにポジションが存在する場合、リアルタイム移行後に正しく内部ポジションが構築されることを確認する。  
  2. **新規ポジション同期テスト:** 実行中にExcelに新しいポジションを追加した場合、1秒以内にシステムが検知し、内部ポジションを構築することを確認する。  
  3. **決済ポジション同期テスト:** 実行中にExcelからポジションを削除した場合、1秒以内にシステムが検知し、内部ポジションを決済することを確認する。  
  4. **二重発注防止テスト:** Excelにポジションが存在する銘柄でエントリーシグナルが発生しても、新規発注が行われないことをログで確認する。  
  5. **決済ロジックテスト:** 内部ポジションのTP/SLが、Excelの建値に基づいて正しく計算・設定されていることをログで確認する。  
  6. **安定稼働テスト:** 数時間連続で稼働させ、メモリリークやスレッドの異常終了が発生しないことを確認する。