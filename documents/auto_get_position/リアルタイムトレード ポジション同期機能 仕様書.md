はい、承知いたしました。これまでの議論を踏まえ、リアルタイムトレードにおけるポジション同期機能の仕様書をMarkdown形式で作成します。

---

# **リアルタイムトレード ポジション同期機能 仕様書**

## **1\. 概要**

### **1.1. 目的**

本仕様は、リアルタイムトレーディングシステム（以下、本システム）が、backtrader内部で管理するシミュレーション上のポジションではなく、MarketSpeed II連携のExcelファイル (trading\_hub.xlsm) から取得した**実際の保有ポジションを正として取引判断を行う**ように機能を拡張することを目的とする。

### **1.2. 背景**

現状のシステムでは、取引判断の基準となるポジション情報がbacktraderエンジン内のシミュレーションに限定されている。そのため、手動での取引や外部ツールによるポジションの変更が発生した場合、システムの認識と実際の口座状況に乖離が生じ、不適切なエントリーシグナル（二重発注）や決済シグナルの遅延が発生するリスクがある。本改修により、常に実際の口座状況を監視し、それに即した一貫性のある取引判断を実現する。

### **1.3. 対象範囲**

* 本仕様の対象は、**リアルタイムトレードのRAKUTENモード**に限定する。  
* バックテスト機能 (src/backtest パッケージ) は、本改修の対象外とし、一切の変更を加えない。  
* 従来のSQLiteデータベース (realtrade\_state.db) によるポジション永続化機能は廃止する。

---

## **2\. 設計方針**

### **2.1. Excelを唯一の正とする (Single Source of Truth)**

リアルタイムデータ供給フェーズにおけるポジション情報は、Excelファイル trading\_hub.xlsm の **position シートが提供する情報を絶対的な正**とする。システムの内部状態は、このExcelの情報に追従するものとする。

### **2.2. フェーズ分離**

システムの動作を以下の2つのフェーズに明確に分離する。

1. **過去データ供給フェーズ**:  
   * システムの起動後、backtraderが履歴データ（CSV）を読み込んでいる期間。  
   * このフェーズでは、従来通りbacktrader内部のシミュレーションポジションに基づいて取引判断を行う。この期間の取引結果は、リアルタイムフェーズには引き継がれない。  
2. **リアルタイムデータ供給フェーズ**:  
   * 全ての過去データの供給が完了し、ライブデータに切り替わった後の期間。  
   * このフェーズでは、実ポジション情報に判断基準を完全に切り替え、Excelとの継続的な同期を行う。

### **2.3. 継続的な状態同期**

リアルタイムデータ供給フェーズでは、**1秒ごと**にExcelの実ポジション情報とbacktrader内の内部ポジションを比較し、差異があれば即座に内部状態を実態に合わせて動的に同期・更新し続ける。

---

## **3\. アーキテクチャ**

### **3.1. コンポーネントの役割**

| コンポーネント | 役割 |
| :---- | :---- |
| **ExcelBridge** | Excelとの通信全般を担当。価格情報に加え、positionシートから現在の実ポジション一覧を取得する機能を提供する。 |
| **ポジション同期スレッド**\<br\>(run\_realtrade.py内) | メインの取引スレッドとは独立して動作する。定期的にExcelBridge経由で実ポジションを取得し、backtraderの内部状態と比較。差異があればRealTradeStrategyに同期を指示する。 |
| **RealTradeStrategy** | backtraderのstart()メソッドをトリガーにリアルタイムフェーズへの移行を検知。取引ロジックをフェーズに応じて切り替え、同期スレッドからの指示（ポジション注入/強制決済）を実行する。 |

### **3.2. 動作フロー**

1. **起動**: RealtimeTraderが起動し、各銘柄のCerebroインスタンスを生成。同時に**ポジション同期スレッド**を開始する。ExcelBridgeは価格とポジション情報の監視を開始。  
2. **過去データ供給**: RakutenDataが過去データ(CSV)をbacktraderに供給する。この間、RealTradeStrategyはシミュレーション取引を実行する。  
3. **リアルタイム移行**:  
   * 全ての過去データ供給が完了すると、backtraderはRealTradeStrategyのstart()メソッドを呼び出す。  
   * start()メソッド内で、シミュレーション中に構築された内部ポジションをすべてクリアする。  
4. **継続的同期**:  
   * ポジション同期スレッドは、RealTradeStrategyがリアルタイムフェーズに移行したことを検知後、1秒間隔のループ処理を開始する。  
   * ループ内でExcelの実ポジションとbacktraderの内部ポジションを比較し、差異があればRealTradeStrategyに同期を指示する。  
5. **取引判断**:  
   * **エントリー**: エントリーシグナルが発生しても、Excel上にその銘柄の**実ポジションが存在しない場合にのみ**発注を実行する。  
   * **イグジット**:  
     * TP/SL価格は、Excelから同期された**実ポジションの建値**を基に算出する。  
     * Excelのpositionシートからポジション情報が削除された場合、システムはそれを検知し、内部ポジションをリセットする。

---

## **4\. 機能仕様**

### **4.1. 実ポジション情報の取得**

* **取得元ファイル**: trading\_hub.xlsm  
* **取得元シート**: position  
* **データ範囲**: 3行目から開始し、**A列のセルに \-------- という文字列が出現する**直前の行まで。  
* **取得項目**:

| 列 | セル範囲 | 内容 | 内部データ |
| :---- | :---- | :---- | :---- |
| A | A3, A4, ... | 銘柄コード | dictのキー (例: "1332") |
| G | G3, G4, ... | 売買区分 | sizeに変換 (買建→正, 売建→負) |
| H | H3, H4, ... | 建玉数量 | sizeの絶対値として利用 |
| J | J3, J4, ... | 建値 | priceとして利用 |

### **4.2. ポジション同期処理**

* **実行主体**: run\_realtrade.py 内のポジション同期スレッド  
* **実行間隔**: **1秒**  
* **同期ロジック**:  
  * **新規ポジション検知 (Excelにあり, 内部にない)**: RealTradeStrategy.inject\_position(size, price)を呼び出し、内部にポジションを構築する。  
  * **決済ポジション検知 (内部にあり, Excelにない)**: RealTradeStrategy.force\_close\_position()を呼び出し、内部ポジションをクリアする。  
  * **数量変更検知 (両方にあるがsizeが不一致)**: force\_close\_position()を呼び出した後、inject\_position()で正しいポジションを再構築する。

### **4.3. 取引判断ロジック**

* **エントリー条件**:  
  1. 戦略が定めるエントリーシグナルが成立すること。  
  2. **かつ**、ポジション同期スレッドが監視する実ポジション一覧に、当該銘柄が存在しないこと。  
* **決済条件**:  
  1. TP/SL価格（実ポジションの建値から算出）に到達した場合。  
  2. **または**、ポジション同期スレッドが、Excelから当該ポジションが削除されたことを検知した場合。