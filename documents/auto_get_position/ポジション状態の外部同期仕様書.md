はい、承知いたしました。Excelファイルを正としてシステム内のポジション状態を同期させる機能の仕様書を作成します。

---

## **ポジション状態の外部同期仕様書**

### **1\. 概要**

本仕様書は、システムの内部的なポジション保有状況を、Excelファイルに記載された「実際に保有している銘柄リスト」と定期的に同期させる機能について定義します。

手動でポジションを決済した後、運用者はExcelシートから該当銘柄を削除します。システムはこの変更を検知し、内部状態をリセットすることで、**システムを再起動することなく**次のエントリー判断へ進めるようにすることを目的とします。

---

### **2\. 同期元 (Source of Truth)**

* **ファイル**: trading\_hub.xlsm  
* **シート**: positionシート  
* **セル範囲**: **A列3行目**以降（A3, A4, ...）に記載された銘柄コードのリストを、実際に保有しているポジションのマスターリストとします。

---

### **3\. アーキテクチャ**

この機能は、既存のコンポーネントを拡張して実現します。

* **ExcelBridge (excel\_bridge.py)**  
  * **役割**: Excelのpositionシートを定期的に読み取り、現在保有中の銘柄リストをメモリ上に保持します。  
* **RealtimeTrader (run\_realtime.py)**  
  * **役割**: ExcelBridgeから最新の保有銘柄リストを取得し、Backtraderが内部で管理しているポジション状態と比較します。差異があった場合は、対象銘柄の取引スレッドをリセット（再起動）します。

---

### **4\. 実装詳細**

#### **4.1. src/realtrade/bridge/excel\_bridge.py の改修**

Excelから保有銘柄リストを読み取る機能を追加します。

* **\_\_init\_\_ メソッドの変更**  
  * 保有銘柄を効率的に管理するため、self.held\_positions というset（集合）を初期化します。  
* **\_data\_loop メソッドの変更**  
  * 既存のデータ読み取りループ内に、positionシートのA3以降を読み取る処理を追加します。  
* **新規メソッドの追加**  
  * RealtimeTraderが保有銘柄リストを取得するためのget\_held\_positions()メソッドを追加します。

#### **4.2. src/realtrade/run\_realtime.py の改修**

RealtimeTraderクラスに、状態を同期し、取引スレッドを再起動するロジックを追加します。

* **スレッド管理方法の変更**  
  * 各銘柄のスレッドとCerebroインスタンスを効率的に管理するため、シンボルをキーとした辞書型(dict)で保持するように変更します。  
* **ポジション同期スレッドの追加**  
  * \_position\_sync\_loopというメソッドを新設し、独立したスレッドで定期的に（例: 15秒ごと）実行します。  
* **同期ロジック**  
  * ループ内で、ExcelBridgeから取得した**実際のポジション**と、Backtraderが認識している**内部的なポジション**を比較します。  
  * 「内部的にポジションを持っている」にも関わらず「Excelのリストには存在しない」銘柄を**リセット対象**として特定します。  
* **リセット処理**  
  * リセット対象となった銘柄の古い取引スreadを安全に停止させ、クリーンな状態で新しい取引スレッドを再起動します。これにより、ポジションがリセットされ、新たなエントリー判断が可能になります。

---

### **5\. 処理フロー**

この機能を導入した場合の典型的な処理フローは以下の通りです。

1. **ポジション保有**: システムが銘柄1332のポジションを内部的に保有しているとします。  
2. **手動決済**: 運用者が証券会社のツール等を使い、銘柄1332のポジションを手動で決済します。  
3. **Excel更新**: 運用者はtrading\_hub.xlsmのpositionシートから1332の行を削除します。  
4. **変更検知**: ExcelBridgeが定期読み取り時に、保有リストから1332が消えたことを検知します。  
5. **同期処理**: RealtimeTraderの同期ループが、内部的には1332のポジションが残っているのにExcel上では消えているという**不整合**を発見します。  
6. **スレッド再起動**: RealtimeTraderは銘柄1332の取引スレッドを安全に停止し、その後、ポジション情報を持たない新しい取引スレッドを起動します。  
7. **待機状態へ**: 新しく起動された1332の取引スレッドは、ポジションを持っていないクリーンな状態のため、再びエントリー条件の監視を開始します。