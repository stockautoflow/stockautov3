# **詳細設計書：最終日強制決済トレードの記録機能**

## **1\. 目的**

現在のシステムでは、バックテスト期間の最終日に強制決済された未決済のトレードが、詳細な取引履歴レポート (trade\_history\_\*.csv) に記録されていない。

本改修は、これらのトレードもレポートに記録することで、戦略の最終的な状態や、期間終了時の含み損益が最終損益に与えた影響を正確に分析できるようにすることを目的とする。

## **2\. 課題**

* **現状**: run\_backtrader.py内のTradeListアナライザーは、notify\_tradeメソッド（＝トレードがルールに基づいてクローズされた時）でのみ取引を記録している。  
* **問題**: Backtraderがバックテスト終了時に未決済ポジションを強制決済する動作は、notify\_tradeをトリガーしない。そのため、この「最後のトレード」が記録から漏れてしまう。

## **3\. 解決方針**

バックテストのライフサイクルの最後に呼び出されるアナライザーのstop()メソッドを活用する。

run\_backtrader.py内のTradeListアナライザーにstop()メソッドを実装し、Backtrader標準のTradeAnalyzerが持つ全取引情報と、TradeListがnotify\_trade経由で記録した取引情報を比較する。

この比較によって「TradeListに記録されていないが、TradeAnalyzerには存在するトレード」を特定し、それを「最終日強制決済トレード」として手動でtrade\_historyに追加する。

## **4\. 実装仕様**

### **4.1. run\_backtrader.py の TradeList アナライザーの改修**

#### **4.1.1. stop() メソッドの追加**

TradeListクラスにstop()メソッドを追加する。このメソッドは、cerebro.run()の処理がすべて完了した後に自動的に呼び出される。

#### **4.1.2. 最終トレードの特定ロジック**

stop()メソッド内に以下のロジックを実装する。

1. 標準アナライザーの全取引を取得:  
   all\_trades\_by\_engine \= self.strategy.analyzers.trade.get\_analysis()  
   これにより、強制決済されたトレードを含む、Backtraderが認識している全てのトレード情報（損益、タイムスタンプ等）を取得する。  
2. TradeList記録済み取引との比較:  
   all\_trades\_by\_engineの各トレードについて、TradeListが既に記録しているself.tradesリストに同じ取引（エントリー日時や銘柄で識別）が存在するかを確認する。  
3. 未記録トレードの特定:  
   self.tradesに存在しないトレードが見つかった場合、それを最終日強制決済トレードと判断する。

#### **4.1.3. 取引記録の生成**

特定した未記録トレードについて、以下の仕様で取引記録（辞書オブジェクト）を生成し、self.tradesリストに追加する。

| 項目 | 値の取得元・設定値 |
| :---- | :---- |
| 銘柄 | 標準アナライザーのトレードオブジェクトから取得。 |
| 方向 | 標準アナライザーのトレードオブジェクトから取得。 |
| 数量 | 標準アナライザーのトレードオブジェクト (trade.size) から取得。 |
| エントリー価格 | 標準アナライザーのトレードオブジェクトから取得。 |
| エントリー日時 | 標準アナライザーのトレードオブジェクトから取得。 |
| エントリー根拠 | self.strategy.entry\_reason から取得（最後にエントリーした際の根拠が保持されている）。 |
| 決済価格 | notify\_tradeと同様に、エントリー価格・損益・数量から逆算して算出。 |
| 決済日時 | 標準アナライザーのトレードオブジェクトから取得。 |
| **決済根拠** | **"End of Backtest" という固定文字列を設定する。** |
| 損益 | 標準アナライザーのトレードオブジェクトから取得。 |
| 損益(手数料込) | 標準アナライザーのトレードオブジェクトから取得。 |
| ストップロス価格 | self.strategy.final\_sl\_price から取得。 |
| テイクプロフィット価格 | self.strategy.tp\_price から取得。 |

## **5\. 期待される結果**

改修後、trade\_history\_\*.csvレポートには、バックテスト終了時に未決済だったトレードが以下のように記録されるようになる。

* 決済根拠列に **"End of Backtest"** と記録される。  
* これにより、どのトレードが期間終了によって決済されたかを明確に識別できるようになる。  
* サマリーレポートの最終損益と、取引履歴の詳細な内訳との整合性が向上する。

## **6\. 影響範囲と注意点**

* **改修対象ファイル**: run\_backtrader.py のみ。  
* **注意点**: エントリー根拠は、最後にエントリーした際の理由がストラテジーオブジェクトに保持されていることを前提としている。現在の実装ではこの前提は満たされているが、将来的にストラテジーの構造を大きく変更する際には注意が必要。