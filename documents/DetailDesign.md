# **株自動トレードシステム 詳細設計書 (v20)**

## **1\. 概要**

### **1.1. システムの目的**

本システムは、高機能なバックテストフレームワーク **Backtrader** を利用し、取引戦略の有効性を効率的かつ詳細に検証することを目的とする。マルチタイムフレーム分析に基づいた戦略を、手数料などの現実的なコストを考慮して評価し、信頼性の高い結果を得ることを目指す。

### **1.2. アーキテクチャ**

本システムは、**バックテスト実行**と**チャート生成**の2つのプロセスに完全に分離されている。

1. run\_backtrader.pyがバックテスト計算に専念し、結果をCSVレポートとして出力する。  
2. chart\_generator.pyが、出力された取引履歴レポートを基に、**長期・中期・短期の3種類の**視覚的なチャート画像を生成する。

この分離により、計算処理の安定性を確保し、大量のバックテストを効率的に実行可能とする。

## **2\. 環境構築手順**

### **2.1. 手順**

1. **プロジェクトファイルの配置**: 全ファイルを **C:\\stockautov3** ディレクトリに配置する。  
2. **仮想環境の構築**:  
   cd C:\\stockautov3  
   python \-m venv venv  
   .\\venv\\Scripts\\activate

3. **ライブラリのインストール**:  
   python.exe \-m pip install \--upgrade pip  
   pip install \-r requirements.txt

4. ディレクトリの作成:  
   スクリプトの初回実行時に、data, log, backtest\_results, backtest\_results/report, backtest\_results/chart ディレクトリが自動で作成される。

## **3\. スクリプトの使用方法**

1. **バックテストの実行**:  
   python run\_backtrader.py

2. **チャートの生成**:  
   python chart\_generator.py

## **4\. モジュール別詳細仕様**

### **4.1. requirements.txt**

* **役割**: プロジェクトの実行に必要なPythonライブラリとそのバージョンを定義する。  
* **主要な内容**:  
  * backtrader: バックテストのコアエンジン。  
  * pandas, numpy: データ分析と数値計算の基盤。  
  * PyYAML: strategy.ymlなどの設定ファイルを読み込むために使用。  
  * mplfinance: chart\_generator.pyで高品質な金融チャートを描画するために使用。  
  * matplotlib: チャートの凡例などを追加するために使用。

### **4.2. config\_backtrader.py**

* **役割**: システム全体で共有される静的な設定値を管理する。  
* **主要な内容**:  
  * **ディレクトリパス**: DATA\_DIR, RESULTS\_DIR, LOG\_DIR, REPORT\_DIR, CHART\_DIRを定義。  
  * **バックテスト共通設定**: INITIAL\_CAPITAL（初期資金）、COMMISSION\_PERC（手数料率）、SLIPPAGE\_PERC（スリッページ率）などを定義。  
  * **ロギング設定**: LOG\_LEVELでログの詳細度（INFOまたはDEBUG）を制御する。

### **4.3. strategy.yml**

* **役割**: 取引戦略のパラメータを人間が編集しやすい形式で管理する。コードを変更せずに戦略の挙動を調整できる。  
* **主要な内容**:  
  * trading\_mode: long\_enabledとshort\_enabledのブール値で、**ロング戦略とショート戦略の有効/無効を個別に切り替える**。  
  * timeframes: 長期・中期・短期の時間足と圧縮率を定義。  
  * indicators: 各テクニカル指標の期間（period）を設定。  
  * filters: エントリー条件で使用するフィルターの閾値を設定。  
  * exit\_rules: 損切り・利確のATR倍率を設定。  
  * sizing: ポジションサイズ計算に用いるリスク割合を設定。

### **4.4. email\_config.yml**

* **役割**: メール送信に関する機密情報（ID、パスワード等）をコード本体から分離し、セキュリティを確保する。  
* **主要な内容**:  
  * ENABLED: メール通知機能の有効/無効を切り替えるフラグ。  
  * SMTP\_SERVER, SMTP\_PORT: 送信に使用するメールサーバーの情報。  
  * SMTP\_USER, SMTP\_PASSWORD: 認証情報。  
  * RECIPIENT\_EMAIL: 通知を受け取るメールアドレス。

### **4.5. logger\_setup.py**

* **役割**: Python標準のloggingモジュールを設定し、一元的なログ管理機能を提供する。  
* **主要な内容**: setup\_logging()  
  * 実行時のタイムスタンプに基づき、log/backtest\_YYYY-MM-DD-HHMMSS.logというユニークなファイル名を生成する。  
  * ログのフォーマットを時間 \- レベル \- モジュール名 \- メッセージに統一する。  
  * ログの出力先を、コンソール（画面）と上記ログファイルの両方に設定する。

### **4.6. notifier.py**

* **役割**: メール通知機能の実装。  
* **主要な内容**: send\_email(subject, body)  
  * email\_config.ymlを読み込み、通知が有効になっているか確認する。  
  * 有効な場合、Python標準のsmtplibを使い、設定情報に基づいてメールを作成し送信する。

### **4.7. btrader\_strategy.py**

* **役割**: Backtrader.Strategyを継承し、取引戦略のコアロジックを実装する。  
* **主要な内容**:  
  * **\_\_init\_\_(self)**:  
    * strategy.ymlを読み込み、パラメータをインスタンス変数に保持する。  
    * self.datasから各時間足のデータフィードへの参照を作成する。  
    * strategy.ymlのパラメータを基に、必要なテクニカル指標（EMA, RSI, ATRなど）をすべてインスタンス化する。  
    * 取引ごとの情報を保持するためのインスタンス変数（self.order, self.sl\_price, self.tp\_priceなど）を初期化する。  
  * **next(self)**:  
    * 毎ローソク足ごとに呼び出されるメインロジック。  
    * strategy.ymlのtrading\_mode設定に従い、**ロング戦略とショート戦略のロジックを条件分岐**させる。  
    * **ロング条件**: 長期EMAが上向き、かつ短期EMAがゴールデンクロスした場合にbuy\_bracket()でOCO注文を発注する。  
    * **ショート条件**: 長期EMAが下向き、かつ短期EMAがデッドクロスした場合にsell\_bracket()でOCO注文を発注する。  
    * 注文前に、ATRベースで計算した損切り価格と利確価格をインスタンス変数（self.sl\_price, self.tp\_price）に保存する。  
  * **notify\_trade(self, trade)**:  
    * 取引の開始と終了を検知する。取引開始時にロットサイズをself.trade\_sizeに保存し、後のアナライザーでの計算に備える。

### **4.8. report\_generator.py**

* **役割**: 複数のバックテスト結果を集約し、人間が読みやすい形式の総合サマリーレポートを生成する。  
* **主要な内容**: generate\_report(...)  
  * 全銘柄のraw\_statsリストとstrategy.ymlのパラメータを受け取る。  
  * 純利益、勝率、プロフィットファクターなどのパフォーマンス指標を**全体で合算・再計算**する。  
  * 計算結果に基づき、「総損益」「勝率」などに対する定性的な評価コメントを生成する。  
  * **strategy.ymlのtrading\_mode設定を読み取り**、レポートに記載する戦略の説明文（「Long Only」「Short Only」「Long/Short」など）を動的に生成する。  
  * これら全ての情報を整形し、最終的なpandas.DataFrameとして返す。

### **4.9. run\_backtrader.py**

* **役割**: バックテスト全体の実行を管理し、レポートファイル（CSV）を出力する。  
* **主要な内容**:  
  * **TradeList(bt.Analyzer)**: 取引履歴を詳細に記録するためのカスタムアナライザー。  
    * 取引開始時に、**取引サイズ**、エントリー根拠、**損切り・利確価格**、インジケーターの値を辞書に一時保存する。  
    * 取引決済時に、一時保存した情報と決済時の情報（損益など）を組み合わせて、1行の取引記録を作成する。  
    * 決済価格は、エントリー価格と損益（pnl）、保存しておいた取引サイズから**正確に逆算**する。  
    * Backtraderから受け取る日時は、タイムゾーン情報を取り除いてからCSVに出力する。  
  * **run\_backtest\_for\_symbol(...)**:  
    * pandasでCSVファイルをutf-8-sigエンコーディングで読み込む。  
    * Cerebroエンジンを初期化し、stdstats=Falseで標準のプロットを無効化する。  
    * PandasDataフィードとしてデータを追加し、resampledataで他の時間足を生成する。  
    * ブローカー設定（初期資金、手数料、スリッページ）を行う。  
    * cerebro.run()でバックテストを実行し、アナライザーから数値結果と取引リストを抽出して返す。  
  * **main()**:  
    * 全必須ディレクトリの存在を確認・作成する。  
    * dataディレクトリ内の全CSVファイルに対してrun\_backtest\_for\_symbolをループ実行し、結果をリストに集約する。  
    * report\_generatorを呼び出して総合サマリーレポートを作成・保存する。  
    * 集計したデータから、銘柄別詳細レポートと統合取引履歴レポートをそれぞれ作成・保存する。

### **4.10. chart\_generator.py**

* **役割**: バックテスト完了後、取引履歴を視覚化するための**3種類のチャート画像**を生成する。計算処理から完全に分離されている。  
* **主要な内容**: plot\_multi\_timeframe\_charts()  
  * reportディレクトリから最新の取引履歴CSV（trade\_history\_...）を探して読み込む。  
  * dataディレクトリ内の全銘柄を対象にループ処理を行う。  
  * resample\_ohlcヘルパー関数を使い、5分足の元データから各時間足（60分、日足）のデータを生成する。  
  * **チャート①（短期）**: 5分足データに短期EMA、売買マーカー、損切り・利確ラインをプロットし、凡例を付けて保存する。  
  * **チャート②（中期）**: 60分足データにRSIと閾値ラインをプロットして保存する。  
  * **チャート③（長期）**: 日足データに長期EMAをプロットし、凡例を付けて保存する。  
  * **タイムゾーン処理**: 読み込んだ価格データと取引履歴データの両方について、タイムゾーン情報を削除し、データの不整合を防ぐ。