# **株自動トレードシステム 詳細設計書 (v73.7)**

## **1\. 概要**

### **1.1. システムの目的**

本システムは、**Backtrader**による堅牢なバックテスト機能と、**Flask \+ Plotly**によるインタラクティブな分析UIを組み合わせ、取引戦略の検証と改善サイクルを高速化することを目的とする。

### **1.2. アーキテクチャ**

システムは、以下の3つの主要コンポーネントで構成される。

1. **バックテストエンジン (run\_backtrader.py, btrader\_strategy.py)**: strategy.ymlに定義されたルールを動的に解釈してバックテストを実行し、結果をCSVレポートに出力する。  
2. **Webアプリケーションサーバー (app.py)**: Flaskをベースとし、ブラウザからのリクエストに応じてチャート生成モジュールを呼び出し、結果を動的に表示するWebページを提供する。  
3. **チャート生成モジュール (chart\_generator.py)**: app.pyからライブラリとして呼び出され、価格データとインジケーターパラメータに基づき、PlotlyのグラフオブジェクトをJSON形式で生成する。

## **2\. 環境構築手順**

1. **プロジェクトファイルの配置**: 全ファイルを単一のディレクトリに配置する。  
2. **仮想環境の構築 (推奨)**:  
   python \-m venv venv  
   .\\venv\\Scripts\\activate  \# Windowsの場合  
   \# source venv/bin/activate  \# macOS/Linuxの場合

3. **ライブラリのインストール**:  
   pip install \-r requirements.txt

## **3\. スクリプトの使用方法**

1. **バックテストの実行（取引履歴の更新が必要な場合）**:  
   python run\_backtrader.py

2. **Web分析ツールの起動**:  
   python app.py

3. **ブラウザでアクセス**:  
   * Webブラウザで http://127.0.0.1:5001 を開く。

## **4\. モジュール別詳細仕様**

### **4.1. requirements.txt**

* **役割**: プロジェクトの実行に必要なPythonライブラリとそのバージョンを定義する。  
* **主要な内容**: backtrader, pandas, numpy, PyYAML, plotly, Flask。

### **4.2. config\_backtrader.py**

* **役割**: システム全体で共有される静的な設定値を管理する。  
* **主要な内容**: ディレクトリパス、初期資金、手数料率、スリッページ率、ログレベル。

### **4.3. strategy.yml**

* **役割**: 取引戦略の**ロジックとパラメータ**を人間が編集しやすい形式で一元管理する。  
* **主要な内容**:  
  * trading\_mode: ロング/ショート戦略の有効/無効を切り替える。  
  * timeframes: 長期・中期・短期の時間足と圧縮率を定義。  
  * entry\_conditions: **エントリー戦略のコアロジックを定義する。**  
  * exit\_conditions: ATRに基づいた**損切り・利確ルール**を定義する。stop\_lossでは固定損切り(atr\_multiple)とトレーリング損切り(atr\_stoptrail)を選択可能。  
  * sizing: 1トレードあたりのリスク許容度に基づいた**ポジションサイズ計算ルール**を定義する。  
  * indicators: Web UIで表示する各テクニカル指標の**表示上のデフォルト値**を定義する。**バックテストのロジックには直接影響しない。**

### **4.4. email\_config.yml**

* **役割**: メール送信に関する機密情報（ID、パスワード等）をコード本体から分離し、セキュリティを確保する。

### **4.5. logger\_setup.py**

* **役割**: Python標準のloggingモジュールを設定し、一元的なログ管理機能を提供する。コンソールとファイルの両方に出力する。

### **4.6. notifier.py**

* **役割**: email\_config.ymlに基づき、バックテスト完了時にメール通知を行う。

### **4.7. btrader\_strategy.py**

* **役割**: strategy.ymlを動的に解釈する汎用的な戦略実行エンジン。  
* **主要な内容**:  
  * \_\_init\_\_: 戦略で使用する全インジケーターを事前に一度だけインスタンス化し、辞書に保持する。  
  * \_evaluate\_condition: YAMLに定義された単一の条件（例: ema \> closeやema1 crossover ema2）を評価するヘルパー関数。  
  * next:  
    * **ポジションがない場合**: \_check\_all\_conditions()を呼び出し、エントリー条件を評価。条件が満たされた場合、sizingとexit\_conditionsに基づき**リスク計算、ポジションサイズ、損切り/利確価格を決定**し、エントリー注文 (self.buy()/self.sell()) を発注する。  
  * notify\_order:  
    * 注文状態を監視し、ログを出力する。  
    * エントリー注文が約定した場合、定義されていれば**OCOで連携された損切り注文と利確注文を続いて発注**する。  
  * notify\_trade:  
    * トレード開始時(isopen)に、そのトレードの**正確な約定数量**(trade.size)と**エントリー根拠**(self.entry\_reason)を変数に保存する。  
    * トレード完了時(isclosed)に、開始時に保存した数量とエントリー根拠をtradeオブジェクトにカスタム属性としてアタッチする。これにより、TradeListアナライザーが正しい情報を取得できるようになる。

### **4.8. report\_generator.py**

* **役割**: 複数のバックテスト結果を集約し、人間が読みやすい形式の総合サマリーレポートを生成する。  
* **主要な内容**:  
  * 全銘柄のraw\_statsリストとstrategy.ymlのパラメータを受け取る。  
  * 純利益、勝率、プロフィットファクターなどのパフォーマンス指標を**全体で合算・再計算**する。  
  * 計算結果に基づき、「総損益」「勝率」などに対する定性的な評価コメントを生成する。  
  * strategy.ymlからエントリー/イグジットロジックの説明文を動的に生成する。  
  * これら全ての情報を整形し、最終的なpandas.DataFrameとして返す。

### **4.9. run\_backtrader.py**

* **役割**: バックテスト全体の実行を管理し、レポートファイル（CSV）を出力する。  
* **主要な内容**:  
  * TradeList(bt.Analyzer): 取引履歴を詳細に記録するためのカスタムアナライザー。  
    * notify\_trade: 決済済みトレードの情報を記録する。**数量**と**エントリー根拠**は、btrader\_strategyがtradeオブジェクトに付与したカスタム属性から取得する。  
    * stop: バックテスト終了時に未決済のポジションが残っている場合、その時点の終値で強制決済されたものとみなし、損益を計算する。**手数料はconfig.COMMISSION\_PERCから手動で正しく計算される。**  
  * run\_backtest\_for\_symbol: 単一銘柄のバックテストを実行し、アナライザーから結果を抽出して返す。  
  * main: dataディレクトリ内の全CSVファイルに対してループ処理を行い、report\_generatorを呼び出して3種類のレポート（サマリー、詳細、取引履歴）をCSVファイルとして保存する。

### **4.10. app.py (Webアプリケーションサーバー)**

* **役割**: Flaskサーバーを起動し、フロントエンドとバックエンドの橋渡しを行う。  
* **主要なエンドポイント**:  
  * @app.route('/'): メインページ (index.html) を描画する。  
  * @app.route('/get\_chart\_data'): ブラウザからの非同期リクエストを受け付け、chart\_generatorを呼び出してチャートと取引履歴のJSONデータを返すAPI。  
* **起動処理**: サーバー起動時にchart\_generator.load\_data()を一度だけ呼び出し、価格データと取引履歴をメモリにキャッシュする。

### **4.11. templates/index.html (フロントエンドUI)**

* **役割**: ユーザーインターフェースの構造を定義し、チャートの動的更新ロジックを実装する。  
* **主要なコンポーネント**:  
  * **コントロールパネル**: 銘柄と時間足の選択、および各インジケーターのパラメータ変更フォームを配置。  
  * **チャート表示領域**: Plotlyのグラフが描画される\<div\>タグ。  
  * **取引履歴テーブル**: チャートの下部に配置。  
* **主要なJavaScriptロジック**:  
  * updateChart(): コントロールパネルの値をAPIに送信し、返されたJSONでチャートとテーブルを更新する。  
  * highlightTradeOnChart(): テーブル行のクリックに連動し、チャート上の取引期間をハイライトする。

### **4.12. chart\_generator.py (チャート生成モジュール)**

* **役割**: app.pyから呼び出されるライブラリとして、Plotlyのグラフオブジェクトを生成する。  
* **主要な関数**:  
  * load\_data(): アプリケーション起動時に一度だけ呼ばれ、必要なCSVデータをキャッシュに読み込む。  
  * generate\_chart\_json(): キャッシュから価格データを取得し、リクエストされたパラメータに基づき各種テクニカル指標を動的に計算し、Plotlyのグラフオブジェクトを構築してJSON形式で返す。  
  * get\_trades\_for\_symbol(): キャッシュから指定された銘柄の取引履歴データを抽出して返す。