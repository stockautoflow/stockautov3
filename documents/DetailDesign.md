# **株自動トレードシステム 詳細仕様書 (Backtrader版 v13)**

## **1\. 概要**

### **1.1. システムの目的**

本システムは、高機能なバックテストフレームワーク **Backtrader** を利用し、取引戦略の有効性を効率的かつ詳細に検証することを目的とする。マルチタイムフレーム分析に基づいた戦略を、手数料などの現実的なコストを考慮して評価し、信頼性の高い結果を得ることを目指す。

### **1.2. アーキテクチャ**

本システムは Backtrader のイベント駆動型アーキテクチャを採用している。中心的な役割を担う **Cerebro** (スペイン語で「脳」) エンジンが、データフィード、戦略ロジック、ブローカー（資金管理）、アナライザーを統合管理する。これにより、開発者は取引ロジックそのものに集中できる。

\[CSVデータファイル\]  
       |  
       V  
\[run\_backtrader.py\] \-- Cerebroエンジンを制御  
       |  
       \+--- \[ロガー\] \--\> \[log/backtest\_日付.log\]  
       |  
       \+--- \[データフィード\] \<-- (ベースとなる5分足データをロード)  
       |       |  
       |       \+-- (1時間足、日足へリサンプリング)  
       |  
       \+--- \[戦略クラス: btrader\_strategy.py\] \<-- (取引ロジックを定義)  
       |       |  
       |       \+-- \[インジケーター\]  
       |       \+-- \[パラメータ: strategy.yml\]  
       |  
       \+--- \[ブローカー\] \<-- (資金管理、手数料計算)  
       |  
       \+--- \[アナライザー\] \<-- (パフォーマンス分析)  
       |  
       V  
\[結果ファイル (レポートCSV)\]

## **2\. 環境構築手順**

### **2.1. 前提条件**

* Python (バージョン 3.8 ～ 3.11 を推奨) がインストールされていること。

### **2.2. 手順**

1. プロジェクトファイルの配置:  
   提供された全ファイル（.py, .yml）を C:\\stockautov3 ディレクトリに配置する。  
2. 仮想環境の構築（推奨）:  
   コマンドプロンプトやターミナルを開き、プロジェクトを配置したディレクトリで以下のコマンドを実行する。  
   \# プロジェクトディレクトリに移動  
   cd C:\\stockautov3

   \# 仮想環境の作成  
   python \-m venv venv

   \# 仮想環境の有効化 (Windowsの場合)  
   .\\venv\\Scripts\\activate

3. 必要なライブラリのインストール:  
   requirements.txt を使用して、必要なPythonライブラリを一括でインストールする。  
   python.exe \-m pip install \--upgrade pip  
   pip install \-r requirements.txt

4. ディレクトリの作成:  
   スクリプトの初回実行時に、data, log, backtest\_results, backtest\_results/report ディレクトリが自動で作成される。  
5. 株価データの配置:  
   dataディレクトリ内に、バックテスト対象の株価データCSVファイルを配置する。ファイルは文字コード UTF-8 (BOM付き) で保存されていることを推奨する。  
   * **ファイル命名規則**: 銘柄コード\_5m\_日付.csv (5分足データ)  
   * **例**: 1332\_5m\_20240112.csv  
6. **設定ファイルの編集**:  
   * strategy.yml: 必要に応じて取引戦略のパラメータを調整する。  
   * email\_config.yml: メール通知機能を使用する場合、このファイルをご自身の情報を設定する。  
   * config\_backtrader.py: 手数料やスリッページなどの基本設定を編集する。

## **3\. スクリプトの使用方法**

環境構築完了後、以下のコマンドでバックテストを実行する。

* **コマンド**:  
  python run\_backtrader.py

* **実行内容**:  
  1. dataディレクトリ内の全銘柄を対象に、バックテストを自動で実行する。  
  2. 全ての銘柄のテストが完了すると、backtest\_results/reportにタイムスタンプ付きの summary\_... .csv が作成され、内容がコンソールに表示される。  
  3. メール通知が有効な場合、サマリーレポートがメールで送信される。

## **4\. ファイル構成と役割**

| ファイル名 | 役割 |
| :---- | :---- |
| run\_backtrader.py | **メイン実行ファイル**。バックテストの実行と**統合レポートの生成**を行う。 |
| strategy.yml | **戦略パラメータ設定ファイル**。インジケーターの期間やポジションサイズのリスク割合などを管理する。 |
| report\_generator.py | **レポート生成モジュール**。集計されたバックテスト結果と\*\*strategy.ymlのパラメータ\*\*から、3部構成の詳細なレポートを動的に作成する。 |
| btrader\_strategy.py | **取引戦略定義ファイル**。nextメソッド内に、**ATRベースのポジションサイズ計算ロジック**を実装する。 |
| config\_backtrader.py | **システム全体の設定ファイル**。各種ディレクトリパスやログレベルなどを管理する。 |
| logger\_setup.py | **ロギング設定モジュール**。システム全体のログ出力形式や保存先を一元管理する。 |
| requirements.txt | **依存ライブラリ定義ファイル**。必要なPythonパッケージをリスト化する。 |
| notifier.py | **通知機能モジュール**。email\_config.ymlを読み込み、メールを送信する。 |

## **5\. バックテスト処理フロー**

1. \*\*run\_backtrader.py\*\*が、利用可能な全銘柄に対してバックテストをループ実行する。  
2. ループ内で、各銘柄の数値結果（総利益、総損失、取引回数など）をリストに集約する。  
3. 全銘柄のテスト完了後、集約した結果とstrategy.ymlの情報を **report\_generator.py** に渡す。  
4. report\_generator.pyは、渡された情報から**分析条件（動的生成）、パフォーマンス指標、定性評価**の各セクションを組み立てる。  
5. 完成したレポートをDataFrameとしてrun\_backtrader.pyに返し、CSVファイルとして保存・メール通知する。

## **6\. 戦略定義**

現在の戦略は btrader\_strategy.py と strategy.yml によって定義されている。

### **6.1. エントリー条件（買い）**

以下の3つの条件をすべて満たした足の終値でエントリーする。

1. **長期フィルター（日足）**: 日足の終値が200日EMAより上にある（上昇トレンド）。  
2. **中期フィルター（60分足）**: 60分足のRSIが30～70の範囲内にある（過熱感がない）。  
3. **短期トリガー（5分足）**: 5分足で短期EMA(10)が長期EMA(25)を上抜ける（ゴールデンクロス）。

### **6.2. 決済条件**

エントリーと同時に、\*\*ブラケット注文（OCO注文）\*\*が自動で設定される。

* **利益確定**: エントリー価格 \+ (ATR × take\_profit\_atr\_multiplier)  
* **損切り**: エントリー価格 \- (ATR × stop\_loss\_atr\_multiplier)

### **6.3. ポジションサイジング**

* **モデル**: ATRベースのリスク均等化モデル  
* **計算式**:  
  1. 許容損失額 \= 総資金 × risk\_per\_trade  
  2. 1株あたりリスク \= ATR × stop\_loss\_atr\_multiplier  
  3. ロット数 \= 許容損失額 / 1株あたりリスク  
* **目的**: 相場のボラティリティ（ATR）に応じてロット数を調整し、1トレードあたりの潜在的損失額を資金の一定割合に保つ。

## **7\. モジュール別詳細仕様**

詳細なロジックは各Pythonファイルの実装コードを参照。