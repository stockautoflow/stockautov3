## **テスト実施手順書: 状態復元機能**

### **1. 目的**

本テストは、リアルタイムトレードシステムの実行中にポジションを保有した状態でシステムが停止・再起動した際に、データベースに保存されたポジション情報が正しく復元され、取引が問題なく継続されることを確認するために実施します。

### **2. テスト環境**

  * **実行コマンド**: `python main.py rr`
  * **設定ファイル**:
      * `src/realtrade/config_realtrade.py` (`LIVE_TRADING = True`)
      * `.env` (必要に応じてAPIキーなどを設定)
  * **確認対象**:
      * コンソールの標準出力
      * `log/realtime_*.log` ファイル
      * `results/realtrade/realtrade_state.db` ファイル

### **3. 事前準備**

1.  **コンポーネントの生成**: プロジェクトの全コンポーネントが最新の状態であることを確認します。必要であれば、以下のコマンドを実行してください。

    ```bash
    python main.py ga
    ```

2.  **クリーンアップ**: テストの冪等性（べきとうせい）を確保するため、前回のテストで生成されたログとデータベースファイルを削除します。

      * `log/` ディレクトリ内の `realtime_*.log` ファイルを削除
      * `results/realtrade/realtrade_state.db` ファイルを削除

3.  **データファイルの確認**:

      * バックテスト・リアルタイムトレードに必要な各種データが `data/` ディレクトリに配置されていることを確認してください。
      * `results/evaluation/` ディレクトリ配下に、銘柄ごとの推奨戦略を記録した `all_recommend_*.csv` ファイルが存在することを確認してください。

-----

### **4. テスト手順**

#### **テストケース1: ポジションなしでの正常起動**

**目的**: クリーンな状態でシステムがエラーなく起動することを確認します。

| 手順 | 期待する結果 |
| :--- | :--- |
| 1. 「3. 事前準備」に記載のクリーンアップを実施します。 | `realtrade_state.db` と関連ログファイルが削除されている。 |
| 2. `python main.py rr` コマンドでリアルタイムトレードシステムを起動します。 | ・システムがエラーなく起動する。\<br\>・起動ログに「DBから0件のポジションをロードしました。」と表示される。\<br\>・ポジション復元に関するログが出力されず、通常のエントリー条件監視状態に移行する。 |
| 3. `Ctrl+C` でシステムを停止します。 | 正常にシャットダウン処理が行われる。 |

-----

#### **テストケース2: 単一ポジションの状態復元**

**目的**: システム再起動時に、単一の保有ポジションが正しく復元されることを確認します。

| 手順 | 期待する結果 |
| :--- | :--- |
| 1. 「3. 事前準備」に記載のクリーンアップを実施します。 | `realtime_state.db` と関連ログファイルが削除されている。 |
| 2. `python main.py rr` でシステムを起動し、いずれかの銘柄でポジションがエントリーされるまで待機します。 | ・エントリーログ（`BUY CREATE` または `SELL CREATE`）が出力される。\<br\>・`StateManager: ポジションをDBに保存/更新...` というログが出力される。 |
| 3. `results/realtrade/realtrade_state.db` を確認し、`positions` テーブルに1件のレコードが記録されていることを確認します。（DBブラウザ等を使用） | ポジション情報（銘柄コード、サイズ、価格、日時）が正しく保存されている。 |
| 4. `Ctrl+C` でシステムを停止します。 | 正常にシャットダウン処理が行われる。 |
| 5. **`realtrade_state.db` を削除せず**、再度 `python main.py rr` コマンドでシステムを起動します。 | ・起動ログに「DBから1件の既存ポジションを検出しました。」と表示される。\<br\>・該当銘柄のログに「状態復元モードで開始...」というメッセージが表示される。\<br\>・続いて「ポジション復元完了...」というログが表示され、復元されたポジションのサイズ、価格、計算されたSL/TP価格が正しく表示される。 |
| 6. ログを確認し、復元された銘柄に対して、**新規のエントリーロジックが実行されず**、決済監視ロジック（`_check_live_exit_conditions`）のみが動作している状態であることを確認します。 | 新規の `BUY/SELL CREATE` ログが当該銘柄に対して出力されない。 |
| 7. `Ctrl+C` でシステムを停止します。 | 正常にシャットダウン処理が行われる。 |

-----

#### **テストケース3: 復元後のポジション決済**

**目的**: 復元されたポジションが、決済条件を満たした際に正しく決済されることを確認します。

| 手順 | 期待する結果 |
| :--- | :--- |
| 1. テストケース2の手順5までを実施し、ポジションが復元された状態でシステムを稼働させ続けます。 | ポジションが復元され、決済監視状態にある。 |
| 2. 復元時に計算された利確（TP）または損切り（SL）価格に市場価格が達するまで待機します。 | - |
| 3. 決済条件がヒットした際のログを確認します。 | ・`ライブ: 利確条件ヒット...` または `ライブ: 損切り条件ヒット...` というログが出力される。\<br\>・決済注文が実行され、`トレード終了...` というログが出力される。 |
| 4. `StateManager` のログを確認します。 | `StateManager: ポジションをDBから削除...` というログが出力される。 |
| 5. `results/realtrade/realtrade_state.db` を確認し、`positions` テーブルから該当のレコードが削除されている（テーブルが空になっている）ことを確認します。 | `positions` テーブルにレコードが存在しない。 |
| 6. `Ctrl+C` でシステムを停止します。 | 正常にシャットダウン処理が行われる。 |

-----

以上でテスト手順は完了です。各ケースで期待通りの結果となれば、状態復元機能は正常に実装されています。