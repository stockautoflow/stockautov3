# 仕様書: 全戦略のバックテスト実行スクリプト: run_all_strategies.py

## 1. 概要

本スクリプト（`run_all_strategies.py`）は、`strategies.yml` ファイルに定義された複数のトレード戦略に対し、バックテストを連続で自動実行し、その結果を戦略ごとに整理して保存するマスターコントローラです。

最終的に、全戦略のパフォーマンスを一覧で比較・評価できる統合サマリーレポートを生成することを目的とします。

---

## 2. 前提条件

### 2.1. 必要なファイル・ディレクトリ構成

本スクリプトを実行する前に、以下のファイルとディレクトリが正しく配置されている必要があります。


```plaintext
/ (プロジェクトルート)
|
|-- run_all_strategies.py     # 本スクリプト
|-- create_project_files.py     # プロジェクトファイル生成スクリプト
|-- run_backtrader.py         # 個別バックテスト実行スクリプト
|-- btrader_strategy.py       # (create_project_files.pyにより生成)
|-- strategies.yml            # ★全ての戦略定義を記述したYAMLファイル
|-- strategy.yml              # 個別テスト用のベース設定ファイル
|
|-- data/
|   |-- (銘柄コード)(足)m(日付).csv  # バックテスト用データ
|   +-- ...
|
+-- venv/                       # Python仮想環境 (推奨)

```

### 2.2. 必要なライブラリ

`requirements.txt` に記載されたライブラリがインストールされている必要があります。


pip install -r requirements.txt


---

## 3. 機能仕様

本スクリプトは、以下のステップで処理を実行します。

### 3.1. 初期設定

1.  **ロギング設定:**
    * 実行時のすべてのコンソール出力と内部ログを、ファイルとコンソールの両方に出力するよう設定します。
    * ログファイルは、結果保存用の日時付きディレクトリ内に `run_all_strategies_(日時).log` という名前で生成されます。

2.  **結果保存ディレクトリの作成:**
    * プロジェクトルートに `all_strategies_results/` ディレクトリを作成します。
    * その内部に、実行日時で一意に識別されるサブディレクトリ（例: `2025-06-23_040400/`）を作成し、今回の実行結果をすべて格納します。

### 3.2. 戦略定義の読み込み

1.  **YAMLファイルの読み込み:**
    * プロジェクトルートにある `strategies.yml` ファイルを読み込み、定義されている全戦略のリストを取得します。

2.  **読み込みエラー処理:**
    * `strategies.yml` が存在しない、またはYAMLの構文が不正である場合は、エラーログを出力して処理を中断します。

### 3.3. バックテストの反復実行

読み込んだ戦略リストの各戦略に対し、以下のループ処理を実行します。

1.  **戦略ごとの結果フォルダ作成:**
    * 日時付きディレクトリ内に、戦略名に基づいた個別の結果保存フォルダを作成します。（例: `strategy_01_SMA_RSI_EMAクロス_基本形/`）

2.  **未サポート戦略のスキップ:**
    * `strategies.yml` 内で `unsupported: true` というフラグが立てられている戦略を検知します。
    * 該当する場合、警告ログを出力し、その戦略のバックテストは実行せずにスキップします。

3.  **一時的な設定ファイルの生成:**
    * `strategy.yml`（手動テスト用のベース設定ファイル）を雛形として読み込みます。
    * その内容を、現在ループ処理中の戦略の名前（`strategy_name`）とエントリー条件（`entry_conditions`）で動的に上書きします。
    * この一時的な設定を、再度 `strategy.yml` という名前で保存します。これにより、`run_backtrader.py` は常にこの最新の設定を読み込んで動作します。

4.  **バックテストの実行:**
    * `run_backtrader.py` をPythonのサブプロセスとして呼び出します。
    * この際、現在 `run_all_strategies.py` を実行しているPython環境（仮想環境など）を正しく引き継ぎ、ライブラリの依存関係の問題を防ぎます。
    * `run_backtrader.py` の標準出力および標準エラー出力はすべてキャプチャされ、メインのログファイルに記録されます。

5.  **結果レポートの移動:**
    * バックテストが正常に完了した場合、`backtest_results/report/` ディレクトリに生成された最新のレポートファイル群（`summary_*.csv`, `detail_*.csv`, `trade_history_*.csv`）を、手順1で作成した戦略ごとの結果フォルダ内に移動・リネームします。（例: `summary.csv`）

### 3.4. 統合サマリーレポートの生成

全ての戦略のループ処理が完了した後、以下の処理を実行します。

1.  **個別サマリーの収集:**
    * 各戦略の結果フォルダに保存された `summary.csv` をすべて検索し、発見します。

2.  **データ統合:**
    * 見つかったすべての `summary.csv` の内容を読み込み、Pandas DataFrameを使って一つの巨大なテーブルに統合します。

3.  **整形とソート:**
    * 純利益やプロフィットファクターなどの数値を計算可能なデータ型に変換します。
    * 最終的な結果を**純利益の高い順**に並べ替えます。

4.  **最終レポートの出力:**
    * 整形・ソートした結果を、日時付きディレクトリ内に `all_strategies_summary.csv` という名前で保存します。

---

## 4. 入出力

### 4.1. 入力

* **`strategies.yml`:** テスト対象となる全戦略の定義リスト。
* **`strategy.yml`:** 個別バックテストを実行するための設定雛形。
* **`data/*.csv`:** バックテストに使用する時系列データ。

### 4.2. 出力

* **`all_strategies_results/(日時)/`:** 一回の実行で生成されるすべての結果を格納するルートディレクトリ。
* **`all_strategies_results/(日時)/run_all_strategies_(日時).log`:** 実行ログ。
* **`all_strategies_results/(日時)/strategy_XX_戦略名/`:** 各戦略の個別結果を格納するディレクトリ。
    * `summary.csv`: 個別サマリーレポート
    * `detail.csv`: 銘柄別詳細レポート
    * `trade_history.csv`: 全取引履歴
* **`all_strategies_results/(日時)/all_strategies_summary.csv`:** 全戦略のパフォーマンスをまとめた最終的な統合サマリーレポート。

---

## 5. 実行方法

プロジェクトのルートディレクトリで、以下のコマンドを実行します。

```bash
python run_all_strategies.py
```
