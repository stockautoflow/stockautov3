# **実装計画書：リアルタイム自動トレードシステム**

## **1\. 概要**

本計画書は、詳細設計書に基づき、リアルタイム自動トレードシステムを実装するための具体的な開発ステップを定義する。本計画は4つの主要フェーズに分かれており、各フェーズはシステムのコア機能から運用・監視機能へと段階的に構築していくことを目指す。

## **2\. 開発フェーズとタスク一覧**

### **フェーズ1: 基盤構築とAPI接続 (目標期間: 1〜2週間)**

**目標:** プロジェクトの骨格を作成し、選択した証券会社のAPIと正常に通信できることを確認する。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **1.1** | **プロジェクトセットアップ** | ・realtradeディレクトリと関連ファイル (run\_realtrade.py等) を作成する。 ・config\_realtrade.pyを準備する。 | ・設計書通りのディレクトリ構造が完成している。 |
| **1.2** | **設定管理の実装** | ・config\_realtrade.pyに、環境変数からAPIキーを安全に読み込むロジックを実装する。 | ・.envファイル等にダミーキーを設定し、正常に読み込めることを確認。 |
| **1.3** | **接続モジュールのインターフェース定義** | ・broker\_bridge.pyにBrokerBridge抽象基底クラスを定義する。 ・data\_fetcher.pyにDataFetcher抽象基底クラスを定義する。 | ・各モジュールが実装すべきメソッドのインターフェースがコードとして定義されている。 |
| **1.4** | **API接続の確立 (最重要)** | ・1社に絞り、具体的なSbiBrokerBridge, SbiDataFetcherクラスを作成する。 ・「口座残高の取得」(get\_cash)と\*\*「単一銘柄の現在価格取得」\*\*を実装する。 | ・PythonスクリプトからAPIを呼び出し、実際の口座残高と株価が取得できることを確認。 |

### **フェーズ2: 戦略の動的割り当てとデータフロー検証 (目標期間: 2〜3週間)**

**目標:** リアルタイムデータに基づき、各銘柄に正しい戦略が割り当てられ、売買シグナルが「ログ上」で発生することを確認する（**発注はしない**）。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **2.1** | **状態管理の初期実装** | ・state\_manager.pyとSQLiteデータベースを実装する。 ・positionsテーブルにデータを保存・読み込みできることを確認。 | ・ポジション情報を記録・復元する基本的なStateManagerクラスが完成。 |
| **2.2** | **メインコントローラーの構築** | ・run\_realtrade.pyに戦略カタログ (strategies.yml) と銘柄対応表 (all\_recommend\_\*.csv) を読み込む機能を実装する。 | ・プログラム起動時に、2つの設定ファイルが正しく辞書形式でメモリにロードされる。 |
| **2.3** | **戦略クラスの改修** | ・btrader\_strategy.pyのDynamicStrategyを改修し、\_\_init\_\_内で自身の銘柄に合った戦略パラメータを動的に設定するロジックを実装する。 | ・各銘柄の戦略インスタンスが、自身の銘柄コードと適用すべき戦略名を正しく認識している。 |
| **2.4** | **ドライラン (ログ出力のみ)** | ・注文執行ロジックはコメントアウトした状態でシステム全体を実行する。 ・DataFetcherが全対象銘柄のデータを取得し、DynamicStrategyに渡せているか確認する。 ・売買条件が満たされた際に、「BUYシグナル発生: 銘柄XXXX 戦略名: YYYY」といったログが出力されることを確認する。 | ・実際の取引時間中に、意図したタイミングで売買シグナルがログに出力される。 |

### **フェーズ3: 注文執行と状態の永続化 (目標期間: 2〜3週間)**

**目標:** 実際の口座で（少額で）注文が執行され、システムを再起動してもポジション状態が正しく復元されることを確認する。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **3.1** | **注文執行ロジックの実装** | ・BrokerBridgeに成行注文を実行するplace\_orderメソッドを実装する。 ・注文が約定したら、StateManagerを呼び出してポジション情報をDBに保存する。 | ・ドライランでシグナルが出た銘柄に対し、手動でスクリプトを起動し、実際に注文が約定することを確認。 |
| **3.2** | **ペーパートレード / 少額実弾テスト** | ・リスクを管理できる単一銘柄・少額で、システムを稼働させる。 ・エントリーから決済までの一連の流れが自動で行われることを確認する。 | ・ポジションが自動で構築・決済され、DBに取引履歴が正確に記録される。 |
| **3.3** | **決済注文ロジックの実装** | ・ATR StopTrailなど、設計書に基づいた損切り・利確ロジックを実装する。（APIが対応しない場合、サーバーサイドでの価格監視ロジックが必要） | ・保有ポジションに対し、損切り・利確注文が正しく発注・管理される。 |
| **3.4** | **状態復元機能の実装** | ・run\_realtrade.pyの起動時に、StateManagerから前回のポジションをロードし、BrokerBridge経由で実際の口座状況と照合するロジックを実装する。 | ・ポジション保有中にシステムを再起動しても、再起動後にポジションが正しく認識され、決済注文が再設定される。 |

### **フェーズ4: 堅牢化と運用準備 (目標期間: 1〜2週間)**

**目標:** 長時間安定稼働のためのエラーハンドリングを実装し、運用に必要な監視・管理機能を整える。

| ステップ | タスク名 | 主な作業内容 | 成果物 / 確認項目 |
| :---- | :---- | :---- | :---- |
| **4.1** | **エラーハンドリングと安全装置の実装** | ・設計書に基づき、API接続断、注文拒否、レート制限などの例外処理を実装する。 ・EMERGENCY\_STOP\_THRESHOLD（緊急停止しきい値）の監視ロジックを実装する。 | ・意図的にネットワークを切断する等で、エラー処理が正常に機能することを確認。 |
| **4.2** | **スケジューリング機能の実装** | ・scheduleライブラリ等を使い、取引時間に合わせてシステムの自動起動・停止を行う機能をrun\_realtrade.pyに実装する。 | ・指定した時刻（例: 9:00, 15:05）にシステムが自動で起動・停止する。 |
| **4.3** | **モニタリングUIの拡張** | ・既存のapp.pyを拡張し、realtrade\_state.dbを読み込んで現在のポジション、評価損益、システムログを表示するダッシュボード画面を作成する。 | ・Webブラウザからリアルタイムの稼働状況が一覧で確認できる。 |
| **4.4** | **デプロイ準備** | ・Linuxサーバー等に実行環境を構築する。 ・systemdやsupervisorを使い、システムをサービスとして登録・デーモン化する設定ファイルを作成する。 | ・サーバー上でシステムが永続的に稼働し、OS再起動後も自動で立ち上がる。 |

