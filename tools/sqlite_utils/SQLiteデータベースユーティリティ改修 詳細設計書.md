## **SQLiteデータベースユーティリティ改修 詳細設計書**

### 1\. 概要

本改修は、単一のPythonスクリプトで提供されていた「SQLiteデータベースの参照機能」と「サンプルデータベースの作成機能」を、責務の分離と設定の柔軟性向上を目的として再設計・実装するものである。

具体的には、以下の4点を実現する。

1.  **機能分割**: DB参照機能とサンプルDB作成機能をそれぞれ独立したPythonスクリプトに分割する。
2.  **設定の外部化**: DB参照スクリプトが対象とするデータベースのパスを、スクリプト外部のファイルで管理する。
3.  **YAML形式の採用**: 設定ファイルには、可読性と拡張性に優れたYAML形式を採用する。
4.  **ドキュメント整備**: 利用者が容易にセットアップと利用ができるよう、`README.md`を作成する。

-----

### 2\. プロジェクト構成（案）

改修後のファイル・ディレクトリ構成は以下のようにする。

```
/sqlite_utils/
|
|-- view_db.py              # DB参照機能スクリプト
|-- create_sample_db.py     # サンプルDB作成機能スクリプト
|
|-- config.yml              # データベースパスを定義する設定ファイル
|
|-- requirements.txt        # 外部ライブラリ依存関係ファイル
|
`-- README.md               # 説明書
```

-----

### 3\. 各ファイルの設計詳細

#### 3.1. DBパス定義ファイル (`config.yml`)

  * **役割**: `view_db.py`が参照するSQLiteデータベースのファイルパスを定義する。
  * **形式**: YAML
  * **内容**: `database_path`というキーに対して、データベースファイルのパスを値として記述する。

**【定義例】**

```yaml
# 参照したいSQLiteデータベースのパスを指定してください。
# 例: 'data/main.db', 'C:/Users/YourUser/db/test.sqlite'
database_path: 'realtrade/db/realtrade_state.db'
```

#### 3.2. DB参照スクリプト (`view_db.py`)

  * **役割**: `config.yml`からデータベースパスを読み込み、指定されたデータベース内の全テーブルとデータを表示する。
  * **依存ライブラリ**: `PyYAML` (YAMLファイル読み込みのため), `sqlite3` (標準ライブラリ)
  * **処理フロー**:
    1.  **起動**: スクリプトが実行される。
    2.  **設定ファイル読み込み**: `config.yml`を読み込む。
          * **エラー処理**: `config.yml`が存在しない場合、またはファイル形式が不正な場合は、エラーメッセージを表示して終了する。
    3.  **パス取得**: `database_path`キーからデータベースのパスを取得する。
          * **エラー処理**: `database_path`キーが存在しない場合は、エラーメッセージを表示して終了する。
    4.  **DB接続**: 取得したパスを使用してSQLiteデータベースに接続する。
          * **エラー処理**: データベースファイルが存在しない、または接続に失敗した場合は、エラーメッセージを表示して終了する。
    5.  **データ表示**: 既存のロジック（`display_all_tables_data`関数）を実行し、全テーブル名、カラム名、データをコンソールに出力する。
    6.  **DB切断**: 処理完了後、データベース接続をクローズする。

#### 3.3. サンプルDB作成スクリプト (`create_sample_db.py`)

  * **役割**: 動作確認用のサンプルSQLiteデータベースファイル（`sample_database.db`）を作成する。
  * **依存ライブラリ**: `sqlite3` (標準ライブラリ)
  * **処理フロー**:
    1.  **起動**: スクリプトが実行される。
    2.  **出力ファイル名定義**: 作成するデータベースのファイル名をスクリプト内で定義する（例: `sample_database.db`）。
    3.  **DB作成とデータ挿入**: 既存の`create_sample_database`関数のロジックを実行し、テーブル作成とサンプルデータの挿入を行う。
    4.  **完了メッセージ表示**: 処理が正常に完了したことを示すメッセージをコンソールに出力する。
          * 例: 「サンプルデータベース 'sample\_database.db' を作成しました。」

#### 3.4. 依存関係ファイル (`requirements.txt`)

  * **役割**: プロジェクトが依存する外部Pythonライブラリをリスト化し、`pip`による一括インストールを可能にする。
  * **内容**: `view_db.py`で必要となる`PyYAML`を記述する。

**【定義例】**

```
PyYAML>=6.0
```

#### 3.5. 説明書 (`README.md`)

  * **役割**: このツールの概要、セットアップ方法、使用方法を説明する。
  * **形式**: Markdown
  * **構成案**:
      * **タイトル**: 例「SQLite データベースビューア」
      * **概要**: このツールが何をするためのものかを簡潔に説明。
      * **機能一覧**:
          * `view_db.py`: 設定ファイルに基づきDBの内容を表示する。
          * `create_sample_db.py`: 動作確認用のサンプルDBを作成する。
      * **動作環境**:
          * Python 3.x
      * **インストール方法**:
        1.  リポジトリをクローンまたはファイルをダウンロード。
        2.  依存ライブラリをインストールするコマンドを記載 (`pip install -r requirements.txt`)。
      * **使用方法**:
        1.  **サンプルDBの作成 (任意)**: `python create_sample_db.py` を実行して `sample_database.db` を作成する方法を説明。
        2.  **表示対象DBの設定**: `config.yml` ファイルを開き、`database_path` の値を表示したいDBファイルのパスに書き換えるよう指示。
        3.  **DB内容の表示**: `python view_db.py` を実行する方法を説明。
      * **注意点**: `config.yml`のパスが間違っている場合のエラーについて言及。

-----

### 4\. 実装手順の計画

1.  **フォルダ作成**: 上記「2. プロジェクト構成」に従い、フォルダと空のファイルを作成する。
2.  **`requirements.txt`作成**: `PyYAML>=6.0`と記述する。
3.  **`create_sample_db.py`実装**:
      * 元のスクリプトから`create_sample_database`関数と関連する`import`文をコピーする。
      * `if __name__ == "__main__":`ブロックを追加し、関数を呼び出す処理を記述する。
4.  **`view_db.py`実装**:
      * 元のスクリプトから`display_all_tables_data`関数と関連する`import`文をコピーする。
      * `PyYAML`をインポートし、`config.yml`を読み込んでパスを取得するロジックを`if __name__ == "__main__":`ブロックに実装する。
      * 取得したパスを`display_all_tables_data`関数に渡して実行する。
5.  **`config.yml`作成**: 仕様通りにサンプル内容を記述する。
6.  **`README.md`作成**: 上記「3.5. 説明書」の構成案に基づいて内容を記述する。
7.  **動作テスト**:
      * `pip install -r requirements.txt`が成功することを確認。
      * `create_sample_db.py`を実行し、`sample_database.db`が正しく作成されることを確認。
      * `config.yml`を編集し、`sample_database.db`を参照するように設定。
      * `view_db.py`を実行し、サンプルDBの内容が正しく表示されることを確認。
      * 存在しないパスを指定した場合など、エラー処理が正しく機能することを確認。

-----